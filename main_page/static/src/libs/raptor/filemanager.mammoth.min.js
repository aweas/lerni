/*! VERSION: 0.0.1 *///@extern http://closure-compiler.googlecode.com/svn/trunk/contrib/externs/jquery-1.8.js
                    (function($, window, undefined) {//     Underscore.js 1.4.3
//     http://underscorejs.org
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

(function() {

  // Baseline setup
  // --------------

  // Establish the root object, `window` in the browser, or `global` on the server.
  var root = this;

  // Save the previous value of the `_` variable.
  var previousUnderscore = root._;

  // Establish the object that gets returned to break out of a loop iteration.
  var breaker = {};

  // Save bytes in the minified (but not gzipped) version:
  var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;

  // Create quick reference variables for speed access to core prototypes.
  var push             = ArrayProto.push,
      slice            = ArrayProto.slice,
      concat           = ArrayProto.concat,
      toString         = ObjProto.toString,
      hasOwnProperty   = ObjProto.hasOwnProperty;

  // All **ECMAScript 5** native function implementations that we hope to use
  // are declared here.
  var
    nativeForEach      = ArrayProto.forEach,
    nativeMap          = ArrayProto.map,
    nativeReduce       = ArrayProto.reduce,
    nativeReduceRight  = ArrayProto.reduceRight,
    nativeFilter       = ArrayProto.filter,
    nativeEvery        = ArrayProto.every,
    nativeSome         = ArrayProto.some,
    nativeIndexOf      = ArrayProto.indexOf,
    nativeLastIndexOf  = ArrayProto.lastIndexOf,
    nativeIsArray      = Array.isArray,
    nativeKeys         = Object.keys,
    nativeBind         = FuncProto.bind;

  // Create a safe reference to the Underscore object for use below.
  var _ = function(obj) {
    if (obj instanceof _) return obj;
    if (!(this instanceof _)) return new _(obj);
    this._wrapped = obj;
  };

  // Export the Underscore object for **Node.js**, with
  // backwards-compatibility for the old `require()` API. If we're in
  // the browser, add `_` as a global object via a string identifier,
  // for Closure Compiler "advanced" mode.
  if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) {
      exports = module.exports = _;
    }
    exports._ = _;
  } else {
    root._ = _;
  }

  // Current version.
  _.VERSION = '1.4.3';

  // Collection Functions
  // --------------------

  // The cornerstone, an `each` implementation, aka `forEach`.
  // Handles objects with the built-in `forEach`, arrays, and raw objects.
  // Delegates to **ECMAScript 5**'s native `forEach` if available.
  var each = _.each = _.forEach = function(obj, iterator, context) {
    if (obj == null) return;
    if (nativeForEach && obj.forEach === nativeForEach) {
      obj.forEach(iterator, context);
    } else if (obj.length === +obj.length) {
      for (var i = 0, l = obj.length; i < l; i++) {
        if (iterator.call(context, obj[i], i, obj) === breaker) return;
      }
    } else {
      for (var key in obj) {
        if (_.has(obj, key)) {
          if (iterator.call(context, obj[key], key, obj) === breaker) return;
        }
      }
    }
  };

  // Return the results of applying the iterator to each element.
  // Delegates to **ECMAScript 5**'s native `map` if available.
  _.map = _.collect = function(obj, iterator, context) {
    var results = [];
    if (obj == null) return results;
    if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);
    each(obj, function(value, index, list) {
      results[results.length] = iterator.call(context, value, index, list);
    });
    return results;
  };

  var reduceError = 'Reduce of empty array with no initial value';

  // **Reduce** builds up a single result from a list of values, aka `inject`,
  // or `foldl`. Delegates to **ECMAScript 5**'s native `reduce` if available.
  _.reduce = _.foldl = _.inject = function(obj, iterator, memo, context) {
    var initial = arguments.length > 2;
    if (obj == null) obj = [];
    if (nativeReduce && obj.reduce === nativeReduce) {
      if (context) iterator = _.bind(iterator, context);
      return initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);
    }
    each(obj, function(value, index, list) {
      if (!initial) {
        memo = value;
        initial = true;
      } else {
        memo = iterator.call(context, memo, value, index, list);
      }
    });
    if (!initial) throw new TypeError(reduceError);
    return memo;
  };

  // The right-associative version of reduce, also known as `foldr`.
  // Delegates to **ECMAScript 5**'s native `reduceRight` if available.
  _.reduceRight = _.foldr = function(obj, iterator, memo, context) {
    var initial = arguments.length > 2;
    if (obj == null) obj = [];
    if (nativeReduceRight && obj.reduceRight === nativeReduceRight) {
      if (context) iterator = _.bind(iterator, context);
      return initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);
    }
    var length = obj.length;
    if (length !== +length) {
      var keys = _.keys(obj);
      length = keys.length;
    }
    each(obj, function(value, index, list) {
      index = keys ? keys[--length] : --length;
      if (!initial) {
        memo = obj[index];
        initial = true;
      } else {
        memo = iterator.call(context, memo, obj[index], index, list);
      }
    });
    if (!initial) throw new TypeError(reduceError);
    return memo;
  };

  // Return the first value which passes a truth test. Aliased as `detect`.
  _.find = _.detect = function(obj, iterator, context) {
    var result;
    any(obj, function(value, index, list) {
      if (iterator.call(context, value, index, list)) {
        result = value;
        return true;
      }
    });
    return result;
  };

  // Return all the elements that pass a truth test.
  // Delegates to **ECMAScript 5**'s native `filter` if available.
  // Aliased as `select`.
  _.filter = _.select = function(obj, iterator, context) {
    var results = [];
    if (obj == null) return results;
    if (nativeFilter && obj.filter === nativeFilter) return obj.filter(iterator, context);
    each(obj, function(value, index, list) {
      if (iterator.call(context, value, index, list)) results[results.length] = value;
    });
    return results;
  };

  // Return all the elements for which a truth test fails.
  _.reject = function(obj, iterator, context) {
    return _.filter(obj, function(value, index, list) {
      return !iterator.call(context, value, index, list);
    }, context);
  };

  // Determine whether all of the elements match a truth test.
  // Delegates to **ECMAScript 5**'s native `every` if available.
  // Aliased as `all`.
  _.every = _.all = function(obj, iterator, context) {
    iterator || (iterator = _.identity);
    var result = true;
    if (obj == null) return result;
    if (nativeEvery && obj.every === nativeEvery) return obj.every(iterator, context);
    each(obj, function(value, index, list) {
      if (!(result = result && iterator.call(context, value, index, list))) return breaker;
    });
    return !!result;
  };

  // Determine if at least one element in the object matches a truth test.
  // Delegates to **ECMAScript 5**'s native `some` if available.
  // Aliased as `any`.
  var any = _.some = _.any = function(obj, iterator, context) {
    iterator || (iterator = _.identity);
    var result = false;
    if (obj == null) return result;
    if (nativeSome && obj.some === nativeSome) return obj.some(iterator, context);
    each(obj, function(value, index, list) {
      if (result || (result = iterator.call(context, value, index, list))) return breaker;
    });
    return !!result;
  };

  // Determine if the array or object contains a given value (using `===`).
  // Aliased as `include`.
  _.contains = _.include = function(obj, target) {
    if (obj == null) return false;
    if (nativeIndexOf && obj.indexOf === nativeIndexOf) return obj.indexOf(target) != -1;
    return any(obj, function(value) {
      return value === target;
    });
  };

  // Invoke a method (with arguments) on every item in a collection.
  _.invoke = function(obj, method) {
    var args = slice.call(arguments, 2);
    return _.map(obj, function(value) {
      return (_.isFunction(method) ? method : value[method]).apply(value, args);
    });
  };

  // Convenience version of a common use case of `map`: fetching a property.
  _.pluck = function(obj, key) {
    return _.map(obj, function(value){ return value[key]; });
  };

  // Convenience version of a common use case of `filter`: selecting only objects
  // with specific `key:value` pairs.
  _.where = function(obj, attrs) {
    if (_.isEmpty(attrs)) return [];
    return _.filter(obj, function(value) {
      for (var key in attrs) {
        if (attrs[key] !== value[key]) return false;
      }
      return true;
    });
  };

  // Return the maximum element or (element-based computation).
  // Can't optimize arrays of integers longer than 65,535 elements.
  // See: https://bugs.webkit.org/show_bug.cgi?id=80797
  _.max = function(obj, iterator, context) {
    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
      return Math.max.apply(Math, obj);
    }
    if (!iterator && _.isEmpty(obj)) return -Infinity;
    var result = {computed : -Infinity, value: -Infinity};
    each(obj, function(value, index, list) {
      var computed = iterator ? iterator.call(context, value, index, list) : value;
      computed >= result.computed && (result = {value : value, computed : computed});
    });
    return result.value;
  };

  // Return the minimum element (or element-based computation).
  _.min = function(obj, iterator, context) {
    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {
      return Math.min.apply(Math, obj);
    }
    if (!iterator && _.isEmpty(obj)) return Infinity;
    var result = {computed : Infinity, value: Infinity};
    each(obj, function(value, index, list) {
      var computed = iterator ? iterator.call(context, value, index, list) : value;
      computed < result.computed && (result = {value : value, computed : computed});
    });
    return result.value;
  };

  // Shuffle an array.
  _.shuffle = function(obj) {
    var rand;
    var index = 0;
    var shuffled = [];
    each(obj, function(value) {
      rand = _.random(index++);
      shuffled[index - 1] = shuffled[rand];
      shuffled[rand] = value;
    });
    return shuffled;
  };

  // An internal function to generate lookup iterators.
  var lookupIterator = function(value) {
    return _.isFunction(value) ? value : function(obj){ return obj[value]; };
  };

  // Sort the object's values by a criterion produced by an iterator.
  _.sortBy = function(obj, value, context) {
    var iterator = lookupIterator(value);
    return _.pluck(_.map(obj, function(value, index, list) {
      return {
        value : value,
        index : index,
        criteria : iterator.call(context, value, index, list)
      };
    }).sort(function(left, right) {
      var a = left.criteria;
      var b = right.criteria;
      if (a !== b) {
        if (a > b || a === void 0) return 1;
        if (a < b || b === void 0) return -1;
      }
      return left.index < right.index ? -1 : 1;
    }), 'value');
  };

  // An internal function used for aggregate "group by" operations.
  var group = function(obj, value, context, behavior) {
    var result = {};
    var iterator = lookupIterator(value || _.identity);
    each(obj, function(value, index) {
      var key = iterator.call(context, value, index, obj);
      behavior(result, key, value);
    });
    return result;
  };

  // Groups the object's values by a criterion. Pass either a string attribute
  // to group by, or a function that returns the criterion.
  _.groupBy = function(obj, value, context) {
    return group(obj, value, context, function(result, key, value) {
      (_.has(result, key) ? result[key] : (result[key] = [])).push(value);
    });
  };

  // Counts instances of an object that group by a certain criterion. Pass
  // either a string attribute to count by, or a function that returns the
  // criterion.
  _.countBy = function(obj, value, context) {
    return group(obj, value, context, function(result, key) {
      if (!_.has(result, key)) result[key] = 0;
      result[key]++;
    });
  };

  // Use a comparator function to figure out the smallest index at which
  // an object should be inserted so as to maintain order. Uses binary search.
  _.sortedIndex = function(array, obj, iterator, context) {
    iterator = iterator == null ? _.identity : lookupIterator(iterator);
    var value = iterator.call(context, obj);
    var low = 0, high = array.length;
    while (low < high) {
      var mid = (low + high) >>> 1;
      iterator.call(context, array[mid]) < value ? low = mid + 1 : high = mid;
    }
    return low;
  };

  // Safely convert anything iterable into a real, live array.
  _.toArray = function(obj) {
    if (!obj) return [];
    if (_.isArray(obj)) return slice.call(obj);
    if (obj.length === +obj.length) return _.map(obj, _.identity);
    return _.values(obj);
  };

  // Return the number of elements in an object.
  _.size = function(obj) {
    if (obj == null) return 0;
    return (obj.length === +obj.length) ? obj.length : _.keys(obj).length;
  };

  // Array Functions
  // ---------------

  // Get the first element of an array. Passing **n** will return the first N
  // values in the array. Aliased as `head` and `take`. The **guard** check
  // allows it to work with `_.map`.
  _.first = _.head = _.take = function(array, n, guard) {
    if (array == null) return void 0;
    return (n != null) && !guard ? slice.call(array, 0, n) : array[0];
  };

  // Returns everything but the last entry of the array. Especially useful on
  // the arguments object. Passing **n** will return all the values in
  // the array, excluding the last N. The **guard** check allows it to work with
  // `_.map`.
  _.initial = function(array, n, guard) {
    return slice.call(array, 0, array.length - ((n == null) || guard ? 1 : n));
  };

  // Get the last element of an array. Passing **n** will return the last N
  // values in the array. The **guard** check allows it to work with `_.map`.
  _.last = function(array, n, guard) {
    if (array == null) return void 0;
    if ((n != null) && !guard) {
      return slice.call(array, Math.max(array.length - n, 0));
    } else {
      return array[array.length - 1];
    }
  };

  // Returns everything but the first entry of the array. Aliased as `tail` and `drop`.
  // Especially useful on the arguments object. Passing an **n** will return
  // the rest N values in the array. The **guard**
  // check allows it to work with `_.map`.
  _.rest = _.tail = _.drop = function(array, n, guard) {
    return slice.call(array, (n == null) || guard ? 1 : n);
  };

  // Trim out all falsy values from an array.
  _.compact = function(array) {
    return _.filter(array, _.identity);
  };

  // Internal implementation of a recursive `flatten` function.
  var flatten = function(input, shallow, output) {
    each(input, function(value) {
      if (_.isArray(value)) {
        shallow ? push.apply(output, value) : flatten(value, shallow, output);
      } else {
        output.push(value);
      }
    });
    return output;
  };

  // Return a completely flattened version of an array.
  _.flatten = function(array, shallow) {
    return flatten(array, shallow, []);
  };

  // Return a version of the array that does not contain the specified value(s).
  _.without = function(array) {
    return _.difference(array, slice.call(arguments, 1));
  };

  // Produce a duplicate-free version of the array. If the array has already
  // been sorted, you have the option of using a faster algorithm.
  // Aliased as `unique`.
  _.uniq = _.unique = function(array, isSorted, iterator, context) {
    if (_.isFunction(isSorted)) {
      context = iterator;
      iterator = isSorted;
      isSorted = false;
    }
    var initial = iterator ? _.map(array, iterator, context) : array;
    var results = [];
    var seen = [];
    each(initial, function(value, index) {
      if (isSorted ? (!index || seen[seen.length - 1] !== value) : !_.contains(seen, value)) {
        seen.push(value);
        results.push(array[index]);
      }
    });
    return results;
  };

  // Produce an array that contains the union: each distinct element from all of
  // the passed-in arrays.
  _.union = function() {
    return _.uniq(concat.apply(ArrayProto, arguments));
  };

  // Produce an array that contains every item shared between all the
  // passed-in arrays.
  _.intersection = function(array) {
    var rest = slice.call(arguments, 1);
    return _.filter(_.uniq(array), function(item) {
      return _.every(rest, function(other) {
        return _.indexOf(other, item) >= 0;
      });
    });
  };

  // Take the difference between one array and a number of other arrays.
  // Only the elements present in just the first array will remain.
  _.difference = function(array) {
    var rest = concat.apply(ArrayProto, slice.call(arguments, 1));
    return _.filter(array, function(value){ return !_.contains(rest, value); });
  };

  // Zip together multiple lists into a single array -- elements that share
  // an index go together.
  _.zip = function() {
    var args = slice.call(arguments);
    var length = _.max(_.pluck(args, 'length'));
    var results = new Array(length);
    for (var i = 0; i < length; i++) {
      results[i] = _.pluck(args, "" + i);
    }
    return results;
  };

  // Converts lists into objects. Pass either a single array of `[key, value]`
  // pairs, or two parallel arrays of the same length -- one of keys, and one of
  // the corresponding values.
  _.object = function(list, values) {
    if (list == null) return {};
    var result = {};
    for (var i = 0, l = list.length; i < l; i++) {
      if (values) {
        result[list[i]] = values[i];
      } else {
        result[list[i][0]] = list[i][1];
      }
    }
    return result;
  };

  // If the browser doesn't supply us with indexOf (I'm looking at you, **MSIE**),
  // we need this function. Return the position of the first occurrence of an
  // item in an array, or -1 if the item is not included in the array.
  // Delegates to **ECMAScript 5**'s native `indexOf` if available.
  // If the array is large and already in sort order, pass `true`
  // for **isSorted** to use binary search.
  _.indexOf = function(array, item, isSorted) {
    if (array == null) return -1;
    var i = 0, l = array.length;
    if (isSorted) {
      if (typeof isSorted == 'number') {
        i = (isSorted < 0 ? Math.max(0, l + isSorted) : isSorted);
      } else {
        i = _.sortedIndex(array, item);
        return array[i] === item ? i : -1;
      }
    }
    if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);
    for (; i < l; i++) if (array[i] === item) return i;
    return -1;
  };

  // Delegates to **ECMAScript 5**'s native `lastIndexOf` if available.
  _.lastIndexOf = function(array, item, from) {
    if (array == null) return -1;
    var hasIndex = from != null;
    if (nativeLastIndexOf && array.lastIndexOf === nativeLastIndexOf) {
      return hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);
    }
    var i = (hasIndex ? from : array.length);
    while (i--) if (array[i] === item) return i;
    return -1;
  };

  // Generate an integer Array containing an arithmetic progression. A port of
  // the native Python `range()` function. See
  // [the Python documentation](http://docs.python.org/library/functions.html#range).
  _.range = function(start, stop, step) {
    if (arguments.length <= 1) {
      stop = start || 0;
      start = 0;
    }
    step = arguments[2] || 1;

    var len = Math.max(Math.ceil((stop - start) / step), 0);
    var idx = 0;
    var range = new Array(len);

    while(idx < len) {
      range[idx++] = start;
      start += step;
    }

    return range;
  };

  // Function (ahem) Functions
  // ------------------

  // Reusable constructor function for prototype setting.
  var ctor = function(){};

  // Create a function bound to a given object (assigning `this`, and arguments,
  // optionally). Binding with arguments is also known as `curry`.
  // Delegates to **ECMAScript 5**'s native `Function.bind` if available.
  // We check for `func.bind` first, to fail fast when `func` is undefined.
  _.bind = function(func, context) {
    var args, bound;
    if (func.bind === nativeBind && nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));
    if (!_.isFunction(func)) throw new TypeError;
    args = slice.call(arguments, 2);
    return bound = function() {
      if (!(this instanceof bound)) return func.apply(context, args.concat(slice.call(arguments)));
      ctor.prototype = func.prototype;
      var self = new ctor;
      ctor.prototype = null;
      var result = func.apply(self, args.concat(slice.call(arguments)));
      if (Object(result) === result) return result;
      return self;
    };
  };

  // Bind all of an object's methods to that object. Useful for ensuring that
  // all callbacks defined on an object belong to it.
  _.bindAll = function(obj) {
    var funcs = slice.call(arguments, 1);
    if (funcs.length == 0) funcs = _.functions(obj);
    each(funcs, function(f) { obj[f] = _.bind(obj[f], obj); });
    return obj;
  };

  // Memoize an expensive function by storing its results.
  _.memoize = function(func, hasher) {
    var memo = {};
    hasher || (hasher = _.identity);
    return function() {
      var key = hasher.apply(this, arguments);
      return _.has(memo, key) ? memo[key] : (memo[key] = func.apply(this, arguments));
    };
  };

  // Delays a function for the given number of milliseconds, and then calls
  // it with the arguments supplied.
  _.delay = function(func, wait) {
    var args = slice.call(arguments, 2);
    return setTimeout(function(){ return func.apply(null, args); }, wait);
  };

  // Defers a function, scheduling it to run after the current call stack has
  // cleared.
  _.defer = function(func) {
    return _.delay.apply(_, [func, 1].concat(slice.call(arguments, 1)));
  };

  // Returns a function, that, when invoked, will only be triggered at most once
  // during a given window of time.
  _.throttle = function(func, wait) {
    var context, args, timeout, result;
    var previous = 0;
    var later = function() {
      previous = new Date;
      timeout = null;
      result = func.apply(context, args);
    };
    return function() {
      var now = new Date;
      var remaining = wait - (now - previous);
      context = this;
      args = arguments;
      if (remaining <= 0) {
        clearTimeout(timeout);
        timeout = null;
        previous = now;
        result = func.apply(context, args);
      } else if (!timeout) {
        timeout = setTimeout(later, remaining);
      }
      return result;
    };
  };

  // Returns a function, that, as long as it continues to be invoked, will not
  // be triggered. The function will be called after it stops being called for
  // N milliseconds. If `immediate` is passed, trigger the function on the
  // leading edge, instead of the trailing.
  _.debounce = function(func, wait, immediate) {
    var timeout, result;
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) result = func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) result = func.apply(context, args);
      return result;
    };
  };

  // Returns a function that will be executed at most one time, no matter how
  // often you call it. Useful for lazy initialization.
  _.once = function(func) {
    var ran = false, memo;
    return function() {
      if (ran) return memo;
      ran = true;
      memo = func.apply(this, arguments);
      func = null;
      return memo;
    };
  };

  // Returns the first function passed as an argument to the second,
  // allowing you to adjust arguments, run code before and after, and
  // conditionally execute the original function.
  _.wrap = function(func, wrapper) {
    return function() {
      var args = [func];
      push.apply(args, arguments);
      return wrapper.apply(this, args);
    };
  };

  // Returns a function that is the composition of a list of functions, each
  // consuming the return value of the function that follows.
  _.compose = function() {
    var funcs = arguments;
    return function() {
      var args = arguments;
      for (var i = funcs.length - 1; i >= 0; i--) {
        args = [funcs[i].apply(this, args)];
      }
      return args[0];
    };
  };

  // Returns a function that will only be executed after being called N times.
  _.after = function(times, func) {
    if (times <= 0) return func();
    return function() {
      if (--times < 1) {
        return func.apply(this, arguments);
      }
    };
  };

  // Object Functions
  // ----------------

  // Retrieve the names of an object's properties.
  // Delegates to **ECMAScript 5**'s native `Object.keys`
  _.keys = nativeKeys || function(obj) {
    if (obj !== Object(obj)) throw new TypeError('Invalid object');
    var keys = [];
    for (var key in obj) if (_.has(obj, key)) keys[keys.length] = key;
    return keys;
  };

  // Retrieve the values of an object's properties.
  _.values = function(obj) {
    var values = [];
    for (var key in obj) if (_.has(obj, key)) values.push(obj[key]);
    return values;
  };

  // Convert an object into a list of `[key, value]` pairs.
  _.pairs = function(obj) {
    var pairs = [];
    for (var key in obj) if (_.has(obj, key)) pairs.push([key, obj[key]]);
    return pairs;
  };

  // Invert the keys and values of an object. The values must be serializable.
  _.invert = function(obj) {
    var result = {};
    for (var key in obj) if (_.has(obj, key)) result[obj[key]] = key;
    return result;
  };

  // Return a sorted list of the function names available on the object.
  // Aliased as `methods`
  _.functions = _.methods = function(obj) {
    var names = [];
    for (var key in obj) {
      if (_.isFunction(obj[key])) names.push(key);
    }
    return names.sort();
  };

  // Extend a given object with all the properties in passed-in object(s).
  _.extend = function(obj) {
    each(slice.call(arguments, 1), function(source) {
      if (source) {
        for (var prop in source) {
          obj[prop] = source[prop];
        }
      }
    });
    return obj;
  };

  // Return a copy of the object only containing the whitelisted properties.
  _.pick = function(obj) {
    var copy = {};
    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));
    each(keys, function(key) {
      if (key in obj) copy[key] = obj[key];
    });
    return copy;
  };

   // Return a copy of the object without the blacklisted properties.
  _.omit = function(obj) {
    var copy = {};
    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));
    for (var key in obj) {
      if (!_.contains(keys, key)) copy[key] = obj[key];
    }
    return copy;
  };

  // Fill in a given object with default properties.
  _.defaults = function(obj) {
    each(slice.call(arguments, 1), function(source) {
      if (source) {
        for (var prop in source) {
          if (obj[prop] == null) obj[prop] = source[prop];
        }
      }
    });
    return obj;
  };

  // Create a (shallow-cloned) duplicate of an object.
  _.clone = function(obj) {
    if (!_.isObject(obj)) return obj;
    return _.isArray(obj) ? obj.slice() : _.extend({}, obj);
  };

  // Invokes interceptor with the obj, and then returns obj.
  // The primary purpose of this method is to "tap into" a method chain, in
  // order to perform operations on intermediate results within the chain.
  _.tap = function(obj, interceptor) {
    interceptor(obj);
    return obj;
  };

  // Internal recursive comparison function for `isEqual`.
  var eq = function(a, b, aStack, bStack) {
    // Identical objects are equal. `0 === -0`, but they aren't identical.
    // See the Harmony `egal` proposal: http://wiki.ecmascript.org/doku.php?id=harmony:egal.
    if (a === b) return a !== 0 || 1 / a == 1 / b;
    // A strict comparison is necessary because `null == undefined`.
    if (a == null || b == null) return a === b;
    // Unwrap any wrapped objects.
    if (a instanceof _) a = a._wrapped;
    if (b instanceof _) b = b._wrapped;
    // Compare `[[Class]]` names.
    var className = toString.call(a);
    if (className != toString.call(b)) return false;
    switch (className) {
      // Strings, numbers, dates, and booleans are compared by value.
      case '[object String]':
        // Primitives and their corresponding object wrappers are equivalent; thus, `"5"` is
        // equivalent to `new String("5")`.
        return a == String(b);
      case '[object Number]':
        // `NaN`s are equivalent, but non-reflexive. An `egal` comparison is performed for
        // other numeric values.
        return a != +a ? b != +b : (a == 0 ? 1 / a == 1 / b : a == +b);
      case '[object Date]':
      case '[object Boolean]':
        // Coerce dates and booleans to numeric primitive values. Dates are compared by their
        // millisecond representations. Note that invalid dates with millisecond representations
        // of `NaN` are not equivalent.
        return +a == +b;
      // RegExps are compared by their source patterns and flags.
      case '[object RegExp]':
        return a.source == b.source &&
               a.global == b.global &&
               a.multiline == b.multiline &&
               a.ignoreCase == b.ignoreCase;
    }
    if (typeof a != 'object' || typeof b != 'object') return false;
    // Assume equality for cyclic structures. The algorithm for detecting cyclic
    // structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.
    var length = aStack.length;
    while (length--) {
      // Linear search. Performance is inversely proportional to the number of
      // unique nested structures.
      if (aStack[length] == a) return bStack[length] == b;
    }
    // Add the first object to the stack of traversed objects.
    aStack.push(a);
    bStack.push(b);
    var size = 0, result = true;
    // Recursively compare objects and arrays.
    if (className == '[object Array]') {
      // Compare array lengths to determine if a deep comparison is necessary.
      size = a.length;
      result = size == b.length;
      if (result) {
        // Deep compare the contents, ignoring non-numeric properties.
        while (size--) {
          if (!(result = eq(a[size], b[size], aStack, bStack))) break;
        }
      }
    } else {
      // Objects with different constructors are not equivalent, but `Object`s
      // from different frames are.
      var aCtor = a.constructor, bCtor = b.constructor;
      if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) &&
                               _.isFunction(bCtor) && (bCtor instanceof bCtor))) {
        return false;
      }
      // Deep compare objects.
      for (var key in a) {
        if (_.has(a, key)) {
          // Count the expected number of properties.
          size++;
          // Deep compare each member.
          if (!(result = _.has(b, key) && eq(a[key], b[key], aStack, bStack))) break;
        }
      }
      // Ensure that both objects contain the same number of properties.
      if (result) {
        for (key in b) {
          if (_.has(b, key) && !(size--)) break;
        }
        result = !size;
      }
    }
    // Remove the first object from the stack of traversed objects.
    aStack.pop();
    bStack.pop();
    return result;
  };

  // Perform a deep comparison to check if two objects are equal.
  _.isEqual = function(a, b) {
    return eq(a, b, [], []);
  };

  // Is a given array, string, or object empty?
  // An "empty" object has no enumerable own-properties.
  _.isEmpty = function(obj) {
    if (obj == null) return true;
    if (_.isArray(obj) || _.isString(obj)) return obj.length === 0;
    for (var key in obj) if (_.has(obj, key)) return false;
    return true;
  };

  // Is a given value a DOM element?
  _.isElement = function(obj) {
    return !!(obj && obj.nodeType === 1);
  };

  // Is a given value an array?
  // Delegates to ECMA5's native Array.isArray
  _.isArray = nativeIsArray || function(obj) {
    return toString.call(obj) == '[object Array]';
  };

  // Is a given variable an object?
  _.isObject = function(obj) {
    return obj === Object(obj);
  };

  // Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.
  each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp'], function(name) {
    _['is' + name] = function(obj) {
      return toString.call(obj) == '[object ' + name + ']';
    };
  });

  // Define a fallback version of the method in browsers (ahem, IE), where
  // there isn't any inspectable "Arguments" type.
  if (!_.isArguments(arguments)) {
    _.isArguments = function(obj) {
      return !!(obj && _.has(obj, 'callee'));
    };
  }

  // Optimize `isFunction` if appropriate.
  if (typeof (/./) !== 'function') {
    _.isFunction = function(obj) {
      return typeof obj === 'function';
    };
  }

  // Is a given object a finite number?
  _.isFinite = function(obj) {
    return isFinite(obj) && !isNaN(parseFloat(obj));
  };

  // Is the given value `NaN`? (NaN is the only number which does not equal itself).
  _.isNaN = function(obj) {
    return _.isNumber(obj) && obj != +obj;
  };

  // Is a given value a boolean?
  _.isBoolean = function(obj) {
    return obj === true || obj === false || toString.call(obj) == '[object Boolean]';
  };

  // Is a given value equal to null?
  _.isNull = function(obj) {
    return obj === null;
  };

  // Is a given variable undefined?
  _.isUndefined = function(obj) {
    return obj === void 0;
  };

  // Shortcut function for checking if an object has a given property directly
  // on itself (in other words, not on a prototype).
  _.has = function(obj, key) {
    return hasOwnProperty.call(obj, key);
  };

  // Utility Functions
  // -----------------

  // Run Underscore.js in *noConflict* mode, returning the `_` variable to its
  // previous owner. Returns a reference to the Underscore object.
  _.noConflict = function() {
    root._ = previousUnderscore;
    return this;
  };

  // Keep the identity function around for default iterators.
  _.identity = function(value) {
    return value;
  };

  // Run a function **n** times.
  _.times = function(n, iterator, context) {
    var accum = Array(n);
    for (var i = 0; i < n; i++) accum[i] = iterator.call(context, i);
    return accum;
  };

  // Return a random integer between min and max (inclusive).
  _.random = function(min, max) {
    if (max == null) {
      max = min;
      min = 0;
    }
    return min + (0 | Math.random() * (max - min + 1));
  };

  // List of HTML entities for escaping.
  var entityMap = {
    escape: {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    }
  };
  entityMap.unescape = _.invert(entityMap.escape);

  // Regexes containing the keys and values listed immediately above.
  var entityRegexes = {
    escape:   new RegExp('[' + _.keys(entityMap.escape).join('') + ']', 'g'),
    unescape: new RegExp('(' + _.keys(entityMap.unescape).join('|') + ')', 'g')
  };

  // Functions for escaping and unescaping strings to/from HTML interpolation.
  _.each(['escape', 'unescape'], function(method) {
    _[method] = function(string) {
      if (string == null) return '';
      return ('' + string).replace(entityRegexes[method], function(match) {
        return entityMap[method][match];
      });
    };
  });

  // If the value of the named property is a function then invoke it;
  // otherwise, return it.
  _.result = function(object, property) {
    if (object == null) return null;
    var value = object[property];
    return _.isFunction(value) ? value.call(object) : value;
  };

  // Add your own custom functions to the Underscore object.
  _.mixin = function(obj) {
    each(_.functions(obj), function(name){
      var func = _[name] = obj[name];
      _.prototype[name] = function() {
        var args = [this._wrapped];
        push.apply(args, arguments);
        return result.call(this, func.apply(_, args));
      };
    });
  };

  // Generate a unique integer id (unique within the entire client session).
  // Useful for temporary DOM ids.
  var idCounter = 0;
  _.uniqueId = function(prefix) {
    var id = '' + ++idCounter;
    return prefix ? prefix + id : id;
  };

  // By default, Underscore uses ERB-style template delimiters, change the
  // following template settings to use alternative delimiters.
  _.templateSettings = {
    evaluate    : /<%([\s\S]+?)%>/g,
    interpolate : /<%=([\s\S]+?)%>/g,
    escape      : /<%-([\s\S]+?)%>/g
  };

  // When customizing `templateSettings`, if you don't want to define an
  // interpolation, evaluation or escaping regex, we need one that is
  // guaranteed not to match.
  var noMatch = /(.)^/;

  // Certain characters need to be escaped so that they can be put into a
  // string literal.
  var escapes = {
    "'":      "'",
    '\\':     '\\',
    '\r':     'r',
    '\n':     'n',
    '\t':     't',
    '\u2028': 'u2028',
    '\u2029': 'u2029'
  };

  var escaper = /\\|'|\r|\n|\t|\u2028|\u2029/g;

  // JavaScript micro-templating, similar to John Resig's implementation.
  // Underscore templating handles arbitrary delimiters, preserves whitespace,
  // and correctly escapes quotes within interpolated code.
  _.template = function(text, data, settings) {
    settings = _.defaults({}, settings, _.templateSettings);

    // Combine delimiters into one regular expression via alternation.
    var matcher = new RegExp([
      (settings.escape || noMatch).source,
      (settings.interpolate || noMatch).source,
      (settings.evaluate || noMatch).source
    ].join('|') + '|$', 'g');

    // Compile the template source, escaping string literals appropriately.
    var index = 0;
    var source = "__p+='";
    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
      source += text.slice(index, offset)
        .replace(escaper, function(match) { return '\\' + escapes[match]; });

      if (escape) {
        source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
      }
      if (interpolate) {
        source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
      }
      if (evaluate) {
        source += "';\n" + evaluate + "\n__p+='";
      }
      index = offset + match.length;
      return match;
    });
    source += "';\n";

    // If a variable is not specified, place data values in local scope.
    if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';

    source = "var __t,__p='',__j=Array.prototype.join," +
      "print=function(){__p+=__j.call(arguments,'');};\n" +
      source + "return __p;\n";

    try {
      var render = new Function(settings.variable || 'obj', '_', source);
    } catch (e) {
      e.source = source;
      throw e;
    }

    if (data) return render(data, _);
    var template = function(data) {
      return render.call(this, data, _);
    };

    // Provide the compiled function source as a convenience for precompilation.
    template.source = 'function(' + (settings.variable || 'obj') + '){\n' + source + '}';

    return template;
  };

  // Add a "chain" function, which will delegate to the wrapper.
  _.chain = function(obj) {
    return _(obj).chain();
  };

  // OOP
  // ---------------
  // If Underscore is called as a function, it returns a wrapped object that
  // can be used OO-style. This wrapper holds altered versions of all the
  // underscore functions. Wrapped objects may be chained.

  // Helper function to continue chaining intermediate results.
  var result = function(obj) {
    return this._chain ? _(obj).chain() : obj;
  };

  // Add all of the Underscore functions to the wrapper object.
  _.mixin(_);

  // Add all mutator Array functions to the wrapper.
  each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      var obj = this._wrapped;
      method.apply(obj, arguments);
      if ((name == 'shift' || name == 'splice') && obj.length === 0) delete obj[0];
      return result.call(this, obj);
    };
  });

  // Add all accessor Array functions to the wrapper.
  each(['concat', 'join', 'slice'], function(name) {
    var method = ArrayProto[name];
    _.prototype[name] = function() {
      return result.call(this, method.apply(this._wrapped, arguments));
    };
  });

  _.extend(_.prototype, {

    // Start chaining a wrapped Underscore object.
    chain: function() {
      this._chain = true;
      return this;
    },

    // Extracts the result from a wrapped and chained object.
    value: function() {
      return this._wrapped;
    }

  });

}).call(this);
//     Backbone.js 0.9.2

//     (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

(function(){

  // Initial Setup
  // -------------

  // Save a reference to the global object (`window` in the browser, `global`
  // on the server).
  var root = this;

  // Save the previous value of the `Backbone` variable, so that it can be
  // restored later on, if `noConflict` is used.
  var previousBackbone = root.Backbone;

  // Create a local reference to slice/splice.
  var slice = Array.prototype.slice;
  var splice = Array.prototype.splice;

  // The top-level namespace. All public Backbone classes and modules will
  // be attached to this. Exported for both CommonJS and the browser.
  var Backbone;
  if (typeof exports !== 'undefined') {
    Backbone = exports;
  } else {
    Backbone = root.Backbone = {};
  }

  // Current version of the library. Keep in sync with `package.json`.
  Backbone.VERSION = '0.9.2';

  // Require Underscore, if we're on the server, and it's not already present.
  var _ = root._;
  if (!_ && (typeof require !== 'undefined')) _ = require('underscore');

  // For Backbone's purposes, jQuery, Zepto, or Ender owns the `$` variable.
  var $ = root.jQuery || root.Zepto || root.ender;

  // Set the JavaScript library that will be used for DOM manipulation and
  // Ajax calls (a.k.a. the `$` variable). By default Backbone will use: jQuery,
  // Zepto, or Ender; but the `setDomLibrary()` method lets you inject an
  // alternate JavaScript library (or a mock library for testing your views
  // outside of a browser).
  Backbone.setDomLibrary = function(lib) {
    $ = lib;
  };

  // Runs Backbone.js in *noConflict* mode, returning the `Backbone` variable
  // to its previous owner. Returns a reference to this Backbone object.
  Backbone.noConflict = function() {
    root.Backbone = previousBackbone;
    return this;
  };

  // Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option
  // will fake `"PUT"` and `"DELETE"` requests via the `_method` parameter and
  // set a `X-Http-Method-Override` header.
  Backbone.emulateHTTP = false;

  // Turn on `emulateJSON` to support legacy servers that can't deal with direct
  // `application/json` requests ... will encode the body as
  // `application/x-www-form-urlencoded` instead and will send the model in a
  // form param named `model`.
  Backbone.emulateJSON = false;

  // Backbone.Events
  // -----------------

  // Regular expression used to split event strings
  var eventSplitter = /\s+/;

  // A module that can be mixed in to *any object* in order to provide it with
  // custom events. You may bind with `on` or remove with `off` callback functions
  // to an event; trigger`-ing an event fires all callbacks in succession.
  //
  //     var object = {};
  //     _.extend(object, Backbone.Events);
  //     object.on('expand', function(){ alert('expanded'); });
  //     object.trigger('expand');
  //
  var Events = Backbone.Events = {

    // Bind one or more space separated events, `events`, to a `callback`
    // function. Passing `"all"` will bind the callback to all events fired.
    on: function(events, callback, context) {

      var calls, event, node, tail, list;
      if (!callback) return this;
      events = events.split(eventSplitter);
      calls = this._callbacks || (this._callbacks = {});

      // Create an immutable callback list, allowing traversal during
      // modification.  The tail is an empty object that will always be used
      // as the next node.
      while (event = events.shift()) {
        list = calls[event];
        node = list ? list.tail : {};
        node.next = tail = {};
        node.context = context;
        node.callback = callback;
        calls[event] = {tail: tail, next: list ? list.next : node};
      }

      return this;
    },

    // Remove one or many callbacks. If `context` is null, removes all callbacks
    // with that function. If `callback` is null, removes all callbacks for the
    // event. If `events` is null, removes all bound callbacks for all events.
    off: function(events, callback, context) {
      var event, calls, node, tail, cb, ctx;

      // No events, or removing *all* events.
      if (!(calls = this._callbacks)) return;
      if (!(events || callback || context)) {
        delete this._callbacks;
        return this;
      }

      // Loop through the listed events and contexts, splicing them out of the
      // linked list of callbacks if appropriate.
      events = events ? events.split(eventSplitter) : _.keys(calls);
      while (event = events.shift()) {
        node = calls[event];
        delete calls[event];
        if (!node || !(callback || context)) continue;
        // Create a new list, omitting the indicated callbacks.
        tail = node.tail;
        while ((node = node.next) !== tail) {
          cb = node.callback;
          ctx = node.context;
          if ((callback && cb !== callback) || (context && ctx !== context)) {
            this.on(event, cb, ctx);
          }
        }
      }

      return this;
    },

    // Trigger one or many events, firing all bound callbacks. Callbacks are
    // passed the same arguments as `trigger` is, apart from the event name
    // (unless you're listening on `"all"`, which will cause your callback to
    // receive the true name of the event as the first argument).
    trigger: function(events) {
      var event, node, calls, tail, args, all, rest;
      if (!(calls = this._callbacks)) return this;
      all = calls.all;
      events = events.split(eventSplitter);
      rest = slice.call(arguments, 1);

      // For each event, walk through the linked list of callbacks twice,
      // first to trigger the event, then to trigger any `"all"` callbacks.
      while (event = events.shift()) {
        if (node = calls[event]) {
          tail = node.tail;
          while ((node = node.next) !== tail) {
            node.callback.apply(node.context || this, rest);
          }
        }
        if (node = all) {
          tail = node.tail;
          args = [event].concat(rest);
          while ((node = node.next) !== tail) {
            node.callback.apply(node.context || this, args);
          }
        }
      }

      return this;
    }

  };

  // Aliases for backwards compatibility.
  Events.bind   = Events.on;
  Events.unbind = Events.off;

  // Backbone.Model
  // --------------

  // Create a new model, with defined attributes. A client id (`cid`)
  // is automatically generated and assigned for you.
  var Model = Backbone.Model = function(attributes, options) {
    var defaults;
    attributes || (attributes = {});
    if (options && options.parse) attributes = this.parse(attributes);
    if (defaults = getValue(this, 'defaults')) {
      attributes = _.extend({}, defaults, attributes);
    }
    if (options && options.collection) this.collection = options.collection;
    this.attributes = {};
    this._escapedAttributes = {};
    this.cid = _.uniqueId('c');
    this.changed = {};
    this._silent = {};
    this._pending = {};
    this.set(attributes, {silent: true});
    // Reset change tracking.
    this.changed = {};
    this._silent = {};
    this._pending = {};
    this._previousAttributes = _.clone(this.attributes);
    this.initialize.apply(this, arguments);
  };

  // Attach all inheritable methods to the Model prototype.
  _.extend(Model.prototype, Events, {

    // A hash of attributes whose current and previous value differ.
    changed: null,

    // A hash of attributes that have silently changed since the last time
    // `change` was called.  Will become pending attributes on the next call.
    _silent: null,

    // A hash of attributes that have changed since the last `'change'` event
    // began.
    _pending: null,

    // The default name for the JSON `id` attribute is `"id"`. MongoDB and
    // CouchDB users may want to set this to `"_id"`.
    idAttribute: 'id',

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Return a copy of the model's `attributes` object.
    toJSON: function(options) {
      return _.clone(this.attributes);
    },

    // Get the value of an attribute.
    get: function(attr) {
      return this.attributes[attr];
    },

    // Get the HTML-escaped value of an attribute.
    escape: function(attr) {
      var html;
      if (html = this._escapedAttributes[attr]) return html;
      var val = this.get(attr);
      return this._escapedAttributes[attr] = _.escape(val == null ? '' : '' + val);
    },

    // Returns `true` if the attribute contains a value that is not null
    // or undefined.
    has: function(attr) {
      return this.get(attr) != null;
    },

    // Set a hash of model attributes on the object, firing `"change"` unless
    // you choose to silence it.
    set: function(key, value, options) {
      var attrs, attr, val;

      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (_.isObject(key) || key == null) {
        attrs = key;
        options = value;
      } else {
        attrs = {};
        attrs[key] = value;
      }

      // Extract attributes and options.
      options || (options = {});
      if (!attrs) return this;
      if (attrs instanceof Model) attrs = attrs.attributes;
      if (options.unset) for (attr in attrs) attrs[attr] = void 0;

      // Run validation.
      if (!this._validate(attrs, options)) return false;

      // Check for changes of `id`.
      if (this.idAttribute in attrs) this.id = attrs[this.idAttribute];

      var changes = options.changes = {};
      var now = this.attributes;
      var escaped = this._escapedAttributes;
      var prev = this._previousAttributes || {};

      // For each `set` attribute...
      for (attr in attrs) {
        val = attrs[attr];

        // If the new and current value differ, record the change.
        if (!_.isEqual(now[attr], val) || (options.unset && _.has(now, attr))) {
          delete escaped[attr];
          (options.silent ? this._silent : changes)[attr] = true;
        }

        // Update or delete the current value.
        options.unset ? delete now[attr] : now[attr] = val;

        // If the new and previous value differ, record the change.  If not,
        // then remove changes for this attribute.
        if (!_.isEqual(prev[attr], val) || (_.has(now, attr) != _.has(prev, attr))) {
          this.changed[attr] = val;
          if (!options.silent) this._pending[attr] = true;
        } else {
          delete this.changed[attr];
          delete this._pending[attr];
        }
      }

      // Fire the `"change"` events.
      if (!options.silent) this.change(options);
      return this;
    },

    // Remove an attribute from the model, firing `"change"` unless you choose
    // to silence it. `unset` is a noop if the attribute doesn't exist.
    unset: function(attr, options) {
      (options || (options = {})).unset = true;
      return this.set(attr, null, options);
    },

    // Clear all attributes on the model, firing `"change"` unless you choose
    // to silence it.
    clear: function(options) {
      (options || (options = {})).unset = true;
      return this.set(_.clone(this.attributes), options);
    },

    // Fetch the model from the server. If the server's representation of the
    // model differs from its current attributes, they will be overriden,
    // triggering a `"change"` event.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      var model = this;
      var success = options.success;
      options.success = function(resp, status, xhr) {
        if (!model.set(model.parse(resp, xhr), options)) return false;
        if (success) success(model, resp);
      };
      options.error = Backbone.wrapError(options.error, model, options);
      return (this.sync || Backbone.sync).call(this, 'read', this, options);
    },

    // Set a hash of model attributes, and sync the model to the server.
    // If the server returns an attributes hash that differs, the model's
    // state will be `set` again.
    save: function(key, value, options) {
      var attrs, current;

      // Handle both `("key", value)` and `({key: value})` -style calls.
      if (_.isObject(key) || key == null) {
        attrs = key;
        options = value;
      } else {
        attrs = {};
        attrs[key] = value;
      }
      options = options ? _.clone(options) : {};

      // If we're "wait"-ing to set changed attributes, validate early.
      if (options.wait) {
        if (!this._validate(attrs, options)) return false;
        current = _.clone(this.attributes);
      }

      // Regular saves `set` attributes before persisting to the server.
      var silentOptions = _.extend({}, options, {silent: true});
      if (attrs && !this.set(attrs, options.wait ? silentOptions : options)) {
        return false;
      }

      // After a successful server-side save, the client is (optionally)
      // updated with the server-side state.
      var model = this;
      var success = options.success;
      options.success = function(resp, status, xhr) {
        var serverAttrs = model.parse(resp, xhr);
        if (options.wait) {
          delete options.wait;
          serverAttrs = _.extend(attrs || {}, serverAttrs);
        }
        if (!model.set(serverAttrs, options)) return false;
        if (success) {
          success(model, resp);
        } else {
          model.trigger('sync', model, resp, options);
        }
      };

      // Finish configuring and sending the Ajax request.
      options.error = Backbone.wrapError(options.error, model, options);
      var method = this.isNew() ? 'create' : 'update';
      var xhr = (this.sync || Backbone.sync).call(this, method, this, options);
      if (options.wait) this.set(current, silentOptions);
      return xhr;
    },

    // Destroy this model on the server if it was already persisted.
    // Optimistically removes the model from its collection, if it has one.
    // If `wait: true` is passed, waits for the server to respond before removal.
    destroy: function(options) {
      options = options ? _.clone(options) : {};
      var model = this;
      var success = options.success;

      var triggerDestroy = function() {
        model.trigger('destroy', model, model.collection, options);
      };

      if (this.isNew()) {
        triggerDestroy();
        return false;
      }

      options.success = function(resp) {
        if (options.wait) triggerDestroy();
        if (success) {
          success(model, resp);
        } else {
          model.trigger('sync', model, resp, options);
        }
      };

      options.error = Backbone.wrapError(options.error, model, options);
      var xhr = (this.sync || Backbone.sync).call(this, 'delete', this, options);
      if (!options.wait) triggerDestroy();
      return xhr;
    },

    // Default URL for the model's representation on the server -- if you're
    // using Backbone's restful methods, override this to change the endpoint
    // that will be called.
    url: function() {
      var base = getValue(this, 'urlRoot') || getValue(this.collection, 'url') || urlError();
      if (this.isNew()) return base;
      return base + (base.charAt(base.length - 1) == '/' ? '' : '/') + encodeURIComponent(this.id);
    },

    // **parse** converts a response into the hash of attributes to be `set` on
    // the model. The default implementation is just to pass the response along.
    parse: function(resp, xhr) {
      return resp;
    },

    // Create a new model with identical attributes to this one.
    clone: function() {
      return new this.constructor(this.attributes);
    },

    // A model is new if it has never been saved to the server, and lacks an id.
    isNew: function() {
      return this.id == null;
    },

    // Call this method to manually fire a `"change"` event for this model and
    // a `"change:attribute"` event for each changed attribute.
    // Calling this will cause all objects observing the model to update.
    change: function(options) {
      options || (options = {});
      var changing = this._changing;
      this._changing = true;

      // Silent changes become pending changes.
      for (var attr in this._silent) this._pending[attr] = true;

      // Silent changes are triggered.
      var changes = _.extend({}, options.changes, this._silent);
      this._silent = {};
      for (var attr in changes) {
        this.trigger('change:' + attr, this, this.get(attr), options);
      }
      if (changing) return this;

      // Continue firing `"change"` events while there are pending changes.
      while (!_.isEmpty(this._pending)) {
        this._pending = {};
        this.trigger('change', this, options);
        // Pending and silent changes still remain.
        for (var attr in this.changed) {
          if (this._pending[attr] || this._silent[attr]) continue;
          delete this.changed[attr];
        }
        this._previousAttributes = _.clone(this.attributes);
      }

      this._changing = false;
      return this;
    },

    // Determine if the model has changed since the last `"change"` event.
    // If you specify an attribute name, determine if that attribute has changed.
    hasChanged: function(attr) {
      if (!arguments.length) return !_.isEmpty(this.changed);
      return _.has(this.changed, attr);
    },

    // Return an object containing all the attributes that have changed, or
    // false if there are no changed attributes. Useful for determining what
    // parts of a view need to be updated and/or what attributes need to be
    // persisted to the server. Unset attributes will be set to undefined.
    // You can also pass an attributes object to diff against the model,
    // determining if there *would be* a change.
    changedAttributes: function(diff) {
      if (!diff) return this.hasChanged() ? _.clone(this.changed) : false;
      var val, changed = false, old = this._previousAttributes;
      for (var attr in diff) {
        if (_.isEqual(old[attr], (val = diff[attr]))) continue;
        (changed || (changed = {}))[attr] = val;
      }
      return changed;
    },

    // Get the previous value of an attribute, recorded at the time the last
    // `"change"` event was fired.
    previous: function(attr) {
      if (!arguments.length || !this._previousAttributes) return null;
      return this._previousAttributes[attr];
    },

    // Get all of the attributes of the model at the time of the previous
    // `"change"` event.
    previousAttributes: function() {
      return _.clone(this._previousAttributes);
    },

    // Check if the model is currently in a valid state. It's only possible to
    // get into an *invalid* state if you're using silent changes.
    isValid: function() {
      return !this.validate(this.attributes);
    },

    // Run validation against the next complete set of model attributes,
    // returning `true` if all is well. If a specific `error` callback has
    // been passed, call that instead of firing the general `"error"` event.
    _validate: function(attrs, options) {
      if (options.silent || !this.validate) return true;
      attrs = _.extend({}, this.attributes, attrs);
      var error = this.validate(attrs, options);
      if (!error) return true;
      if (options && options.error) {
        options.error(this, error, options);
      } else {
        this.trigger('error', this, error, options);
      }
      return false;
    }

  });

  // Backbone.Collection
  // -------------------

  // Provides a standard collection class for our sets of models, ordered
  // or unordered. If a `comparator` is specified, the Collection will maintain
  // its models in sort order, as they're added and removed.
  var Collection = Backbone.Collection = function(models, options) {
    options || (options = {});
    if (options.model) this.model = options.model;
    if (options.comparator) this.comparator = options.comparator;
    this._reset();
    this.initialize.apply(this, arguments);
    if (models) this.reset(models, {silent: true, parse: options.parse});
  };

  // Define the Collection's inheritable methods.
  _.extend(Collection.prototype, Events, {

    // The default model for a collection is just a **Backbone.Model**.
    // This should be overridden in most cases.
    model: Model,

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // The JSON representation of a Collection is an array of the
    // models' attributes.
    toJSON: function(options) {
      return this.map(function(model){ return model.toJSON(options); });
    },

    // Add a model, or list of models to the set. Pass **silent** to avoid
    // firing the `add` event for every new model.
    add: function(models, options) {
      var i, index, length, model, cid, id, cids = {}, ids = {}, dups = [];
      options || (options = {});
      models = _.isArray(models) ? models.slice() : [models];

      // Begin by turning bare objects into model references, and preventing
      // invalid models or duplicate models from being added.
      for (i = 0, length = models.length; i < length; i++) {
        if (!(model = models[i] = this._prepareModel(models[i], options))) {
          throw new Error("Can't add an invalid model to a collection");
        }
        cid = model.cid;
        id = model.id;
        if (cids[cid] || this._byCid[cid] || ((id != null) && (ids[id] || this._byId[id]))) {
          dups.push(i);
          continue;
        }
        cids[cid] = ids[id] = model;
      }

      // Remove duplicates.
      i = dups.length;
      while (i--) {
        models.splice(dups[i], 1);
      }

      // Listen to added models' events, and index models for lookup by
      // `id` and by `cid`.
      for (i = 0, length = models.length; i < length; i++) {
        (model = models[i]).on('all', this._onModelEvent, this);
        this._byCid[model.cid] = model;
        if (model.id != null) this._byId[model.id] = model;
      }

      // Insert models into the collection, re-sorting if needed, and triggering
      // `add` events unless silenced.
      this.length += length;
      index = options.at != null ? options.at : this.models.length;
      splice.apply(this.models, [index, 0].concat(models));
      if (this.comparator) this.sort({silent: true});
      if (options.silent) return this;
      for (i = 0, length = this.models.length; i < length; i++) {
        if (!cids[(model = this.models[i]).cid]) continue;
        options.index = i;
        model.trigger('add', model, this, options);
      }
      return this;
    },

    // Remove a model, or a list of models from the set. Pass silent to avoid
    // firing the `remove` event for every model removed.
    remove: function(models, options) {
      var i, l, index, model;
      options || (options = {});
      models = _.isArray(models) ? models.slice() : [models];
      for (i = 0, l = models.length; i < l; i++) {
        model = this.getByCid(models[i]) || this.get(models[i]);
        if (!model) continue;
        delete this._byId[model.id];
        delete this._byCid[model.cid];
        index = this.indexOf(model);
        this.models.splice(index, 1);
        this.length--;
        if (!options.silent) {
          options.index = index;
          model.trigger('remove', model, this, options);
        }
        this._removeReference(model);
      }
      return this;
    },

    // Add a model to the end of the collection.
    push: function(model, options) {
      model = this._prepareModel(model, options);
      this.add(model, options);
      return model;
    },

    // Remove a model from the end of the collection.
    pop: function(options) {
      var model = this.at(this.length - 1);
      this.remove(model, options);
      return model;
    },

    // Add a model to the beginning of the collection.
    unshift: function(model, options) {
      model = this._prepareModel(model, options);
      this.add(model, _.extend({at: 0}, options));
      return model;
    },

    // Remove a model from the beginning of the collection.
    shift: function(options) {
      var model = this.at(0);
      this.remove(model, options);
      return model;
    },

    // Get a model from the set by id.
    get: function(id) {
      if (id == null) return void 0;
      return this._byId[id.id != null ? id.id : id];
    },

    // Get a model from the set by client id.
    getByCid: function(cid) {
      return cid && this._byCid[cid.cid || cid];
    },

    // Get the model at the given index.
    at: function(index) {
      return this.models[index];
    },

    // Return models with matching attributes. Useful for simple cases of `filter`.
    where: function(attrs) {
      if (_.isEmpty(attrs)) return [];
      return this.filter(function(model) {
        for (var key in attrs) {
          if (attrs[key] !== model.get(key)) return false;
        }
        return true;
      });
    },

    // Force the collection to re-sort itself. You don't need to call this under
    // normal circumstances, as the set will maintain sort order as each item
    // is added.
    sort: function(options) {
      options || (options = {});
      if (!this.comparator) throw new Error('Cannot sort a set without a comparator');
      var boundComparator = _.bind(this.comparator, this);
      if (this.comparator.length == 1) {
        this.models = this.sortBy(boundComparator);
      } else {
        this.models.sort(boundComparator);
      }
      if (!options.silent) this.trigger('reset', this, options);
      return this;
    },

    // Pluck an attribute from each model in the collection.
    pluck: function(attr) {
      return _.map(this.models, function(model){ return model.get(attr); });
    },

    // When you have more items than you want to add or remove individually,
    // you can reset the entire set with a new list of models, without firing
    // any `add` or `remove` events. Fires `reset` when finished.
    reset: function(models, options) {
      models  || (models = []);
      options || (options = {});
      for (var i = 0, l = this.models.length; i < l; i++) {
        this._removeReference(this.models[i]);
      }
      this._reset();
      this.add(models, _.extend({silent: true}, options));
      if (!options.silent) this.trigger('reset', this, options);
      return this;
    },

    // Fetch the default set of models for this collection, resetting the
    // collection when they arrive. If `add: true` is passed, appends the
    // models to the collection instead of resetting.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      if (options.parse === undefined) options.parse = true;
      var collection = this;
      var success = options.success;
      options.success = function(resp, status, xhr) {
        collection[options.add ? 'add' : 'reset'](collection.parse(resp, xhr), options);
        if (success) success(collection, resp);
      };
      options.error = Backbone.wrapError(options.error, collection, options);
      return (this.sync || Backbone.sync).call(this, 'read', this, options);
    },

    // Create a new instance of a model in this collection. Add the model to the
    // collection immediately, unless `wait: true` is passed, in which case we
    // wait for the server to agree.
    create: function(model, options) {
      var coll = this;
      options = options ? _.clone(options) : {};
      model = this._prepareModel(model, options);
      if (!model) return false;
      if (!options.wait) coll.add(model, options);
      var success = options.success;
      options.success = function(nextModel, resp, xhr) {
        if (options.wait) coll.add(nextModel, options);
        if (success) {
          success(nextModel, resp);
        } else {
          nextModel.trigger('sync', model, resp, options);
        }
      };
      model.save(null, options);
      return model;
    },

    // **parse** converts a response into a list of models to be added to the
    // collection. The default implementation is just to pass it through.
    parse: function(resp, xhr) {
      return resp;
    },

    // Proxy to _'s chain. Can't be proxied the same way the rest of the
    // underscore methods are proxied because it relies on the underscore
    // constructor.
    chain: function () {
      return _(this.models).chain();
    },

    // Reset all internal state. Called when the collection is reset.
    _reset: function(options) {
      this.length = 0;
      this.models = [];
      this._byId  = {};
      this._byCid = {};
    },

    // Prepare a model or hash of attributes to be added to this collection.
    _prepareModel: function(model, options) {
      options || (options = {});
      if (!(model instanceof Model)) {
        var attrs = model;
        options.collection = this;
        model = new this.model(attrs, options);
        if (!model._validate(model.attributes, options)) model = false;
      } else if (!model.collection) {
        model.collection = this;
      }
      return model;
    },

    // Internal method to remove a model's ties to a collection.
    _removeReference: function(model) {
      if (this == model.collection) {
        delete model.collection;
      }
      model.off('all', this._onModelEvent, this);
    },

    // Internal method called every time a model in the set fires an event.
    // Sets need to update their indexes when models change ids. All other
    // events simply proxy through. "add" and "remove" events that originate
    // in other collections are ignored.
    _onModelEvent: function(event, model, collection, options) {
      if ((event == 'add' || event == 'remove') && collection != this) return;
      if (event == 'destroy') {
        this.remove(model, options);
      }
      if (model && event === 'change:' + model.idAttribute) {
        delete this._byId[model.previous(model.idAttribute)];
        this._byId[model.id] = model;
      }
      this.trigger.apply(this, arguments);
    }

  });

  // Underscore methods that we want to implement on the Collection.
  var methods = ['forEach', 'each', 'map', 'reduce', 'reduceRight', 'find',
    'detect', 'filter', 'select', 'reject', 'every', 'all', 'some', 'any',
    'include', 'contains', 'invoke', 'max', 'min', 'sortBy', 'sortedIndex',
    'toArray', 'size', 'first', 'initial', 'rest', 'last', 'without', 'indexOf',
    'shuffle', 'lastIndexOf', 'isEmpty', 'groupBy'];

  // Mix in each Underscore method as a proxy to `Collection#models`.
  _.each(methods, function(method) {
    Collection.prototype[method] = function() {
      return _[method].apply(_, [this.models].concat(_.toArray(arguments)));
    };
  });

  // Backbone.Router
  // -------------------

  // Routers map faux-URLs to actions, and fire events when routes are
  // matched. Creating a new one sets its `routes` hash, if not set statically.
  var Router = Backbone.Router = function(options) {
    options || (options = {});
    if (options.routes) this.routes = options.routes;
    this._bindRoutes();
    this.initialize.apply(this, arguments);
  };

  // Cached regular expressions for matching named param parts and splatted
  // parts of route strings.
  var namedParam    = /:\w+/g;
  var splatParam    = /\*\w+/g;
  var escapeRegExp  = /[-[\]{}()+?.,\\^$|#\s]/g;

  // Set up all inheritable **Backbone.Router** properties and methods.
  _.extend(Router.prototype, Events, {

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // Manually bind a single named route to a callback. For example:
    //
    //     this.route('search/:query/p:num', 'search', function(query, num) {
    //       ...
    //     });
    //
    route: function(route, name, callback) {
      Backbone.history || (Backbone.history = new History);
      if (!_.isRegExp(route)) route = this._routeToRegExp(route);
      if (!callback) callback = this[name];
      Backbone.history.route(route, _.bind(function(fragment) {
        var args = this._extractParameters(route, fragment);
        callback && callback.apply(this, args);
        this.trigger.apply(this, ['route:' + name].concat(args));
        Backbone.history.trigger('route', this, name, args);
      }, this));
      return this;
    },

    // Simple proxy to `Backbone.history` to save a fragment into the history.
    navigate: function(fragment, options) {
      Backbone.history.navigate(fragment, options);
    },

    // Bind all defined routes to `Backbone.history`. We have to reverse the
    // order of the routes here to support behavior where the most general
    // routes can be defined at the bottom of the route map.
    _bindRoutes: function() {
      if (!this.routes) return;
      var routes = [];
      for (var route in this.routes) {
        routes.unshift([route, this.routes[route]]);
      }
      for (var i = 0, l = routes.length; i < l; i++) {
        this.route(routes[i][0], routes[i][1], this[routes[i][1]]);
      }
    },

    // Convert a route string into a regular expression, suitable for matching
    // against the current location hash.
    _routeToRegExp: function(route) {
      route = route.replace(escapeRegExp, '\\$&')
                   .replace(namedParam, '([^\/]+)')
                   .replace(splatParam, '(.*?)');
      return new RegExp('^' + route + '$');
    },

    // Given a route, and a URL fragment that it matches, return the array of
    // extracted parameters.
    _extractParameters: function(route, fragment) {
      return route.exec(fragment).slice(1);
    }

  });

  // Backbone.History
  // ----------------

  // Handles cross-browser history management, based on URL fragments. If the
  // browser does not support `onhashchange`, falls back to polling.
  var History = Backbone.History = function() {
    this.handlers = [];
    _.bindAll(this, 'checkUrl');
  };

  // Cached regex for cleaning leading hashes and slashes .
  var routeStripper = /^[#\/]/;

  // Cached regex for detecting MSIE.
  var isExplorer = /msie [\w.]+/;

  // Has the history handling already been started?
  History.started = false;

  // Set up all inheritable **Backbone.History** properties and methods.
  _.extend(History.prototype, Events, {

    // The default interval to poll for hash changes, if necessary, is
    // twenty times a second.
    interval: 50,

    // Gets the true hash value. Cannot use location.hash directly due to bug
    // in Firefox where location.hash will always be decoded.
    getHash: function(windowOverride) {
      var loc = windowOverride ? windowOverride.location : window.location;
      var match = loc.href.match(/#(.*)$/);
      return match ? match[1] : '';
    },

    // Get the cross-browser normalized URL fragment, either from the URL,
    // the hash, or the override.
    getFragment: function(fragment, forcePushState) {
      if (fragment == null) {
        if (this._hasPushState || forcePushState) {
          fragment = window.location.pathname;
          var search = window.location.search;
          if (search) fragment += search;
        } else {
          fragment = this.getHash();
        }
      }
      if (!fragment.indexOf(this.options.root)) fragment = fragment.substr(this.options.root.length);
      return fragment.replace(routeStripper, '');
    },

    // Start the hash change handling, returning `true` if the current URL matches
    // an existing route, and `false` otherwise.
    start: function(options) {
      if (History.started) throw new Error("Backbone.history has already been started");
      History.started = true;

      // Figure out the initial configuration. Do we need an iframe?
      // Is pushState desired ... is it available?
      this.options          = _.extend({}, {root: '/'}, this.options, options);
      this._wantsHashChange = this.options.hashChange !== false;
      this._wantsPushState  = !!this.options.pushState;
      this._hasPushState    = !!(this.options.pushState && window.history && window.history.pushState);
      var fragment          = this.getFragment();
      var docMode           = document.documentMode;
      var oldIE             = (isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= 7));

      if (oldIE) {
        this.iframe = $('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo('body')[0].contentWindow;
        this.navigate(fragment);
      }

      // Depending on whether we're using pushState or hashes, and whether
      // 'onhashchange' is supported, determine how we check the URL state.
      if (this._hasPushState) {
        $(window).bind('popstate', this.checkUrl);
      } else if (this._wantsHashChange && ('onhashchange' in window) && !oldIE) {
        $(window).bind('hashchange', this.checkUrl);
      } else if (this._wantsHashChange) {
        this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
      }

      // Determine if we need to change the base url, for a pushState link
      // opened by a non-pushState browser.
      this.fragment = fragment;
      var loc = window.location;
      var atRoot  = loc.pathname == this.options.root;

      // If we've started off with a route from a `pushState`-enabled browser,
      // but we're currently in a browser that doesn't support it...
      if (this._wantsHashChange && this._wantsPushState && !this._hasPushState && !atRoot) {
        this.fragment = this.getFragment(null, true);
        window.location.replace(this.options.root + '#' + this.fragment);
        // Return immediately as browser will do redirect to new url
        return true;

      // Or if we've started out with a hash-based route, but we're currently
      // in a browser where it could be `pushState`-based instead...
      } else if (this._wantsPushState && this._hasPushState && atRoot && loc.hash) {
        this.fragment = this.getHash().replace(routeStripper, '');
        window.history.replaceState({}, document.title, loc.protocol + '//' + loc.host + this.options.root + this.fragment);
      }

      if (!this.options.silent) {
        return this.loadUrl();
      }
    },

    // Disable Backbone.history, perhaps temporarily. Not useful in a real app,
    // but possibly useful for unit testing Routers.
    stop: function() {
      $(window).unbind('popstate', this.checkUrl).unbind('hashchange', this.checkUrl);
      clearInterval(this._checkUrlInterval);
      History.started = false;
    },

    // Add a route to be tested when the fragment changes. Routes added later
    // may override previous routes.
    route: function(route, callback) {
      this.handlers.unshift({route: route, callback: callback});
    },

    // Checks the current URL to see if it has changed, and if it has,
    // calls `loadUrl`, normalizing across the hidden iframe.
    checkUrl: function(e) {
      var current = this.getFragment();
      if (current == this.fragment && this.iframe) current = this.getFragment(this.getHash(this.iframe));
      if (current == this.fragment) return false;
      if (this.iframe) this.navigate(current);
      this.loadUrl() || this.loadUrl(this.getHash());
    },

    // Attempt to load the current URL fragment. If a route succeeds with a
    // match, returns `true`. If no defined routes matches the fragment,
    // returns `false`.
    loadUrl: function(fragmentOverride) {
      var fragment = this.fragment = this.getFragment(fragmentOverride);
      var matched = _.any(this.handlers, function(handler) {
        if (handler.route.test(fragment)) {
          handler.callback(fragment);
          return true;
        }
      });
      return matched;
    },

    // Save a fragment into the hash history, or replace the URL state if the
    // 'replace' option is passed. You are responsible for properly URL-encoding
    // the fragment in advance.
    //
    // The options object can contain `trigger: true` if you wish to have the
    // route callback be fired (not usually desirable), or `replace: true`, if
    // you wish to modify the current URL without adding an entry to the history.
    navigate: function(fragment, options) {
      if (!History.started) return false;
      if (!options || options === true) options = {trigger: options};
      var frag = (fragment || '').replace(routeStripper, '');
      if (this.fragment == frag) return;

      // If pushState is available, we use it to set the fragment as a real URL.
      if (this._hasPushState) {
        if (frag.indexOf(this.options.root) != 0) frag = this.options.root + frag;
        this.fragment = frag;
        window.history[options.replace ? 'replaceState' : 'pushState']({}, document.title, frag);

      // If hash changes haven't been explicitly disabled, update the hash
      // fragment to store history.
      } else if (this._wantsHashChange) {
        this.fragment = frag;
        this._updateHash(window.location, frag, options.replace);
        if (this.iframe && (frag != this.getFragment(this.getHash(this.iframe)))) {
          // Opening and closing the iframe tricks IE7 and earlier to push a history entry on hash-tag change.
          // When replace is true, we don't want this.
          if(!options.replace) this.iframe.document.open().close();
          this._updateHash(this.iframe.location, frag, options.replace);
        }

      // If you've told us that you explicitly don't want fallback hashchange-
      // based history, then `navigate` becomes a page refresh.
      } else {
        window.location.assign(this.options.root + fragment);
      }
      if (options.trigger) this.loadUrl(fragment);
    },

    // Update the hash location, either replacing the current entry, or adding
    // a new one to the browser history.
    _updateHash: function(location, fragment, replace) {
      if (replace) {
        location.replace(location.toString().replace(/(javascript:|#).*$/, '') + '#' + fragment);
      } else {
        location.hash = fragment;
      }
    }
  });

  // Backbone.View
  // -------------

  // Creating a Backbone.View creates its initial element outside of the DOM,
  // if an existing element is not provided...
  var View = Backbone.View = function(options) {
    this.cid = _.uniqueId('view');
    this._configure(options || {});
    this._ensureElement();
    this.initialize.apply(this, arguments);
    this.delegateEvents();
  };

  // Cached regex to split keys for `delegate`.
  var delegateEventSplitter = /^(\S+)\s*(.*)$/;

  // List of view options to be merged as properties.
  var viewOptions = ['model', 'collection', 'el', 'id', 'attributes', 'className', 'tagName'];

  // Set up all inheritable **Backbone.View** properties and methods.
  _.extend(View.prototype, Events, {

    // The default `tagName` of a View's element is `"div"`.
    tagName: 'div',

    // jQuery delegate for element lookup, scoped to DOM elements within the
    // current view. This should be prefered to global lookups where possible.
    $: function(selector) {
      return this.$el.find(selector);
    },

    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function(){},

    // **render** is the core function that your view should override, in order
    // to populate its element (`this.el`), with the appropriate HTML. The
    // convention is for **render** to always return `this`.
    render: function() {
      return this;
    },

    // Remove this view from the DOM. Note that the view isn't present in the
    // DOM by default, so calling this method may be a no-op.
    remove: function() {
      this.$el.remove();
      return this;
    },

    // For small amounts of DOM Elements, where a full-blown template isn't
    // needed, use **make** to manufacture elements, one at a time.
    //
    //     var el = this.make('li', {'class': 'row'}, this.model.escape('title'));
    //
    make: function(tagName, attributes, content) {
      var el = document.createElement(tagName);
      if (attributes) $(el).attr(attributes);
      if (content) $(el).html(content);
      return el;
    },

    // Change the view's element (`this.el` property), including event
    // re-delegation.
    setElement: function(element, delegate) {
      if (this.$el) this.undelegateEvents();
      this.$el = (element instanceof $) ? element : $(element);
      this.el = this.$el[0];
      if (delegate !== false) this.delegateEvents();
      return this;
    },

    // Set callbacks, where `this.events` is a hash of
    //
    // *{"event selector": "callback"}*
    //
    //     {
    //       'mousedown .title':  'edit',
    //       'click .button':     'save'
    //       'click .open':       function(e) { ... }
    //     }
    //
    // pairs. Callbacks will be bound to the view, with `this` set properly.
    // Uses event delegation for efficiency.
    // Omitting the selector binds the event to `this.el`.
    // This only works for delegate-able events: not `focus`, `blur`, and
    // not `change`, `submit`, and `reset` in Internet Explorer.
    delegateEvents: function(events) {
      if (!(events || (events = getValue(this, 'events')))) return;
      this.undelegateEvents();
      for (var key in events) {
        var method = events[key];
        if (!_.isFunction(method)) method = this[events[key]];
        if (!method) throw new Error('Method "' + events[key] + '" does not exist');
        var match = key.match(delegateEventSplitter);
        var eventName = match[1], selector = match[2];
        method = _.bind(method, this);
        eventName += '.delegateEvents' + this.cid;
        if (selector === '') {
          this.$el.bind(eventName, method);
        } else {
          this.$el.delegate(selector, eventName, method);
        }
      }
    },

    // Clears all callbacks previously bound to the view with `delegateEvents`.
    // You usually don't need to use this, but may wish to if you have multiple
    // Backbone views attached to the same DOM element.
    undelegateEvents: function() {
      this.$el.unbind('.delegateEvents' + this.cid);
    },

    // Performs the initial configuration of a View with a set of options.
    // Keys with special meaning *(model, collection, id, className)*, are
    // attached directly to the view.
    _configure: function(options) {
      if (this.options) options = _.extend({}, this.options, options);
      for (var i = 0, l = viewOptions.length; i < l; i++) {
        var attr = viewOptions[i];
        if (options[attr]) this[attr] = options[attr];
      }
      this.options = options;
    },

    // Ensure that the View has a DOM element to render into.
    // If `this.el` is a string, pass it through `$()`, take the first
    // matching element, and re-assign it to `el`. Otherwise, create
    // an element from the `id`, `className` and `tagName` properties.
    _ensureElement: function() {
      if (!this.el) {
        var attrs = getValue(this, 'attributes') || {};
        if (this.id) attrs.id = this.id;
        if (this.className) attrs['class'] = this.className;
        this.setElement(this.make(this.tagName, attrs), false);
      } else {
        this.setElement(this.el, false);
      }
    }

  });

  // The self-propagating extend function that Backbone classes use.
  var extend = function (protoProps, classProps) {
    var child = inherits(this, protoProps, classProps);
    child.extend = this.extend;
    return child;
  };

  // Set up inheritance for the model, collection, and view.
  Model.extend = Collection.extend = Router.extend = View.extend = extend;

  // Backbone.sync
  // -------------

  // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
  var methodMap = {
    'create': 'POST',
    'update': 'PUT',
    'delete': 'DELETE',
    'read':   'GET'
  };

  // Override this function to change the manner in which Backbone persists
  // models to the server. You will be passed the type of request, and the
  // model in question. By default, makes a RESTful Ajax request
  // to the model's `url()`. Some possible customizations could be:
  //
  // * Use `setTimeout` to batch rapid-fire updates into a single request.
  // * Send up the models as XML instead of JSON.
  // * Persist models via WebSockets instead of Ajax.
  //
  // Turn on `Backbone.emulateHTTP` in order to send `PUT` and `DELETE` requests
  // as `POST`, with a `_method` parameter containing the true HTTP method,
  // as well as all requests with the body as `application/x-www-form-urlencoded`
  // instead of `application/json` with the model in a param named `model`.
  // Useful when interfacing with server-side languages like **PHP** that make
  // it difficult to read the body of `PUT` requests.
  Backbone.sync = function(method, model, options) {
    var type = methodMap[method];

    // Default options, unless specified.
    options || (options = {});

    // Default JSON-request options.
    var params = {type: type, dataType: 'json'};

    // Ensure that we have a URL.
    if (!options.url) {
      params.url = getValue(model, 'url') || urlError();
    }

    // Ensure that we have the appropriate request data.
    if (!options.data && model && (method == 'create' || method == 'update')) {
      params.contentType = 'application/json';
      params.data = JSON.stringify(model.toJSON());
    }

    // For older servers, emulate JSON by encoding the request into an HTML-form.
    if (Backbone.emulateJSON) {
      params.contentType = 'application/x-www-form-urlencoded';
      params.data = params.data ? {model: params.data} : {};
    }

    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
    // And an `X-HTTP-Method-Override` header.
    if (Backbone.emulateHTTP) {
      if (type === 'PUT' || type === 'DELETE') {
        if (Backbone.emulateJSON) params.data._method = type;
        params.type = 'POST';
        params.beforeSend = function(xhr) {
          xhr.setRequestHeader('X-HTTP-Method-Override', type);
        };
      }
    }

    // Don't process data on a non-GET request.
    if (params.type !== 'GET' && !Backbone.emulateJSON) {
      params.processData = false;
    }

    // Make the request, allowing the user to override any Ajax options.
    return $.ajax(_.extend(params, options));
  };

  // Wrap an optional error callback with a fallback error event.
  Backbone.wrapError = function(onError, originalModel, options) {
    return function(model, resp) {
      resp = model === originalModel ? resp : model;
      if (onError) {
        onError(originalModel, resp, options);
      } else {
        originalModel.trigger('error', originalModel, resp, options);
      }
    };
  };

  // Helpers
  // -------

  // Shared empty constructor function to aid in prototype-chain creation.
  var ctor = function(){};

  // Helper function to correctly set up the prototype chain, for subclasses.
  // Similar to `goog.inherits`, but uses a hash of prototype properties and
  // class properties to be extended.
  var inherits = function(parent, protoProps, staticProps) {
    var child;

    // The constructor function for the new subclass is either defined by you
    // (the "constructor" property in your `extend` definition), or defaulted
    // by us to simply call the parent's constructor.
    if (protoProps && protoProps.hasOwnProperty('constructor')) {
      child = protoProps.constructor;
    } else {
      child = function(){ parent.apply(this, arguments); };
    }

    // Inherit class (static) properties from parent.
    _.extend(child, parent);

    // Set the prototype chain to inherit from `parent`, without calling
    // `parent`'s constructor function.
    ctor.prototype = parent.prototype;
    child.prototype = new ctor();

    // Add prototype properties (instance properties) to the subclass,
    // if supplied.
    if (protoProps) _.extend(child.prototype, protoProps);

    // Add static properties to the constructor function, if supplied.
    if (staticProps) _.extend(child, staticProps);

    // Correctly set child's `prototype.constructor`.
    child.prototype.constructor = child;

    // Set a convenience property in case the parent's prototype is needed later.
    child.__super__ = parent.prototype;

    return child;
  };

  // Helper function to get a value from a Backbone object as a property
  // or as a function.
  var getValue = function(object, prop) {
    if (!(object && object[prop])) return null;
    return _.isFunction(object[prop]) ? object[prop]() : object[prop];
  };

  // Throw an error when a URL is needed, and none is supplied.
  var urlError = function() {
    throw new Error('A "url" property or function must be specified');
  };

}).call(this);/*1.5.4*/
(function(){var f=0,k=[],m={},i={},a={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},l=/[<>&\"\']/g,b,c=window.setTimeout,d={},e;function h(){this.returnValue=false}function j(){this.cancelBubble=true}(function(n){var o=n.split(/,/),p,r,q;for(p=0;p<o.length;p+=2){q=o[p+1].split(/ /);for(r=0;r<q.length;r++){i[q[r]]=o[p]}}})("application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mpga mpega mp2 mp3,audio/x-wav,wav,audio/mp4,m4a,image/bmp,bmp,image/gif,gif,image/jpeg,jpeg jpg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/vnd.rn-realvideo,rv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe");var g={VERSION:"1.5.4",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:i,ua:(function(){var r=navigator,q=r.userAgent,s=r.vendor,o,n,p;o=/WebKit/.test(q);p=o&&s.indexOf("Apple")!==-1;n=window.opera&&window.opera.buildNumber;return{windows:navigator.platform.indexOf("Win")!==-1,ie:!o&&!n&&(/MSIE/gi).test(q)&&(/Explorer/gi).test(r.appName),webkit:o,gecko:!o&&/Gecko/.test(q),safari:p,opera:!!n}}()),typeOf:function(n){return({}).toString.call(n).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()},extend:function(n){g.each(arguments,function(o,p){if(p>0){g.each(o,function(r,q){n[q]=r})}});return n},cleanName:function(n){var o,p;p=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(o=0;o<p.length;o+=2){n=n.replace(p[o],p[o+1])}n=n.replace(/\s+/g,"_");n=n.replace(/[^a-z0-9_\-\.]+/gi,"");return n},addRuntime:function(n,o){o.name=n;k[n]=o;k.push(o);return o},guid:function(){var n=new Date().getTime().toString(32),o;for(o=0;o<5;o++){n+=Math.floor(Math.random()*65535).toString(32)}return(g.guidPrefix||"p")+n+(f++).toString(32)},buildUrl:function(o,n){var p="";g.each(n,function(r,q){p+=(p?"&":"")+encodeURIComponent(q)+"="+encodeURIComponent(r)});if(p){o+=(o.indexOf("?")>0?"&":"?")+p}return o},each:function(q,r){var p,o,n;if(q){p=q.length;if(p===b){for(o in q){if(q.hasOwnProperty(o)){if(r(q[o],o)===false){return}}}}else{for(n=0;n<p;n++){if(r(q[n],n)===false){return}}}}},formatSize:function(n){if(n===b||/\D/.test(n)){return g.translate("N/A")}if(n>1073741824){return Math.round(n/1073741824,1)+" GB"}if(n>1048576){return Math.round(n/1048576,1)+" MB"}if(n>1024){return Math.round(n/1024,1)+" KB"}return n+" b"},getPos:function(o,s){var t=0,r=0,v,u=document,p,q;o=o;s=s||u.body;function n(B){var z,A,w=0,C=0;if(B){A=B.getBoundingClientRect();z=u.compatMode==="CSS1Compat"?u.documentElement:u.body;w=A.left+z.scrollLeft;C=A.top+z.scrollTop}return{x:w,y:C}}if(o&&o.getBoundingClientRect&&((navigator.userAgent.indexOf("MSIE")>0)&&(u.documentMode<8))){p=n(o);q=n(s);return{x:p.x-q.x,y:p.y-q.y}}v=o;while(v&&v!=s&&v.nodeType){t+=v.offsetLeft||0;r+=v.offsetTop||0;v=v.offsetParent}v=o.parentNode;while(v&&v!=s&&v.nodeType){t-=v.scrollLeft||0;r-=v.scrollTop||0;v=v.parentNode}return{x:t,y:r}},getSize:function(n){return{w:n.offsetWidth||n.clientWidth,h:n.offsetHeight||n.clientHeight}},parseSize:function(n){var o;if(typeof(n)=="string"){n=/^([0-9]+)([mgk]?)$/.exec(n.toLowerCase().replace(/[^0-9mkg]/g,""));o=n[2];n=+n[1];if(o=="g"){n*=1073741824}if(o=="m"){n*=1048576}if(o=="k"){n*=1024}}return n},xmlEncode:function(n){return n?(""+n).replace(l,function(o){return a[o]?"&"+a[o]+";":o}):n},toArray:function(p){var o,n=[];for(o=0;o<p.length;o++){n[o]=p[o]}return n},inArray:function(p,q){if(q){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(q,p)}for(var n=0,o=q.length;n<o;n++){if(q[n]===p){return n}}}return -1},addI18n:function(n){return g.extend(m,n)},translate:function(n){return m[n]||n},isEmptyObj:function(n){if(n===b){return true}for(var o in n){return false}return true},hasClass:function(p,o){var n;if(p.className==""){return false}n=new RegExp("(^|\\s+)"+o+"(\\s+|$)");return n.test(p.className)},addClass:function(o,n){if(!g.hasClass(o,n)){o.className=o.className==""?n:o.className.replace(/\s+$/,"")+" "+n}},removeClass:function(p,o){var n=new RegExp("(^|\\s+)"+o+"(\\s+|$)");p.className=p.className.replace(n,function(r,q,s){return q===" "&&s===" "?" ":""})},getStyle:function(o,n){if(o.currentStyle){return o.currentStyle[n]}else{if(window.getComputedStyle){return window.getComputedStyle(o,null)[n]}}},addEvent:function(s,n,t){var r,q,p,o;o=arguments[3];n=n.toLowerCase();if(e===b){e="Plupload_"+g.guid()}if(s.addEventListener){r=t;s.addEventListener(n,r,false)}else{if(s.attachEvent){r=function(){var u=window.event;if(!u.target){u.target=u.srcElement}u.preventDefault=h;u.stopPropagation=j;t(u)};s.attachEvent("on"+n,r)}}if(s[e]===b){s[e]=g.guid()}if(!d.hasOwnProperty(s[e])){d[s[e]]={}}q=d[s[e]];if(!q.hasOwnProperty(n)){q[n]=[]}q[n].push({func:r,orig:t,key:o})},removeEvent:function(s,n){var q,t,p;if(typeof(arguments[2])=="function"){t=arguments[2]}else{p=arguments[2]}n=n.toLowerCase();if(s[e]&&d[s[e]]&&d[s[e]][n]){q=d[s[e]][n]}else{return}for(var o=q.length-1;o>=0;o--){if(q[o].key===p||q[o].orig===t){if(s.removeEventListener){s.removeEventListener(n,q[o].func,false)}else{if(s.detachEvent){s.detachEvent("on"+n,q[o].func)}}q[o].orig=null;q[o].func=null;q.splice(o,1);if(t!==b){break}}}if(!q.length){delete d[s[e]][n]}if(g.isEmptyObj(d[s[e]])){delete d[s[e]];try{delete s[e]}catch(r){s[e]=b}}},removeAllEvents:function(o){var n=arguments[1];if(o[e]===b||!o[e]){return}g.each(d[o[e]],function(q,p){g.removeEvent(o,p,n)})}};g.Uploader=function(r){var o={},u,t=[],q,p=false;u=new g.QueueProgress();r=g.extend({chunk_size:0,multipart:true,multi_selection:true,file_data_name:"file",filters:[]},r);function s(){var w,x=0,v;if(this.state==g.STARTED){for(v=0;v<t.length;v++){if(!w&&t[v].status==g.QUEUED){w=t[v];w.status=g.UPLOADING;if(this.trigger("BeforeUpload",w)){this.trigger("UploadFile",w)}}else{x++}}if(x==t.length){this.stop();this.trigger("UploadComplete",t)}}}function n(){var w,v;u.reset();for(w=0;w<t.length;w++){v=t[w];if(v.size!==b){u.size+=v.size;u.loaded+=v.loaded}else{u.size=b}if(v.status==g.DONE){u.uploaded++}else{if(v.status==g.FAILED){u.failed++}else{u.queued++}}}if(u.size===b){u.percent=t.length>0?Math.ceil(u.uploaded/t.length*100):0}else{u.bytesPerSec=Math.ceil(u.loaded/((+new Date()-q||1)/1000));u.percent=u.size>0?Math.ceil(u.loaded/u.size*100):0}}g.extend(this,{state:g.STOPPED,runtime:"",features:{},files:t,settings:r,total:u,id:g.guid(),init:function(){var A=this,B,x,w,z=0,y;if(typeof(r.preinit)=="function"){r.preinit(A)}else{g.each(r.preinit,function(D,C){A.bind(C,D)})}r.page_url=r.page_url||document.location.pathname.replace(/\/[^\/]+$/g,"/");if(!/^(\w+:\/\/|\/)/.test(r.url)){r.url=r.page_url+r.url}r.chunk_size=g.parseSize(r.chunk_size);r.max_file_size=g.parseSize(r.max_file_size);A.bind("FilesAdded",function(C,F){var E,D,H=0,I,G=r.filters;if(G&&G.length){I=[];g.each(G,function(J){g.each(J.extensions.split(/,/),function(K){if(/^\s*\*\s*$/.test(K)){I.push("\\.*")}else{I.push("\\."+K.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});I=new RegExp(I.join("|")+"$","i")}for(E=0;E<F.length;E++){D=F[E];D.loaded=0;D.percent=0;D.status=g.QUEUED;if(I&&!I.test(D.name)){C.trigger("Error",{code:g.FILE_EXTENSION_ERROR,message:g.translate("File extension error."),file:D});continue}if(D.size!==b&&D.size>r.max_file_size){C.trigger("Error",{code:g.FILE_SIZE_ERROR,message:g.translate("File size error."),file:D});continue}t.push(D);H++}if(H){c(function(){A.trigger("QueueChanged");A.refresh()},1)}else{return false}});if(r.unique_names){A.bind("UploadFile",function(C,D){var F=D.name.match(/\.([^.]+)$/),E="tmp";if(F){E=F[1]}D.target_name=D.id+"."+E})}A.bind("UploadProgress",function(C,D){D.percent=D.size>0?Math.ceil(D.loaded/D.size*100):100;n()});A.bind("StateChanged",function(C){if(C.state==g.STARTED){q=(+new Date())}else{if(C.state==g.STOPPED){for(B=C.files.length-1;B>=0;B--){if(C.files[B].status==g.UPLOADING){C.files[B].status=g.QUEUED;n()}}}}});A.bind("QueueChanged",n);A.bind("Error",function(C,D){if(D.file){D.file.status=g.FAILED;n();if(C.state==g.STARTED){c(function(){s.call(A)},1)}}});A.bind("FileUploaded",function(C,D){D.status=g.DONE;D.loaded=D.size;C.trigger("UploadProgress",D);c(function(){s.call(A)},1)});if(r.runtimes){x=[];y=r.runtimes.split(/\s?,\s?/);for(B=0;B<y.length;B++){if(k[y[B]]){x.push(k[y[B]])}}}else{x=k}function v(){var F=x[z++],E,C,D;if(F){E=F.getFeatures();C=A.settings.required_features;if(C){C=C.split(",");for(D=0;D<C.length;D++){if(!E[C[D]]){v();return}}}F.init(A,function(G){if(G&&G.success){A.features=E;A.runtime=F.name;A.trigger("Init",{runtime:F.name});A.trigger("PostInit");A.refresh()}else{v()}})}else{A.trigger("Error",{code:g.INIT_ERROR,message:g.translate("Init error.")})}}v();if(typeof(r.init)=="function"){r.init(A)}else{g.each(r.init,function(D,C){A.bind(C,D)})}},refresh:function(){this.trigger("Refresh")},start:function(){if(t.length&&this.state!=g.STARTED){this.state=g.STARTED;this.trigger("StateChanged");s.call(this)}},stop:function(){if(this.state!=g.STOPPED){this.state=g.STOPPED;this.trigger("CancelUpload");this.trigger("StateChanged")}},disableBrowse:function(){p=arguments[0]!==b?arguments[0]:true;this.trigger("DisableBrowse",p)},getFile:function(w){var v;for(v=t.length-1;v>=0;v--){if(t[v].id===w){return t[v]}}},removeFile:function(w){var v;for(v=t.length-1;v>=0;v--){if(t[v].id===w.id){return this.splice(v,1)[0]}}},splice:function(x,v){var w;w=t.splice(x===b?0:x,v===b?t.length:v);this.trigger("FilesRemoved",w);this.trigger("QueueChanged");return w},trigger:function(w){var y=o[w.toLowerCase()],x,v;if(y){v=Array.prototype.slice.call(arguments);v[0]=this;for(x=0;x<y.length;x++){if(y[x].func.apply(y[x].scope,v)===false){return false}}}return true},hasEventListener:function(v){return !!o[v.toLowerCase()]},bind:function(v,x,w){var y;v=v.toLowerCase();y=o[v]||[];y.push({func:x,scope:w||this});o[v]=y},unbind:function(v){v=v.toLowerCase();var y=o[v],w,x=arguments[1];if(y){if(x!==b){for(w=y.length-1;w>=0;w--){if(y[w].func===x){y.splice(w,1);break}}}else{y=[]}if(!y.length){delete o[v]}}},unbindAll:function(){var v=this;g.each(o,function(x,w){v.unbind(w)})},destroy:function(){this.stop();this.trigger("Destroy");this.unbindAll()}})};g.File=function(q,o,p){var n=this;n.id=q;n.name=o;n.size=p;n.loaded=0;n.percent=0;n.status=0};g.Runtime=function(){this.getFeatures=function(){};this.init=function(n,o){}};g.QueueProgress=function(){var n=this;n.size=0;n.loaded=0;n.uploaded=0;n.failed=0;n.queued=0;n.percent=0;n.bytesPerSec=0;n.reset=function(){n.size=n.loaded=n.uploaded=n.failed=n.queued=n.percent=n.bytesPerSec=0}};g.runtimes={};window.plupload=g})();(function(d,a,b,c){function e(f){return a.getElementById(f)}b.runtimes.Html4=b.addRuntime("html4",{getFeatures:function(){return{multipart:true,triggerDialog:(b.ua.gecko&&d.FormData||b.ua.webkit)}},init:function(f,g){f.bind("Init",function(p){var j=a.body,n,h="javascript",k,x,q,z=[],r=/MSIE/.test(navigator.userAgent),t=[],m=p.settings.filters,o,l,s,w;no_type_restriction:for(o=0;o<m.length;o++){l=m[o].extensions.split(/,/);for(w=0;w<l.length;w++){if(l[w]==="*"){t=[];break no_type_restriction}s=b.mimeTypes[l[w]];if(s&&b.inArray(s,t)===-1){t.push(s)}}}t=t.join(",");function v(){var B,y,i,A;q=b.guid();z.push(q);B=a.createElement("form");B.setAttribute("id","form_"+q);B.setAttribute("method","post");B.setAttribute("enctype","multipart/form-data");B.setAttribute("encoding","multipart/form-data");B.setAttribute("target",p.id+"_iframe");B.style.position="absolute";y=a.createElement("input");y.setAttribute("id","input_"+q);y.setAttribute("type","file");y.setAttribute("accept",t);y.setAttribute("size",1);A=e(p.settings.browse_button);if(p.features.triggerDialog&&A){b.addEvent(e(p.settings.browse_button),"click",function(C){if(!y.disabled){y.click()}C.preventDefault()},p.id)}b.extend(y.style,{width:"100%",height:"100%",opacity:0,fontSize:"99px",cursor:"pointer"});b.extend(B.style,{overflow:"hidden"});i=p.settings.shim_bgcolor;if(i){B.style.background=i}if(r){b.extend(y.style,{filter:"alpha(opacity=0)"})}b.addEvent(y,"change",function(F){var D=F.target,C,E=[],G;if(D.value){e("form_"+q).style.top=-1048575+"px";C=D.value.replace(/\\/g,"/");C=C.substring(C.length,C.lastIndexOf("/")+1);E.push(new b.File(q,C));if(!p.features.triggerDialog){b.removeAllEvents(B,p.id)}else{b.removeEvent(A,"click",p.id)}b.removeEvent(y,"change",p.id);v();if(E.length){f.trigger("FilesAdded",E)}}},p.id);B.appendChild(y);j.appendChild(B);p.refresh()}function u(){var i=a.createElement("div");i.innerHTML='<iframe id="'+p.id+'_iframe" name="'+p.id+'_iframe" src="'+h+':&quot;&quot;" style="display:none"></iframe>';n=i.firstChild;j.appendChild(n);b.addEvent(n,"load",function(C){var D=C.target,B,y;if(!k){return}try{B=D.contentWindow.document||D.contentDocument||d.frames[D.id].document}catch(A){p.trigger("Error",{code:b.SECURITY_ERROR,message:b.translate("Security error."),file:k});return}y=B.body.innerHTML;if(y){k.status=b.DONE;k.loaded=1025;k.percent=100;p.trigger("UploadProgress",k);p.trigger("FileUploaded",k,{response:y})}},p.id)}if(p.settings.container){j=e(p.settings.container);if(b.getStyle(j,"position")==="static"){j.style.position="relative"}}p.bind("UploadFile",function(i,A){var B,y;if(A.status==b.DONE||A.status==b.FAILED||i.state==b.STOPPED){return}B=e("form_"+A.id);y=e("input_"+A.id);y.setAttribute("name",i.settings.file_data_name);B.setAttribute("action",i.settings.url);b.each(b.extend({name:A.target_name||A.name},i.settings.multipart_params),function(E,C){var D=a.createElement("input");b.extend(D,{type:"hidden",name:C,value:E});B.insertBefore(D,B.firstChild)});k=A;e("form_"+q).style.top=-1048575+"px";B.submit()});p.bind("FileUploaded",function(i){i.refresh()});p.bind("StateChanged",function(i){if(i.state==b.STARTED){u()}else{if(i.state==b.STOPPED){d.setTimeout(function(){b.removeEvent(n,"load",i.id);if(n.parentNode){n.parentNode.removeChild(n)}},0)}}b.each(i.files,function(A,y){if(A.status===b.DONE||A.status===b.FAILED){var B=e("form_"+A.id);if(B){B.parentNode.removeChild(B)}}})});p.bind("Refresh",function(y){var F,A,B,C,i,G,H,E,D;F=e(y.settings.browse_button);if(F){i=b.getPos(F,e(y.settings.container));G=b.getSize(F);H=e("form_"+q);E=e("input_"+q);b.extend(H.style,{top:i.y+"px",left:i.x+"px",width:G.w+"px",height:G.h+"px"});if(y.features.triggerDialog){if(b.getStyle(F,"position")==="static"){b.extend(F.style,{position:"relative"})}D=parseInt(F.style.zIndex,10);if(isNaN(D)){D=0}b.extend(F.style,{zIndex:D});b.extend(H.style,{zIndex:D-1})}B=y.settings.browse_button_hover;C=y.settings.browse_button_active;A=y.features.triggerDialog?F:H;if(B){b.addEvent(A,"mouseover",function(){b.addClass(F,B)},y.id);b.addEvent(A,"mouseout",function(){b.removeClass(F,B)},y.id)}if(C){b.addEvent(A,"mousedown",function(){b.addClass(F,C)},y.id);b.addEvent(a.body,"mouseup",function(){b.removeClass(F,C)},y.id)}}});f.bind("FilesRemoved",function(y,B){var A,C;for(A=0;A<B.length;A++){C=e("form_"+B[A].id);if(C){C.parentNode.removeChild(C)}}});f.bind("DisableBrowse",function(i,A){var y=a.getElementById("input_"+q);if(y){y.disabled=A}});f.bind("Destroy",function(i){var y,A,B,C={inputContainer:"form_"+q,inputFile:"input_"+q,browseButton:i.settings.browse_button};for(y in C){A=e(C[y]);if(A){b.removeAllEvents(A,i.id)}}b.removeAllEvents(a.body,i.id);b.each(z,function(E,D){B=e("form_"+E);if(B){j.removeChild(B)}})});v()});g({success:true})}})})(window,document,plupload);(function(h,k,j,e){var c={},g;function m(o,p){var n;if("FileReader" in h){n=new FileReader();n.readAsDataURL(o);n.onload=function(){p(n.result)}}else{return p(o.getAsDataURL())}}function l(o,p){var n;if("FileReader" in h){n=new FileReader();n.readAsBinaryString(o);n.onload=function(){p(n.result)}}else{return p(o.getAsBinary())}}function d(r,p,n,v){var q,o,u,s,t=this;m(c[r.id],function(w){q=k.createElement("canvas");q.style.display="none";k.body.appendChild(q);o=q.getContext("2d");u=new Image();u.onerror=u.onabort=function(){v({success:false})};u.onload=function(){var B,x,z,y,A;if(!p.width){p.width=u.width}if(!p.height){p.height=u.height}s=Math.min(p.width/u.width,p.height/u.height);if(s<1||(s===1&&n==="image/jpeg")){B=Math.round(u.width*s);x=Math.round(u.height*s);q.width=B;q.height=x;o.drawImage(u,0,0,B,x);if(n==="image/jpeg"){y=new f(atob(w.substring(w.indexOf("base64,")+7)));if(y.headers&&y.headers.length){A=new a();if(A.init(y.get("exif")[0])){A.setExif("PixelXDimension",B);A.setExif("PixelYDimension",x);y.set("exif",A.getBinary());if(t.hasEventListener("ExifData")){t.trigger("ExifData",r,A.EXIF())}if(t.hasEventListener("GpsData")){t.trigger("GpsData",r,A.GPS())}}}if(p.quality){try{w=q.toDataURL(n,p.quality/100)}catch(C){w=q.toDataURL(n)}}}else{w=q.toDataURL(n)}w=w.substring(w.indexOf("base64,")+7);w=atob(w);if(y&&y.headers&&y.headers.length){w=y.restore(w);y.purge()}q.parentNode.removeChild(q);v({success:true,data:w})}else{v({success:false})}};u.src=w})}j.runtimes.Html5=j.addRuntime("html5",{getFeatures:function(){var s,o,r,q,p,n;o=r=p=n=false;if(h.XMLHttpRequest){s=new XMLHttpRequest();r=!!s.upload;o=!!(s.sendAsBinary||s.upload)}if(o){q=!!(s.sendAsBinary||(h.Uint8Array&&h.ArrayBuffer));p=!!(File&&(File.prototype.getAsDataURL||h.FileReader)&&q);n=!!(File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice))}g=j.ua.safari&&j.ua.windows;return{html5:o,dragdrop:(function(){var t=k.createElement("div");return("draggable" in t)||("ondragstart" in t&&"ondrop" in t)}()),jpgresize:p,pngresize:p,multipart:p||!!h.FileReader||!!h.FormData,canSendBinary:q,cantSendBlobInFormData:!!(j.ua.gecko&&h.FormData&&h.FileReader&&!FileReader.prototype.readAsArrayBuffer),progress:r,chunks:n,multi_selection:!(j.ua.safari&&j.ua.windows),triggerDialog:(j.ua.gecko&&h.FormData||j.ua.webkit)}},init:function(p,r){var n,q;function o(w){var u,t,v=[],x,s={};for(t=0;t<w.length;t++){u=w[t];if(s[u.name]){continue}s[u.name]=true;x=j.guid();c[x]=u;v.push(new j.File(x,u.fileName||u.name,u.fileSize||u.size))}if(v.length){p.trigger("FilesAdded",v)}}n=this.getFeatures();if(!n.html5){r({success:false});return}p.bind("Init",function(w){var G,F,C=[],v,D,t=w.settings.filters,u,B,s=k.body,E;G=k.createElement("div");G.id=w.id+"_html5_container";j.extend(G.style,{position:"absolute",background:p.settings.shim_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",zIndex:99999,opacity:p.settings.shim_bgcolor?"":0});G.className="plupload html5";if(p.settings.container){s=k.getElementById(p.settings.container);if(j.getStyle(s,"position")==="static"){s.style.position="relative"}}s.appendChild(G);no_type_restriction:for(v=0;v<t.length;v++){u=t[v].extensions.split(/,/);for(D=0;D<u.length;D++){if(u[D]==="*"){C=[];break no_type_restriction}B=j.mimeTypes[u[D]];if(B&&j.inArray(B,C)===-1){C.push(B)}}}G.innerHTML='<input id="'+p.id+'_html5"  style="font-size:999px" type="file" accept="'+C.join(",")+'" '+(p.settings.multi_selection&&p.features.multi_selection?'multiple="multiple"':"")+" />";G.scrollTop=100;E=k.getElementById(p.id+"_html5");if(w.features.triggerDialog){j.extend(E.style,{position:"absolute",width:"100%",height:"100%"})}else{j.extend(E.style,{cssFloat:"right",styleFloat:"right"})}E.onchange=function(){o(this.files);this.value=""};F=k.getElementById(w.settings.browse_button);if(F){var z=w.settings.browse_button_hover,A=w.settings.browse_button_active,x=w.features.triggerDialog?F:G;if(z){j.addEvent(x,"mouseover",function(){j.addClass(F,z)},w.id);j.addEvent(x,"mouseout",function(){j.removeClass(F,z)},w.id)}if(A){j.addEvent(x,"mousedown",function(){j.addClass(F,A)},w.id);j.addEvent(k.body,"mouseup",function(){j.removeClass(F,A)},w.id)}if(w.features.triggerDialog){j.addEvent(F,"click",function(H){var y=k.getElementById(w.id+"_html5");if(y&&!y.disabled){y.click()}H.preventDefault()},w.id)}}});p.bind("PostInit",function(){var s=k.getElementById(p.settings.drop_element);if(s){if(g){j.addEvent(s,"dragenter",function(w){var v,t,u;v=k.getElementById(p.id+"_drop");if(!v){v=k.createElement("input");v.setAttribute("type","file");v.setAttribute("id",p.id+"_drop");v.setAttribute("multiple","multiple");j.addEvent(v,"change",function(){o(this.files);j.removeEvent(v,"change",p.id);v.parentNode.removeChild(v)},p.id);s.appendChild(v)}t=j.getPos(s,k.getElementById(p.settings.container));u=j.getSize(s);if(j.getStyle(s,"position")==="static"){j.extend(s.style,{position:"relative"})}j.extend(v.style,{position:"absolute",display:"block",top:0,left:0,width:u.w+"px",height:u.h+"px",opacity:0})},p.id);return}j.addEvent(s,"dragover",function(t){t.preventDefault()},p.id);j.addEvent(s,"drop",function(u){var t=u.dataTransfer;if(t&&t.files){o(t.files)}u.preventDefault()},p.id)}});p.bind("Refresh",function(s){var t,u,v,x,w;t=k.getElementById(p.settings.browse_button);if(t){u=j.getPos(t,k.getElementById(s.settings.container));v=j.getSize(t);x=k.getElementById(p.id+"_html5_container");j.extend(x.style,{top:u.y+"px",left:u.x+"px",width:v.w+"px",height:v.h+"px"});if(p.features.triggerDialog){if(j.getStyle(t,"position")==="static"){j.extend(t.style,{position:"relative"})}w=parseInt(j.getStyle(t,"z-index"),10);if(isNaN(w)){w=0}j.extend(t.style,{zIndex:w});j.extend(x.style,{zIndex:w-1})}}});p.bind("DisableBrowse",function(s,u){var t=k.getElementById(s.id+"_html5");if(t){t.disabled=u}});p.bind("CancelUpload",function(){if(q&&q.abort){q.abort()}});p.bind("UploadFile",function(s,u){var v=s.settings,y,t;function x(A,D,z){var B;if(File.prototype.slice){try{A.slice();return A.slice(D,z)}catch(C){return A.slice(D,z-D)}}else{if(B=File.prototype.webkitSlice||File.prototype.mozSlice){return B.call(A,D,z)}else{return null}}}function w(A){var D=0,C=0,z=("FileReader" in h)?new FileReader:null;function B(){var I,M,K,L,H,J,F,E=s.settings.url;function G(V){var T=0,N="----pluploadboundary"+j.guid(),O,P="--",U="\r\n",R="";q=new XMLHttpRequest;if(q.upload){q.upload.onprogress=function(W){u.loaded=Math.min(u.size,C+W.loaded-T);s.trigger("UploadProgress",u)}}q.onreadystatechange=function(){var W,Y;if(q.readyState==4&&s.state!==j.STOPPED){try{W=q.status}catch(X){W=0}if(W>=400){s.trigger("Error",{code:j.HTTP_ERROR,message:j.translate("HTTP Error."),file:u,status:W})}else{if(K){Y={chunk:D,chunks:K,response:q.responseText,status:W};s.trigger("ChunkUploaded",u,Y);C+=J;if(Y.cancelled){u.status=j.FAILED;return}u.loaded=Math.min(u.size,(D+1)*H)}else{u.loaded=u.size}s.trigger("UploadProgress",u);V=I=O=R=null;if(!K||++D>=K){u.status=j.DONE;s.trigger("FileUploaded",u,{response:q.responseText,status:W})}else{B()}}}};if(s.settings.multipart&&n.multipart){L.name=u.target_name||u.name;q.open("post",E,true);j.each(s.settings.headers,function(X,W){q.setRequestHeader(W,X)});if(typeof(V)!=="string"&&!!h.FormData){O=new FormData();j.each(j.extend(L,s.settings.multipart_params),function(X,W){O.append(W,X)});O.append(s.settings.file_data_name,V);q.send(O);return}if(typeof(V)==="string"){q.setRequestHeader("Content-Type","multipart/form-data; boundary="+N);j.each(j.extend(L,s.settings.multipart_params),function(X,W){R+=P+N+U+'Content-Disposition: form-data; name="'+W+'"'+U+U;R+=unescape(encodeURIComponent(X))+U});F=j.mimeTypes[u.name.replace(/^.+\.([^.]+)/,"$1").toLowerCase()]||"application/octet-stream";R+=P+N+U+'Content-Disposition: form-data; name="'+s.settings.file_data_name+'"; filename="'+unescape(encodeURIComponent(u.name))+'"'+U+"Content-Type: "+F+U+U+V+U+P+N+P+U;T=R.length-V.length;V=R;if(q.sendAsBinary){q.sendAsBinary(V)}else{if(n.canSendBinary){var S=new Uint8Array(V.length);for(var Q=0;Q<V.length;Q++){S[Q]=(V.charCodeAt(Q)&255)}q.send(S.buffer)}}return}}E=j.buildUrl(s.settings.url,j.extend(L,s.settings.multipart_params));q.open("post",E,true);q.setRequestHeader("Content-Type","application/octet-stream");j.each(s.settings.headers,function(X,W){q.setRequestHeader(W,X)});q.send(V)}if(u.status==j.DONE||u.status==j.FAILED||s.state==j.STOPPED){return}L={name:u.target_name||u.name};if(v.chunk_size&&u.size>v.chunk_size&&(n.chunks||typeof(A)=="string")){H=v.chunk_size;K=Math.ceil(u.size/H);J=Math.min(H,u.size-(D*H));if(typeof(A)=="string"){I=A.substring(D*H,D*H+J)}else{I=x(A,D*H,D*H+J)}L.chunk=D;L.chunks=K}else{J=u.size;I=A}if(s.settings.multipart&&n.multipart&&typeof(I)!=="string"&&z&&n.cantSendBlobInFormData&&n.chunks&&s.settings.chunk_size){z.onload=function(){G(z.result)};z.readAsBinaryString(I)}else{G(I)}}B()}y=c[u.id];if(n.jpgresize&&s.settings.resize&&/\.(png|jpg|jpeg)$/i.test(u.name)){d.call(s,u,s.settings.resize,/\.png$/i.test(u.name)?"image/png":"image/jpeg",function(z){if(z.success){u.size=z.data.length;w(z.data)}else{if(n.chunks){w(y)}else{l(y,w)}}})}else{if(!n.chunks&&n.jpgresize){l(y,w)}else{w(y)}}});p.bind("Destroy",function(s){var u,v,t=k.body,w={inputContainer:s.id+"_html5_container",inputFile:s.id+"_html5",browseButton:s.settings.browse_button,dropElm:s.settings.drop_element};for(u in w){v=k.getElementById(w[u]);if(v){j.removeAllEvents(v,s.id)}}j.removeAllEvents(k.body,s.id);if(s.settings.container){t=k.getElementById(s.settings.container)}t.removeChild(k.getElementById(w.inputContainer))});r({success:true})}});function b(){var q=false,o;function r(t,v){var s=q?0:-8*(v-1),w=0,u;for(u=0;u<v;u++){w|=(o.charCodeAt(t+u)<<Math.abs(s+u*8))}return w}function n(u,s,t){var t=arguments.length===3?t:o.length-s-1;o=o.substr(0,s)+u+o.substr(t+s)}function p(t,u,w){var x="",s=q?0:-8*(w-1),v;for(v=0;v<w;v++){x+=String.fromCharCode((u>>Math.abs(s+v*8))&255)}n(x,t,w)}return{II:function(s){if(s===e){return q}else{q=s}},init:function(s){q=false;o=s},SEGMENT:function(s,u,t){switch(arguments.length){case 1:return o.substr(s,o.length-s-1);case 2:return o.substr(s,u);case 3:n(t,s,u);break;default:return o}},BYTE:function(s){return r(s,1)},SHORT:function(s){return r(s,2)},LONG:function(s,t){if(t===e){return r(s,4)}else{p(s,t,4)}},SLONG:function(s){var t=r(s,4);return(t>2147483647?t-4294967296:t)},STRING:function(s,t){var u="";for(t+=s;s<t;s++){u+=String.fromCharCode(r(s,1))}return u}}}function f(s){var u={65505:{app:"EXIF",name:"APP1",signature:"Exif\0"},65506:{app:"ICC",name:"APP2",signature:"ICC_PROFILE\0"},65517:{app:"IPTC",name:"APP13",signature:"Photoshop 3.0\0"}},t=[],r,n,p=e,q=0,o;r=new b();r.init(s);if(r.SHORT(0)!==65496){return}n=2;o=Math.min(1048576,s.length);while(n<=o){p=r.SHORT(n);if(p>=65488&&p<=65495){n+=2;continue}if(p===65498||p===65497){break}q=r.SHORT(n+2)+2;if(u[p]&&r.STRING(n+4,u[p].signature.length)===u[p].signature){t.push({hex:p,app:u[p].app.toUpperCase(),name:u[p].name.toUpperCase(),start:n,length:q,segment:r.SEGMENT(n,q)})}n+=q}r.init(null);return{headers:t,restore:function(y){r.init(y);var w=new f(y);if(!w.headers){return false}for(var x=w.headers.length;x>0;x--){var z=w.headers[x-1];r.SEGMENT(z.start,z.length,"")}w.purge();n=r.SHORT(2)==65504?4+r.SHORT(4):2;for(var x=0,v=t.length;x<v;x++){r.SEGMENT(n,0,t[x].segment);n+=t[x].length}return r.SEGMENT()},get:function(x){var y=[];for(var w=0,v=t.length;w<v;w++){if(t[w].app===x.toUpperCase()){y.push(t[w].segment)}}return y},set:function(y,x){var z=[];if(typeof(x)==="string"){z.push(x)}else{z=x}for(var w=ii=0,v=t.length;w<v;w++){if(t[w].app===y.toUpperCase()){t[w].segment=z[ii];t[w].length=z[ii].length;ii++}if(ii>=z.length){break}}},purge:function(){t=[];r.init(null)}}}function a(){var q,n,o={},t;q=new b();n={tiff:{274:"Orientation",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};t={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function p(u,C){var w=q.SHORT(u),z,F,G,B,A,v,x,D,E=[],y={};for(z=0;z<w;z++){x=v=u+12*z+2;G=C[q.SHORT(x)];if(G===e){continue}B=q.SHORT(x+=2);A=q.LONG(x+=2);x+=4;E=[];switch(B){case 1:case 7:if(A>4){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.BYTE(x+F)}break;case 2:if(A>4){x=q.LONG(x)+o.tiffHeader}y[G]=q.STRING(x,A-1);continue;case 3:if(A>2){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.SHORT(x+F*2)}break;case 4:if(A>1){x=q.LONG(x)+o.tiffHeader}for(F=0;F<A;F++){E[F]=q.LONG(x+F*4)}break;case 5:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.LONG(x+F*4)/q.LONG(x+F*4+4)}break;case 9:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.SLONG(x+F*4)}break;case 10:x=q.LONG(x)+o.tiffHeader;for(F=0;F<A;F++){E[F]=q.SLONG(x+F*4)/q.SLONG(x+F*4+4)}break;default:continue}D=(A==1?E[0]:E);if(t.hasOwnProperty(G)&&typeof D!="object"){y[G]=t[G][D]}else{y[G]=D}}return y}function s(){var v=e,u=o.tiffHeader;q.II(q.SHORT(u)==18761);if(q.SHORT(u+=2)!==42){return false}o.IFD0=o.tiffHeader+q.LONG(u+=2);v=p(o.IFD0,n.tiff);o.exifIFD=("ExifIFDPointer" in v?o.tiffHeader+v.ExifIFDPointer:e);o.gpsIFD=("GPSInfoIFDPointer" in v?o.tiffHeader+v.GPSInfoIFDPointer:e);return true}function r(w,u,z){var B,y,x,A=0;if(typeof(u)==="string"){var v=n[w.toLowerCase()];for(hex in v){if(v[hex]===u){u=hex;break}}}B=o[w.toLowerCase()+"IFD"];y=q.SHORT(B);for(i=0;i<y;i++){x=B+12*i+2;if(q.SHORT(x)==u){A=x+8;break}}if(!A){return false}q.LONG(A,z);return true}return{init:function(u){o={tiffHeader:10};if(u===e||!u.length){return false}q.init(u);if(q.SHORT(0)===65505&&q.STRING(4,5).toUpperCase()==="EXIF\0"){return s()}return false},EXIF:function(){var v;v=p(o.exifIFD,n.exif);if(v.ExifVersion&&j.typeOf(v.ExifVersion)==="array"){for(var w=0,u="";w<v.ExifVersion.length;w++){u+=String.fromCharCode(v.ExifVersion[w])}v.ExifVersion=u}return v},GPS:function(){var u;u=p(o.gpsIFD,n.gps);if(u.GPSVersionID){u.GPSVersionID=u.GPSVersionID.join(".")}return u},setExif:function(u,v){if(u!=="PixelXDimension"&&u!=="PixelYDimension"){return false}return r("exif",u,v)},getBinary:function(){return q.SEGMENT()}}}})(window,document,plupload);(function(f,a,c,g,e){var h={};function b(i){return c.translate(i)||i}function d(i){i.html('<div class="plupload_wrapper"><div class="ui-widget-content plupload_container"><div class="plupload"><div class="ui-state-default ui-widget-header plupload_header"><div class="plupload_header_content"><div class="plupload_header_title">'+b("Select files")+'</div><div class="plupload_header_text">'+b("Add files to the upload queue and click the start button.")+'</div></div></div><div class="plupload_content"><table class="plupload_filelist"><tr class="ui-widget-header plupload_filelist_header"><td class="plupload_cell plupload_file_name">'+b("Filename")+'</td><td class="plupload_cell plupload_file_status">'+b("Status")+'</td><td class="plupload_cell plupload_file_size">'+b("Size")+'</td><td class="plupload_cell plupload_file_action">&nbsp;</td></tr></table><div class="plupload_scroll"><table class="plupload_filelist_content"></table></div><table class="plupload_filelist"><tr class="ui-widget-header ui-widget-content plupload_filelist_footer"><td class="plupload_cell plupload_file_name"><div class="plupload_buttons"><!-- Visible --><a class="plupload_button plupload_add">'+b("Add Files")+'</a>&nbsp;<a class="plupload_button plupload_start">'+b("Start Upload")+'</a>&nbsp;<a class="plupload_button plupload_stop plupload_hidden">'+b("Stop Upload")+'</a>&nbsp;</div><div class="plupload_started plupload_hidden"><!-- Hidden --><div class="plupload_progress plupload_right"><div class="plupload_progress_container"></div></div><div class="plupload_cell plupload_upload_status"></div><div class="plupload_clearer">&nbsp;</div></div></td><td class="plupload_file_status"><span class="plupload_total_status">0%</span></td><td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td><td class="plupload_file_action"></td></tr></table></div></div></div><input class="plupload_count" value="0" type="hidden"></div>')}g.widget("ui.plupload",{contents_bak:"",runtime:null,options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",dragdrop:true,multiple_queues:true,buttons:{browse:true,start:true,stop:true},autostart:false,sortable:false,rename:false,max_file_count:0},FILE_COUNT_ERROR:-9001,_create:function(){var i=this,k,j;k=this.element.attr("id");if(!k){k=c.guid();this.element.attr("id",k)}this.id=k;this.contents_bak=this.element.html();d(this.element);this.container=g(".plupload_container",this.element).attr("id",k+"_container");this.filelist=g(".plupload_filelist_content",this.container).attr({id:k+"_filelist",unselectable:"on"});this.browse_button=g(".plupload_add",this.container).attr("id",k+"_browse");this.start_button=g(".plupload_start",this.container).attr("id",k+"_start");this.stop_button=g(".plupload_stop",this.container).attr("id",k+"_stop");if(g.ui.button){this.browse_button.button({icons:{primary:"ui-icon-circle-plus"}});this.start_button.button({icons:{primary:"ui-icon-circle-arrow-e"},disabled:true});this.stop_button.button({icons:{primary:"ui-icon-circle-close"}})}this.progressbar=g(".plupload_progress_container",this.container);if(g.ui.progressbar){this.progressbar.progressbar()}this.counter=g(".plupload_count",this.element).attr({id:k+"_count",name:k+"_count"});j=this.uploader=h[k]=new c.Uploader(g.extend({container:k,browse_button:k+"_browse"},this.options));j.bind("Error",function(l,m){if(m.code===c.INIT_ERROR){i.destroy()}});j.bind("Init",function(l,m){if(!i.options.buttons.browse){i.browse_button.button("disable").hide();l.disableBrowse(true)}if(!i.options.buttons.start){i.start_button.button("disable").hide()}if(!i.options.buttons.stop){i.stop_button.button("disable").hide()}if(!i.options.unique_names&&i.options.rename){i._enableRenaming()}if(j.features.dragdrop&&i.options.dragdrop){i._enableDragAndDrop()}i.container.attr("title",b("Using runtime: ")+(i.runtime=m.runtime));i.start_button.click(function(n){if(!g(this).button("option","disabled")){i.start()}n.preventDefault()});i.stop_button.click(function(n){i.stop();n.preventDefault()})});if(i.options.max_file_count){j.bind("FilesAdded",function(l,n){var o=[],m=n.length;var p=l.files.length+m-i.options.max_file_count;if(p>0){o=n.splice(m-p,p);l.trigger("Error",{code:i.FILE_COUNT_ERROR,message:b("File count error."),file:o})}})}j.init();j.bind("FilesAdded",function(l,m){i._trigger("selected",null,{up:l,files:m});if(i.options.autostart){setTimeout(function(){i.start()},10)}});j.bind("FilesRemoved",function(l,m){i._trigger("removed",null,{up:l,files:m})});j.bind("QueueChanged",function(){i._updateFileList()});j.bind("StateChanged",function(){i._handleState()});j.bind("UploadFile",function(l,m){i._handleFileStatus(m)});j.bind("FileUploaded",function(l,m){i._handleFileStatus(m);i._trigger("uploaded",null,{up:l,file:m})});j.bind("UploadProgress",function(l,m){g("#"+m.id).find(".plupload_file_status").html(m.percent+"%").end().find(".plupload_file_size").html(c.formatSize(m.size));i._handleFileStatus(m);i._updateTotalProgress();i._trigger("progress",null,{up:l,file:m})});j.bind("UploadComplete",function(l,m){i._trigger("complete",null,{up:l,files:m})});j.bind("Error",function(l,p){var n=p.file,o,m;if(n){o="<strong>"+p.message+"</strong>";m=p.details;if(m){o+=" <br /><i>"+p.details+"</i>"}else{switch(p.code){case c.FILE_EXTENSION_ERROR:m=b("File: %s").replace("%s",n.name);break;case c.FILE_SIZE_ERROR:m=b("File: %f, size: %s, max file size: %m").replace(/%([fsm])/g,function(r,q){switch(q){case"f":return n.name;case"s":return n.size;case"m":return c.parseSize(i.options.max_file_size)}});break;case i.FILE_COUNT_ERROR:m=b("Upload element accepts only %d file(s) at a time. Extra files were stripped.").replace("%d",i.options.max_file_count);break;case c.IMAGE_FORMAT_ERROR:m=c.translate("Image format either wrong or not supported.");break;case c.IMAGE_MEMORY_ERROR:m=c.translate("Runtime ran out of available memory.");break;case c.IMAGE_DIMENSIONS_ERROR:m=c.translate("Resoultion out of boundaries! <b>%s</b> runtime supports images only up to %wx%hpx.").replace(/%([swh])/g,function(r,q){switch(q){case"s":return l.runtime;case"w":return l.features.maxWidth;case"h":return l.features.maxHeight}});break;case c.HTTP_ERROR:m=b("Upload URL might be wrong or doesn't exist");break}o+=" <br /><i>"+m+"</i>"}i.notify("error",o);i._trigger("error",null,{up:l,file:n,error:o})}})},_setOption:function(j,k){var i=this;if(j=="buttons"&&typeof(k)=="object"){k=g.extend(i.options.buttons,k);if(!k.browse){i.browse_button.button("disable").hide();up.disableBrowse(true)}else{i.browse_button.button("enable").show();up.disableBrowse(false)}if(!k.start){i.start_button.button("disable").hide()}else{i.start_button.button("enable").show()}if(!k.stop){i.stop_button.button("disable").hide()}else{i.start_button.button("enable").show()}}i.uploader.settings[j]=k},start:function(){this.uploader.start();this._trigger("start",null)},stop:function(){this.uploader.stop();this._trigger("stop",null)},getFile:function(j){var i;if(typeof j==="number"){i=this.uploader.files[j]}else{i=this.uploader.getFile(j)}return i},removeFile:function(j){var i=this.getFile(j);if(i){this.uploader.removeFile(i)}},clearQueue:function(){this.uploader.splice()},getUploader:function(){return this.uploader},refresh:function(){this.uploader.refresh()},_handleState:function(){var j=this,i=this.uploader;if(i.state===c.STARTED){g(j.start_button).button("disable");g([]).add(j.stop_button).add(".plupload_started").removeClass("plupload_hidden");g(".plupload_upload_status",j.element).text(b("Uploaded %d/%d files").replace("%d/%d",i.total.uploaded+"/"+i.files.length));g(".plupload_header_content",j.element).addClass("plupload_header_content_bw")}else{g([]).add(j.stop_button).add(".plupload_started").addClass("plupload_hidden");if(j.options.multiple_queues){g(j.start_button).button("enable");g(".plupload_header_content",j.element).removeClass("plupload_header_content_bw")}j._updateFileList()}},_handleFileStatus:function(l){var n,j;if(!g("#"+l.id).length){return}switch(l.status){case c.DONE:n="plupload_done";j="ui-icon ui-icon-circle-check";break;case c.FAILED:n="ui-state-error plupload_failed";j="ui-icon ui-icon-alert";break;case c.QUEUED:n="plupload_delete";j="ui-icon ui-icon-circle-minus";break;case c.UPLOADING:n="ui-state-highlight plupload_uploading";j="ui-icon ui-icon-circle-arrow-w";var i=g(".plupload_scroll",this.container),m=i.scrollTop(),o=i.height(),k=g("#"+l.id).position().top+g("#"+l.id).height();if(o<k){i.scrollTop(m+k-o)}break}n+=" ui-state-default plupload_file";g("#"+l.id).attr("class",n).find(".ui-icon").attr("class",j)},_updateTotalProgress:function(){var i=this.uploader;this.progressbar.progressbar("value",i.total.percent);this.element.find(".plupload_total_status").html(i.total.percent+"%").end().find(".plupload_total_file_size").html(c.formatSize(i.total.size)).end().find(".plupload_upload_status").text(b("Uploaded %d/%d files").replace("%d/%d",i.total.uploaded+"/"+i.files.length))},_updateFileList:function(){var k=this,j=this.uploader,m=this.filelist,l=0,o,n=this.id+"_",i;if(g.ui.sortable&&this.options.sortable){g("tbody",m).sortable("destroy")}m.empty();g.each(j.files,function(q,p){i="";o=n+l;if(p.status===c.DONE){if(p.target_name){i+='<input type="hidden" name="'+o+'_tmpname" value="'+c.xmlEncode(p.target_name)+'" />'}i+='<input type="hidden" name="'+o+'_name" value="'+c.xmlEncode(p.name)+'" />';i+='<input type="hidden" name="'+o+'_status" value="'+(p.status===c.DONE?"done":"failed")+'" />';l++;k.counter.val(l)}m.append('<tr class="ui-state-default plupload_file" id="'+p.id+'"><td class="plupload_cell plupload_file_name"><span>'+p.name+'</span></td><td class="plupload_cell plupload_file_status">'+p.percent+'%</td><td class="plupload_cell plupload_file_size">'+c.formatSize(p.size)+'</td><td class="plupload_cell plupload_file_action"><div class="ui-icon"></div>'+i+"</td></tr>");k._handleFileStatus(p);g("#"+p.id+".plupload_delete .ui-icon, #"+p.id+".plupload_done .ui-icon").click(function(r){g("#"+p.id).remove();j.removeFile(p);r.preventDefault()});k._trigger("updatelist",null,m)});if(j.total.queued===0){g(".ui-button-text",k.browse_button).text(b("Add Files"))}else{g(".ui-button-text",k.browse_button).text(b("%d files queued").replace("%d",j.total.queued))}if(j.files.length===(j.total.uploaded+j.total.failed)){k.start_button.button("disable")}else{k.start_button.button("enable")}m[0].scrollTop=m[0].scrollHeight;k._updateTotalProgress();if(!j.files.length&&j.features.dragdrop&&j.settings.dragdrop){g("#"+o+"_filelist").append('<tr><td class="plupload_droptext">'+b("Drag files here.")+"</td></tr>")}else{if(k.options.sortable&&g.ui.sortable){k._enableSortingList()}}},_enableRenaming:function(){var i=this;g(".plupload_delete .plupload_file_name span",this.filelist).live("click",function(o){var m=g(o.target),k,n,j,l="";k=i.uploader.getFile(m.parents("tr")[0].id);j=k.name;n=/^(.+)(\.[^.]+)$/.exec(j);if(n){j=n[1];l=n[2]}m.hide().after('<input class="plupload_file_rename" type="text" />');m.next().val(j).focus().blur(function(){m.show().next().remove()}).keydown(function(q){var p=g(this);if(g.inArray(q.keyCode,[13,27])!==-1){q.preventDefault();if(q.keyCode===13){k.name=p.val()+l;m.text(k.name)}p.blur()}})})},_enableDragAndDrop:function(){this.filelist.append('<tr><td class="plupload_droptext">'+b("Drag files here.")+"</td></tr>");this.filelist.parent().attr("id",this.id+"_dropbox");this.uploader.settings.drop_element=this.options.drop_element=this.id+"_dropbox"},_enableSortingList:function(){var j,i=this;if(g("tbody tr",this.filelist).length<2){return}g("tbody",this.filelist).sortable({containment:"parent",items:".plupload_delete",helper:function(l,k){return k.clone(true).find("td:not(.plupload_file_name)").remove().end().css("width","100%")},stop:function(p,o){var l,n,k,m=[];g.each(g(this).sortable("toArray"),function(q,r){m[m.length]=i.uploader.getFile(r)});m.unshift(m.length);m.unshift(0);Array.prototype.splice.apply(i.uploader.files,m)}})},notify:function(j,k){var i=g('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="'+b("Close")+'"></span><p><span class="ui-icon"></span>'+k+"</p></div>");i.addClass("ui-state-"+(j==="error"?"error":"highlight")).find("p .ui-icon").addClass("ui-icon-"+(j==="error"?"alert":"info")).end().find(".plupload_message_close").click(function(){i.remove()}).end();g(".plupload_header_content",this.container).append(i)},destroy:function(){g(".plupload_button",this.element).unbind();if(g.ui.button){g(".plupload_add, .plupload_start, .plupload_stop",this.container).button("destroy")}if(g.ui.progressbar){this.progressbar.progressbar("destroy")}if(g.ui.sortable&&this.options.sortable){g("tbody",this.filelist).sortable("destroy")}this.uploader.destroy();this.element.empty().html(this.contents_bak);this.contents_bak="";g.Widget.prototype.destroy.apply(this)}})}(window,document,plupload,jQuery));// <debug/>

// <strict>

/**
 * Handles an error message by either displaying it in the JS console, or throwing
 * and exception (only avalible in development and strict build).
 * @static
 * @param {String} errorMessage The error message to display or throw
 */
function handleError(errorMessage) {
    if (console && console.error) {
        console.error(errorMessage);
    } else {
        throw errorMessage;
    }
}

// Ensure jQuery has been included
if (!$) handleError(tr('jQuery is required'));

// Ensure jQuery UI has been included
if (!$.ui) handleError(tr('jQuery UI is required'));

// Ensure dialog has been included
if (!$.ui.dialog) handleError(tr('jQuery UI Dialog is required.'));

// </strict>

// <ie>
if (!Object.create) {
    Object.create = function (o) {
        if (arguments.length > 1) {
            throw new Error('Object.create implementation only accepts the first parameter.');
        }
        function F() {}
        F.prototype = o;
        return new F();
    };
}
// </ie>
/**
 * @fileoverview BaseView class.
 * @author David Neilsen - david@panmedia.co.nz
 * @author Michael Robinson - michael@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 * @augments Backbone
 */
var BaseView = Backbone.View.extend({
    options: {
        getTemplate: null
    },

    initialize: function(options) {
        this.getTemplate = this.getTemplate || this.options.getTemplate;
    },

    get: function(key) {
        return this.options[key];
    },

    close: function() {
        this.remove();
        this.unbind();
        if (this.onClose){
            this.onClose();
        }
    }
});
/**
 * Singleton class used to manage localizations
 * @type {Backbone.Model}
 */
var Internationalisation = Backbone.Model.extend({}, {

    /** @property {String|null} currentLocale */
    currentLocale: null,

    /**
     * @property {Object} locales
     */
    locales: {},

    /**
     * @property {Object} localeNames
     */
    localeNames: {},

    /**
     * @static
     * @param {String} name
     * @param {String} nativeName
     * @param {Object} strings
     */
    registerLocale: function(name, nativeName, strings) {
        // <strict>
        if (this.locales[name]) {
            handleError(tr('Locale "{{localeName}}" has already been registered, and will be overwritten', {localeName: name}));
        }
        // </strict>
        this.locales[name] = strings;
        this.localeNames[name] = nativeName;
        if (!this.currentLocale) this.currentLocale = name;
    },

    getLocalizedString: function(string) {
        if (typeof this.locales[this.currentLocale] !== 'undefined' &&
            typeof this.locales[this.currentLocale][string] !== 'undefined') {
            return this.locales[this.currentLocale][string];
        }

        for (var localeName in this.localeNames) {
          if (typeof this.locales[localeName][string] !== 'undefined') {
                return this.locales[localeName][string];
            }
        }

        // <debug/>
        return string;
     },

    /**
     * Internationalisation function. Translates a string with tagged variable
     * references to the current locale.
     *
     * <p>
     * Variable references should be surrounded with double curly braces {{ }}
     *      e.g. "This string has a variable: {{my.variable}} which will not be translated"
     * </p>
     *
     * @static
     * @param {String} string
     * @param {Object} variables
      */
    translate: function(string, variables) {
        string = this.getLocalizedString(string);

        // Convert the variables
        if (!variables) {
            return string;
        } else {
            for (var key in variables) {
                string = string.replace('{{' + key + '}}', variables[key]);
            }
            return string;
        }
    }
});

/**
 * @fileOverview English strings file.
 *
 * @author Michael Robinson <michael@panmedia.co.nz>
 */
Internationalisation.registerLocale('en', 'English', {
    tagSidebarCreateTag: 'Create Tag',
    tagSidebarNavigateFilterFiles: 'Navigate / filter files'
});

/**
 * @fileoverview Addon class.
 * @author David Neilsen - david@panmedia.co.nz
 * @author Michael Robinson - michael@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 * @augments BaseView
 */
var Addon = BaseView.extend({

    options: {
        fileManager: null,
        baseClass: null,
        baseUrl: null,
        name: null
    },

    initialize: function(options) {
        BaseView.prototype.initialize.apply(this, arguments);
        this.fileManager = this.options.fileManager;
        this.fileManager.on('render-addons', this.render, this);
    },

    getUniqueId: function() {
        return this.fileManager.getUniqueId(this.get('baseClass'));
    },

    getBaseClass: function() {
        return this.get('baseClass');
    },

    getUrl: function() {
        if (this.get('url')) {
            return this.get('url');
        } else {
            return this.fileManager.getUrl(this.get('name'));
        }
    },

    getLabel: function() {
        if (this.get('label')) {
            return this.get('label');
        } else {
            return this.get('name');
        }
    },

    getTemplate: function(name, variables) {
        return this.fileManager.getTemplate(name, $.extend({}, variables, { baseClass: this.get('baseClass') }));
    }
});
/**
 * @fileoverview Addon Subview class.
 * @author David Neilsen - david@panmedia.co.nz
 * @author Michael Robinson - michael@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 * @augments BaseView
 */
var AddonSubView = BaseView.extend({

    options: {
        addon: null
    },

    initialize: function() {
        BaseView.prototype.initialize.apply(this, arguments);
        this.addon = this.options.addon;
    }
});
/**
 * @fileoverview 
 * @author David Neilsen - david@panmedia.co.nz
 * @author Michael Robinson - michael@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 *
 * @todo not sure how to comment this
 */
Backbone.Collection.prototype._meta = {};

Backbone.Collection.prototype.meta = function(name, value) {
    if (value === undefined) {
        return this._meta[name];
    } else {
        this._meta[name] = value;
    }
};
/**
 * @fileOverview Contains the file class code.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 *
 * @class The file class.
 * @augments Backbone.Model
 */
var File = Backbone.Model.extend({

    /**
     * @type {Object} Default attributes.
     */
    defaults: {
        name: null,
        created: null,
        size: null,
        metadata: null,
        tags: []
    },

    /**
     * Ensure tags is not null.
     */
    initialize: function() {
        if(!this.get('tags')){
            this.set({ tags: new Tags() });
        }
    },

    /**
     * Override set function to ensure tags are set to a Tags collection.
     *
     * @param {Object} attributes
     * @param {Object} options
     * @return {mixed} Result of parent set call.
     */
    set: function(attributes, options) {
        if (typeof attributes.tags !== 'undefined' &&
            !(attributes.tags instanceof Tags)) {
            attributes.tags = new Tags(attributes.tags);
        }
        return Backbone.Model.prototype.set.call(this, attributes, options);
    },

    /**
     * Convert tags array to a Tags collection.
     *
     * @param {Object} response
     * @return {Object} The modified response.
     */
    parse: function(response) {
        response.tags = new Tags(response.tags);
        return response;
    },

    getName: function() {
        return this.get('name');
    },

    getType: function() {
        return this.get('metadata').type.replace(/[^\/]+\//, '');
    },

    /**
     * Convenience method to get the public URI.
     * @return {String}
     */
    publicUri: function() {
        return this.get('publicUri');
    },

    /**
     * Prepares & returns an action URI for this file.
     *
     * @param {String|null} action The action to be interpolated between the
     * root URI and the file name + optional get parameters.
     * @param  {Object} parameters A hash to be appended as GET parameters.
     * @return {String} The URI.
     */
    actionUri: function(action, parameters) {
        action = action || '';
        if (action) {
            action = '/' + action.replace(/^\//, '');
        }
        parameters = parameters || '';
        if (parameters) {
            parameters = '?' + $.param(parameters);
        }
        return this.urlRoot.replace(/\/$/, '') + '/' + this.get('name') + action + parameters;
    },

    /**
     * Prepares & returns the public URI for a potentially resized thumbnail
     * for this file.
     *
     * @param {Object} parameters [description]
     * @return {String} The public thumbnail URI.
     */
    thumbnailUri: function(parameters) {
        return this.actionUri('thumbnail', $.extend({}, {
            'upscale': false,
            'width': 100,
            'height': 100
        }, parameters));
    },

    /**
     * Prepares & returns the public download URI for this file.
     *
     * @return {String} The download URI.
     */
    downloadUri: function() {
        return this.actionUri('download');
    },

    /**
     * Format the file's upload date.
     *
     * @return {String} The file's formatted upload date.
     */
    formatCreated: function() {
        return (new Date(this.get('created') * 1000)).toLocaleString();
    },

    /**
     * @return {Boolean} True if this file is an image.
     */
    isImage: function() {
        return -1 !== $.inArray(this.get('metadata').type, [
            'image/jpg',
            'image/jpeg',
            'image/gif',
            'image/png'
        ]);
    },

    /**
     * @param {Tag} tag The tag to be added.
     * @param {Object|null} options
     */
    addTag: function(tag, options) {
        this.get('tags').add(tag);
        this.save();
    },

    /**
     * @param {Tag} tag The tag to be removed.
     * @param {Object|null} options
     */
    removeTag: function(tag, options) {
        this.get('tags').remove(tag);
        this.save(null, options);
    }
},
{

});
/**
 * @fileoverview The FileManager class code.
 */

/**
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires jQuery UI
 * @requires Backbone
 * @constructor
 */
var FileManager = function(options) {
    /** @namespace Default attributes. */
    var defaults = {

        addons: {},

        autoEnable: true,


        /** @type {String} The current locale of the filemanager. */
        locale: '',

        /** @type {String} String that will prefix all automatically applied class names. */
        baseClass: 'ui-filemanager',

        /** @type {String} URL that all interaction with the server will stem from. */
        baseUrl: '/filemanager',

        dialog: true,

        /** @type {Object} Options applied to the file manager's main dialog. */
        dialogOptions: {
            modal: true,
            minWidth: 765,
            minHeight: 700
        },

        /**
         * @type {String} Title of the file manager.
         */
        title: tr('Filemanager'),

        persistence: {

            /** @type {String} Namespace used to persistence to prevent conflicting stored values. */
            namespace: null,

            /** @type {Boolean} Switch to indicate whether or not to store persistent values. If set to false the persist function will always return null. */
            enable: false,

            /** @type {String} The name to store persistent values under. */

            name: 'FileManager'
        },

        /** @type {Boolean} Switch to specify if the filemanager should automatically enable all addons. If set to false, only the addons specified in the 'addons' option object will be enabled */
        enableAddons: true,

        /** @type {String[]} An array of explicitly disabled addons */
        disabledAddons: [],

        element: false,

        modelUrls: {
            file: false,
            files: false,
            tag: false,
            tags: false
        }
    };

    if (!this.isSupported()) {
        return;
    }

    $.extend(true, this.options, defaults, options);

    /** @type {Object} Addon instances used by this instance. */
    this.addons = {};

    /** @type {Object} Filters to apply to file list requests. */
    this.filters = {};
    this.id = this.getUniqueId();
    this.initialiseModels();
    this.loadAddons();

    this.view = false;

    /** @type {Files} A collection of selected files */
    this.selectedFiles =  null;
    this.selectedAllFiles =  false;

    this.on('add-tag-to-filter', this.addTagToFilter, this);
    this.on('remove-tag-from-filter', this.removeTagFromFilter, this);

    if (this.get('autoEnable')) {
        this.show();
    }
};

FileManager.prototype = Object.create(Backbone.Events);

FileManager.prototype.options = {};
FileManager.prototype.view = false;

/**
 * Set models' URL's to use standard namespace, if a default has not been
 * specified.
 */
FileManager.prototype.initialiseModels = function() {
    // @todo refactor this to allow different URLs across FileManager instances
    var modelUrls = this.get('modelUrls');
    File.prototype.urlRoot = modelUrls.file.url || this.getUrl('files');
    Files.prototype.url = modelUrls.files.url || this.getUrl('files');
    Tag.prototype.urlRoot = modelUrls.tag.url || this.getUrl('tags');
    Tags.prototype.url = modelUrls.tags.url || this.getUrl('tags');
};

/**
 * Prepares and returns the FileManagerView.
 *
 * @returns {FileManagerView}
 */
FileManager.prototype.getView = function() {
    if (this.view === false) {
        this.view = new FileManagerView({
            dialog: this.options.dialog ? this.options.dialogOptions : false,
            getTemplate: _.bind(this.getTemplate, this),
            id: this.getUniqueId(),
            el: this.get('element'),
            fileManager: this
        })
        .render();
        this.trigger('render-addons');
    }
    return this.view;
};

FileManager.prototype.show = function() {
    this.getView().show();
    this.trigger('show');
};

FileManager.prototype.hide = function() {
    this.getView().hide();
    this.trigger('hide');
};

/*========================================================================*\
 * Filter
\*========================================================================*/

/**
 * Add to the file list request filter.
 * Any current matching entry will be overwritten.
 * Refresh is called after filter is added.
 *
 * @param {Object|String} filter The filter for the file list.
 * @param {mixed} value The value of filter if filter is a string.
 * @return {FileManager}
 */
FileManager.prototype.addFilter = function(filter, value) {
    if (typeof filter === 'string') {
        filter = { filter: value };
    }
    this.filters = $.extend({}, this.filters, filter);
    this.refresh();
    return this;
};

/**
 * Clear file list request filter completely, or just those items
 * referenced by the keys provided.
 *
 * @param  {String[]|null} keys Array of keys to remove, or null to completely
 *                              clear filters.
 */
FileManager.prototype.clearFilter = function(keys) {
    if (typeof keys === 'undefined') {
        this.filters = {};
    }
    if (!$.isArray(keys)) {
        keys = [keys];
    }
    for (var i = 0; i < keys.length; i++) {
        if (typeof this.filters[keys[i]] !== 'undefined') {
            delete this.filters[keys[i]];
        }
    }
    this.refresh();
};

/**
 * Prepares and returns the file ist request filters with a given key.
 *
 * @param {String} key The key for the filter to return.
 * @return {Object} The file list request filters.
 */
FileManager.prototype.getFilter = function(key) {
    if(typeof key !== 'undefined') {
        return this.filters[key];
    }
    return this.filters;
};

/**
 * Add the given tag's ID to the filter if not already present.
 *
 * @param {Tag} tag The tag to have it's ID added.
 * @return {FileManager} The instance for chaining.
 */
FileManager.prototype.addTagToFilter = function(tag) {
    var tags = this.getFilter('tags[]');
    if (typeof tags === 'undefined') {
        tags = [];
    }

    if ($.inArray(tag.get('id'), tags) !== -1) {
        return this;
    }
    tags.push(tag.get('id'));
    this.addFilter({ 'tags[]': tags });
    return this;
};

/**
 * Remove the given tag's ID from the filter, if present.
 *
 * @param {Tag} tag The tag to have it's ID removed.
 * @return {FileManager} The instance for chaining.
 */
FileManager.prototype.removeTagFromFilter = function(tag) {
    var tags = this.getFilter('tags[]');
    if (typeof tags === 'undefined') {
        return;
    }
    this.clearFilter('tags[]');

    tags = arrayRemoveElementByValue(tags, tag.get('id'));

    if (tags.length) {
        this.addFilter({ 'tags[]': tags });
    }
    return this;
};

/*========================================================================*\
 * Tabs
\*========================================================================*/

FileManager.prototype.addToTab = function(addon, tab, index) {
    return this.getView().addToTab(addon, tab, index);
};

/*========================================================================*\
 * Getters
\*========================================================================*/

FileManager.prototype.getUrl = function(segment) {
    return (this.get('baseUrl').replace(/\/$/, '') + '/' + segment.replace(/^\//, ''));
};

FileManager.prototype.get = function(key) {
    return this.options[key];
};

/*========================================================================*\
 * Selection
\*========================================================================*/

/**
 * @return {Files} Files collection representing current selection.
 */
FileManager.prototype.getSelectedFiles = function() {
    if (this.selectedFiles === null) {
        this.selectedFiles = new Files();
    }
    return this.selectedFiles;
};

/**
 * @return {Integer} The total currently selected files. If in "select all" mode,
 * returns the total files.
 */
FileManager.prototype.getTotalSelectedFiles = function() {
    if (this.selectedAllFiles) {
        return -1;
    }
    return this.getSelectedFiles().length;
};

FileManager.prototype.getSelectedAllFiles = function() {
    return this.selectedAllFiles;
};

/**
 * Enter "select all" mode.
 */
FileManager.prototype.selectAllFiles = function() {
    this.selectedAllFiles = true;
    this.getSelectedFiles().reset({ silent: true });
    this.getSelectedFiles().trigger('add');
};

/**
 * Select the given file. Cancel "select all" mode if currently set.
 *
 * @param {File} file The given file.
 */
FileManager.prototype.selectFile = function(file) {
    this.selectedAllFiles = false;
    this.getSelectedFiles().add(file);
};

/**
 * @param {String} id
 * @return {Boolean} True if the file represented by id is selected.
 */
FileManager.prototype.isFileSelected = function(id) {
    return this.selectedAllFiles || typeof this.getSelectedFiles().get(id) !== 'undefined';
};

/**
 * Deselect the given file. Cancel "select all" mode if currently set.
 *
 * @param {File} file
 */
FileManager.prototype.deselectFile = function(file) {
    this.selectedAllFiles = false;
    this.getSelectedFiles().remove(file);
};

/**
 * Deselect all files. Cancel "select all" mode if currently set.
 */
FileManager.prototype.deselectAllFiles = function() {
    this.selectedAllFiles = false;
    this.getSelectedFiles().reset();
};

/*========================================================================*\
 * Addons
\*========================================================================*/

/**
 * @param {String} name
 * @return {Object|undefined} addon
 */
FileManager.prototype.getAddon = function(name) {
    return this.addons[name];
};

/**
 * Load the FileManager Addons.
 */
FileManager.prototype.loadAddons = function() {
    for (var name in FileManager.addons) {
        // Check if we are not automatically enabling addons, and if not, check if the addon was manually enabled
        if (this.get('enableAddons') === false &&
                typeof FileManager.addons[name] === 'undefined' ||
                FileManager.addons[name] === false) {
            // <debug/>
            continue;
        }
        // Check if we have explicitly disabled the addon
        if ($.inArray(name, this.get('disabledAddons')) !== -1) {
            continue;
        }

        options = $.extend(this.get('addons')[name], {
            fileManager: this,
            baseClass: this.get('baseClass') + '-' + name,
            baseUrl: stringRtrim(this.get('baseUrl'), '/') + '/' + name,
            name: name
        });
        this.addons[name] = addon = new FileManager.addons[name](options);
    }
};

/*========================================================================*\
 * Template functions
\*========================================================================*/

/**
 * @param {String} name
 * @param {Object} variables
 */
FileManager.prototype.getTemplate = function(name, variables) {
    var template;
    if (!Templates.compiled[name]) {
        template = Templates.loadTemplate(name, this.get('baseUrl'));
    } else {
        template = Templates.compiled[name];
    }

    if (!template) {
        // <strict>
        handleError('Template "' + name + '" has not been loaded');
        // </strict>
        return '';
    }

    // Translate template
    template = template.replace(/tr\(['"]{1}(.*?)['"]{1}\)/g, function(match, string) {
        string = string.replace(/\\(.?)/g, function (s, slash) {
            switch (slash) {
                case '\\':return '\\';
                case '0':return '\u0000';
                case '':return '';
                default:return slash;
            }
        });
        return tr(string);
    });
    // Replace variables
    variables = $.extend({}, this.options, variables || {});
    variables = this.getTemplateVars(variables);
    template = template.replace(/\{\{(.*?)\}\}/g, function(match, variable) {
        return variables[variable];
    });
    return template.trim();
};

/**
 * @todo depth details and return details
 *
 * @param {Object} variables
 * @param {String} prefix
 * @param {type} depth
 * @returns {unresolved}
 */
FileManager.prototype.getTemplateVars = function(variables, prefix, depth) {
    prefix = prefix ? prefix + '.' : '';
    var maxDepth = 5;
    if (!depth) depth = 1;
    var result = {};
    for (var name in variables) {
        if (typeof variables[name] === 'object' && depth < maxDepth) {
            var inner = this.getTemplateVars(variables[name], prefix + name, ++depth);
            for (var innerName in inner) {
                result[innerName] = inner[innerName];
            }
        } else {
            result[prefix + name] = variables[name];
        }
    }
    return result;
};

/*========================================================================*\
 * Helpers
\*========================================================================*/

/**
 * Create & return an ID not yet used in the DOM.
 *
 * @todo check baseClass type and include des?
 * @param {String|null} baseClass
 * @returns {String} The unique ID.
 */
FileManager.prototype.getUniqueId = function(baseClass) {
    baseClass = baseClass || this.get('baseClass');
    var id = baseClass + '-uid-' + new Date().getTime() + '-' + Math.floor(Math.random() * 100000);
    while ($('#' + id).length) {
        id = baseClass + '-uid-' + new Date().getTime() + '-' + Math.floor(Math.random() * 100000);
    }
    return id;
};

/**
 * @todo type and desc for force
 * @param {type} force
 */
FileManager.prototype.refresh = function(force) {
    if (force) {
        this.addFilter('timestamp', (new Date()).getTime());
    }
    this.trigger('refresh');
};

/*========================================================================*\
 * Persistance Functions
\*========================================================================*/

/**
 * @param {String} key
 * @param {mixed} [value]
 * @returns {mixed}
 */
FileManager.prototype.persist = function(key, value) {
    if (!this.get('persistence').enable) return null;
    return FileManager.persist(key, value, this.get('persistence').namespace);
};

/*========================================================================*\
 * Browser support
\*========================================================================*/

/**
 * Check whether the FileManager can be used in the current browser.
 *
 * @return {Boolean} True if the current browser can run the FileManager.
 */
FileManager.prototype.isSupported = function() {
    return true;
    if (FileManager.supported === undefined) {
        FileManager.supported = true;

        // <ios>
        ios = /(iPhone|iPod|iPad).*AppleWebKit/i.test(navigator.userAgent);
        if (ios) {
            // $('html').addClass(editor.options.baseClass + '-ios');

            // Fixed position hack
            // if (ios) {
            //     $(document).bind('scroll', function(){
            //         setInterval(function() {
            //             $('body').css('height', '+=1').css('height', '-=1');
            //         }, 0);
            //     });
            // }
        }
        // </ios>

        firefox = /Firefox/i.test(navigator.userAgent);
        // if (firefox) {
        //     $('html').addClass(editor.options.baseClass + '-ff');
        // }

        // <ie>
        /**
         * Returns the version of Internet Explorer or a -1 (indicating the use of another browser).
         * http://msdn.microsoft.com/en-us/library/ms537509(v=vs.85).aspx
         */
        var ieVersion = (function() {
            var rv = -1; // Return value assumes failure.
            if (navigator.appName == 'Microsoft Internet Explorer') {
                var ua = navigator.userAgent;
                var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
                if (re.exec(ua) !== null) {
                    rv = parseFloat(RegExp.$1);
                }
            }
            return rv;
        })();

        ie = ieVersion !== -1;
        if (ie && ieVersion < 9) {
            FileManager.supported = false;

            // Create message modal
            // var message = $('<div/>')
            //     .addClass(editor.options.baseClass + '-unsupported')
            //     .html(editor.getTemplate('unsupported'))
            //     .appendTo('body');

            // elementBringToTop(message);

            // // Close event
            // message.find('.' + editor.options.baseClass + '-unsupported-close').click(function() {
            //     message.remove();
            // });
        }
        // </ie>

        hotkeys = jQuery.hotkeys !== undefined;
    }
    return FileManager.supported;
};

FileManager.supported = null;
FileManager.ios = null;

FileManager.addons = {};

/** @type {String} Bottom tab constant */
FileManager.TAB_BOTTOM = 'bottom';

/** @type {String} Top tab constant */
FileManager.TAB_TOP = 'top';

/** @type {String} Left tab constant */
FileManager.TAB_LEFT = 'left';

/** @type {String} Right tab constant */
FileManager.TAB_RIGHT = 'right';

/*========================================================================*\
 * Addon & UI
\*========================================================================*/

/**
 * Register FileManager Addons.
 *
 * @param {Object|String} mixed
 * @param {Object} [addon]
 */
FileManager.registerAddon = function(mixed, addon) {
    // Allow array objects, and single addons
    if (typeof(mixed) === 'string') {
        // <strict>
        if (this.addons[mixed]) {
            handleError(tr('Addon "{{pluginName}}" has already been registered, and will be overwritten', { addonName: mixed }));
        }
        // </strict>

        this.addons[mixed] = addon;
    } else {
        for (var name in mixed) {
            this.registerAddon(name, mixed[name]);
        }
    }
};

/*========================================================================*\
 * Persistance
\*========================================================================*/

/**
 * @todo requires method desc and desc for return.
 *
 * @param {String} key
 * @param {mixed} value
 * @param {String} namespace
 * @return {mixed}
 */
FileManager.persist = function(key, value, namespace) {
    key = namespace ? namespace + '.' + key : key;
    if (localStorage) {
        var storage;
        if (localStorage.FileManager) {
            storage = JSON.parse(localStorage.FileManager);
        } else {
            storage = {};
        }
        if (value === undefined) return storage[key];
        storage[key] = value;
        localStorage.FileManager = JSON.stringify(storage);
    }

    return value;
};

/**
 * Add the file manager class to the global scope.
 */
window['FileManager'] = FileManager;

//
/**
 * Make a jQuery plugin to allow usage like: $('.someClass').fileManager(options); <--- does this still need to be here?
 *
 * @todo check type for options and returns
 * @param {mixed} options
 * @returns {Object}
 */
$.fn.fileManager = function(options) {
    options = $.extend({}, options, {
        element: $(this)
    });
    if (typeof options.dialog === 'undefined') {
        options.dialog = false;
    }
    return this.each(function() {
        new FileManager(options);
    });
};
/**
 * @fileoverview File Manager View class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 *
 * @requires jQuery
 * @requires Backbone
 * @augments Baseview
 */

var FileManagerView = BaseView.extend({

    options: {
        id: null,
        fileManager: null,
        dialog: null
    },

    initialize: function(options) {
        BaseView.prototype.initialize.apply(this, arguments);
        this.fileManager = options.fileManager;
        this.tabs = {};
    },

    show: function() {
        if (this.get('dialog')) {
            this.$el.dialog('open');
        } else {
            this.$el.show();
        }
    },

    hide: function() {
        if (this.get('dialog')) {
            this.$el.dialog('close');
        } else {
            this.$el.hide();
        }
    },

    render: function() {
        // <strict>
        if (this.$el.html() !== '') {
            handleError('Render may be called once only per instance');
            return;
        }
        // </strict>

        this.$el.html(this.getTemplate('main-view'))
                .css({ display: 'none' })
                .addClass(this.get('baseClass'))
                .attr('id', this.get('id'));

        if (this.get('dialog')) {
            this.renderDialog();
        }

        return this;
    },

    renderDialog: function() {
        var instance = this;
        var dialogOptions = {
            title: this.get('title'),
            autoOpen: false,
            dialogClass: this.fileManager.get('baseClass') + '-dialog',
            position: function() {
                // Set the persistent position
                var position = this.fileManager.persist('position') || this.get('dialog').position;

                if (!position) {
                    position = [
                        $(window).height() - instance.element.outerHeight(),
                        $(window).width() - instance.element.outerWidth()
                    ];
                } else {
                    if (parseInt(position[0], 10) + instance.element.outerHeight() > $(window).height()) {
                        position[0] = $(window).height() - instance.element.outerHeight();
                    }
                    if (parseInt(position[1], 10) + instance.element.outerWidth() > $(window).width()) {
                        position[1] = $(window).width() - instance.element.outerWidth();
                    }
                }
                return {
                    top: Math.abs(parseInt(position[0], 10)),
                    left: Math.abs(parseInt(position[1], 10))
                };
            },
            dragStop: $.proxy(function(event, ui) {
                // Save the persistent position
                var pos = instance.fileManager.persist('position', [
                    ui.position.top,
                    ui.position.left
                ]);
            }, this)
        };

        this.$el.appendTo('body');
        this.$el.dialog($.extend(true, {}, dialogOptions, this.get('dialog')));
        return this;
    },

    /*========================================================================*\
     * Tabs
    \*========================================================================*/

    totalTabs: function(tab) {
        if (typeof this.tabs[tab] === 'undefined') {
            return 0;
        }
        return this.tabs[tab].find(this.fileManager.get('baseClass') + '-tabs > ul li').length;
    },

    /**
     * Initialises the file view's tabs if required, then adds a new tab and
     * returns the content pane for it.
     *
     * @todo revise commenting for this function...
     * @param {String} url Identifier for this tab, must be unique
     * @param {String} label Tab's label
     * @param {Integer|null} index Position for the new tab
     */
    addToTab: function(addon, tab, index) {
        if (typeof this.tabs[tab] === 'undefined') {
            this.tabs[tab] = $(this.$('.' + this.fileManager.get('baseClass') + '-panel-' + tab)
                                    .html(this.getTemplate('tab-frame')))
                                    .removeClass(this.fileManager.get('baseClass') + '-panel-empty')
                                    .tabs();
            if (tab === 'top' || tab === 'bottom') {
                this.tabs[tab].closest('.' + this.fileManager.get('baseClass') + '-panel-center-wrap')
                    .removeClass(this.fileManager.get('baseClass') + '-panel-empty');
            }
        }

        var id = addon.getUniqueId();

        var hashId = '#' + id;
        this.tabs[tab].find(this.fileManager.get('baseClass') + '-tabs > ul').append($.parseHTML('<li><a href="' + hashId + '">' + addon.getLabel() + '</a></li>'));
        this.tabs[tab].append($.parseHTML('<div id="' + id + '"></div>'));
        this.tabs[tab].tabs('refresh');

        // If there is only one tab, hide it
        if (this.totalTabs(tab) === 1) {
            this.tabs[tab].find('.' + this.fileManager.get('baseClass') + '-tabs').hide();
            this.tabs[tab].removeClass(this.fileManager.get('baseClass') + '-tabs-multiple')
                .addClass(this.fileManager.get('baseClass') + '-tabs-single');
        } else {
            this.tabs[tab].find('.' + this.fileManager.get('baseClass') + '-tabs').show();
            this.tabs[tab].removeClass(this.fileManager.get('baseClass') + '-tabs-single')
                .addClass(this.fileManager.get('baseClass') + '-tabs-multiple');
        }

        return $(hashId).addClass(addon.get('baseClass'));
    }
}, { });

/**
 * @fileoverview Files class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 */

/**
 * @augments Backbone.Collection
 */
var Files = Backbone.Collection.extend({
    model: File,
    parse: function(response) {
        /*
         * Total records, before filtering (i.e. the total number of records
         * in the database)
         */
        this.meta('totalSize', response.iTotalRecords);
        /*
         * Total records, after filtering (i.e. the total number of records
         * after filtering has been applied - not just the number of records
         * being returned in this result set)
         */
        this.meta('filteredSize', response.iTotalDisplayRecords);
        return response.aaData;
    },
    addTag: function(tag) {
        for (var modelsIndex = 0; modelsIndex < this.models.length; modelsIndex++) {
            this.models[modelsIndex].addTag(tag);
        }
    }
}, {

});
/**
 * @fileoverview Plugin class.
 * @author David Neilsen - david@panmedia.co.nz
 * @author Michael Robinson - michael@panmedia.co.nz
 * @version 0.1
 * 
 * @requires jQuery
 * @requires Backbone
 * @augments Backbone.Model
 */
var Tag = Backbone.Model.extend({
    defaults: {
        name: null
    }
},
{

});
/**
 * @fileoverview Tags class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 */

/**
 * @augments Backbone.Collection
 */
var Tags = Backbone.Collection.extend({
    model: Tag
}, {

});
/**
 * @fileOverview Contains the templates code.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

var Templates = {
    /*========================================================================*\
     * Templates
    \*========================================================================*/

    /** @type {Object} Compiled templates */
    compiled: { 'datatables.select-all': "{{totalSelected}} files selected. <a href=\"#select-all\" class=\"select-all\">Select all {{totalFiles}} files<\/a>\n",'datatables.row-tag-menu': "<ul class=\"{{baseClass}}-tag-menu\"><\/ul>\n",'datatables.row-controls': "    <div class=\"{{baseClass}}-controls\">\n    <button class=\"insert-file {{baseClass}}-insert\" style=\"display:none\">tr('Insert File')<\/button><button class=\"preview-file {{baseClass}}-preview\">tr('Preview File')<\/button><button class=\"download-file {{baseClass}}-download\">tr('Download')<\/button><button class=\"show-tags {{baseClass}}-tags\">tr('Show Tags')<\/button>\n    <button class=\"delete-file {{baseClass}}-delete\">tr('Delete')<\/button>\n<\/div>\n",'datatables.panel': "<div class=\"{{baseClass}}-table\"><\/div>\n<div class=\"{{baseClass}}-controls\">\n    <button class=\"{{baseClass}}-insert-selected insert-selected\">tr('Insert selected files')<\/button>\n    <button class=\"{{baseClass}}-delete-selected delete-selected\">tr('Delete selected files')<\/button>\n<\/div>\n",'datatables.selection-notification': "<div class=\"ui-widget ui-notification\">\n    <div class=\"ui-state-information ui-corner-all\">\n        <p>\n            <span class=\"ui-icon ui-icon-information\" style=\"float: left; margin-right: .3em;\"><\/span>\n            <span class=\"selection-notification-message\">{{message}}<\/span>\n        <\/p>\n    <\/div>\n<\/div>\n",'datatables.delete-file-confirmation': "<div title=\"tr('Delete this item?')\">\n    <p>\n        <span class=\"ui-icon ui-icon-alert\" style=\"float: left; margin: 0 7px 20px 0;\"><\/span>\n        tr('The file {{fileName}} will be deleted. Are you sure you wish to continue?')\n    <\/p>\n<\/div>\n",'datatables.preview-file-dialog': "<div title=\"tr('Preview file')\">\n    <dl class=\"{{baseClass}}-preview-information\">\n        <dt>tr('Filename')<dt>\n        <dd>{{fileName}}<\/dd>\n        <dt>tr('Uploaded')<\/dt>\n        <dd>{{uploaded}}<\/dd>\n        <dt>tr('File size')<\/dt>\n        <dd>{{size}} MB<\/dd>\n        <dt>tr('File type')<\/dt>\n        <dd>{{type}}<\/dd>\n    <\/dl>\n<\/div>\n",'datatables.selected-all-on-page': "tr('All {{totalFiles}} files selected')\n",'datatables.selection-button': "<button class=\"{{baseClass}}-select-all selection\"><\/button>\n",'datatables.preview-image-dialog': "<div title=\"tr('Preview image')\">\n    <p class=\"{{baseClass}}-preview-image\">\n        <img src=\"{{thumbnailUri}}\" title=\"{{fileName}}\" \/>\n    <\/p>\n    <dl class=\"{{baseClass}}-preview-information\">\n        <dt>tr('Filename')<dt>\n        <dd>{{fileName}}<\/dd>\n        <dt>tr('Uploaded')<\/dt>\n        <dd>{{uploaded}}<\/dd>\n        <dt>tr('File size')<\/dt>\n        <dd>{{size}} MB<\/dd>\n        <dt>tr('File type')<\/dt>\n        <dd>{{type}}<\/dd>\n        <dt>tr('Dimensions')<\/dt>\n        <dd>{{width}}px x {{height}}px<\/dd>\n    <\/dl>\n<\/div>\n",'datatables.row-tag-menu-item': "<li>\n    <div>\n        <button class=\"{{baseClass}}-tag-menu-tag tag-filter\">{{name}}<\/button><button class=\"{{baseClass}}-tag-menu-delete delete-tag\" data-tagId=\"{{id}}\"><\/button>\n    <\/div>\n<\/li>\n",'datatables.table': "<table cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n    <thead>\n        <tr><\/tr>\n    <\/thead>\n    <tbody><\/tbody>\n    <tfoot><\/tfoot>\n<\/table>\n",'datatables.delete-files-confirmation': "<div title=\"tr('Delete these items?')\">\n    <p>\n        <span class=\"ui-icon ui-icon-alert\" style=\"float: left; margin: 0 7px 20px 0;\"><\/span>\n        tr('The selected files will be deleted. Are you sure you wish to continue?')\n    <\/p>\n<\/div>\n",'plupload.file-list-item': "<div id=\"{{baseClass}}-file-{{fileId}}\" class=\"{{baseClass}}-file-list-item ui-state-default\" data-file_id=\"{{fileId}}\">\n    <span class=\"{{baseClass}}-file-message\"><\/span>\n    <span class=\"{{baseClass}}-file-name\">{{fileName}}<\/span>\n    <span class=\"{{baseClass}}-file-size\">{{fileSize}}<\/span>\n    <span class=\"{{baseClass}}-file-remove\"><\/span>\n    <span class=\"{{baseClass}}-file-upload-progress\">\n        <span><\/span>\n    <\/span>\n<\/div>",'plupload.structure': "<div class=\"{{baseClass}}-container\">\n    <h3 class=\"ui-filemanager-title\">File Upload<\/h3>\n    <div class=\"{{baseClass}}-drop-zone ui-state-default\">tr('Drop files here')<\/div>\n    <div class=\"{{baseClass}}-uploading ui-state-active\">\n        <span class=\"{{baseClass}}-upload-message\">tr('Uploading')<\/span>\n        <span class=\"{{baseClass}}-upload-total-progress\">\n            <span><\/span>\n        <\/span>\n    <\/div>\n    <div class=\"{{baseClass}}-file-list\"><\/div>\n    <div class=\"{{baseClass}}-controls\">\n        <button class=\"{{baseClass}}-select\">tr('Select files')<\/button>\n        <button class=\"{{baseClass}}-upload\">tr('Upload')<\/button>\n    <\/div>\n<\/div>\n",'tagsidebar.tag': "<div class=\"tag-draggable\">\n    <button class=\"{{baseClass}}-tag-button tag-button\">{{tagName}}<\/button>\n    <button class=\"{{baseClass}}-menu-button menu-button\">Select an action<\/button>\n<\/div>\n",'tagsidebar.tagmenu': "<ul class=\"{{baseClass}}-option-menu\">\n    <li>\n        <a href=\"#delete\" class=\"delete-tag\">tr('Delete')<\/a>\n    <\/li>\n    <li>\n        <a href=\"#apply-to-selection\" class=\"apply-to-selection\">tr('Apply to selection')<\/a>\n    <\/li>\n<\/ul>\n",'tagsidebar.create-tag': "<div title=\"tr('Create tag')\">\n    <p>\n        tr('Please enter the name for your new tag:')\n    <\/p>\n    <input placeholder=\"tr('Tag name')\" name=\"new-tag-name\" \/>\n<\/div>\n",'tagsidebar.container': "<h3 class=\"ui-filemanager-title\">tr('tagSidebarNavigateFilterFiles')<\/h3>\n\n    <div class=\"{{baseClass}}-file-types-wrapper\">\n        <input type=\"radio\" id=\"{{baseClass}}-file-types-all\" value=\"all\" checked=\"checked\" name=\"{{baseClass}}-file-types\" \/><label for=\"{{baseClass}}-file-types-all\">tr('All')<\/label><input type=\"radio\" id=\"{{baseClass}}-file-types-images\" value=\"images\" name=\"{{baseClass}}-file-types\" \/><label for=\"{{baseClass}}-file-types-images\">tr('Images')<\/label><input type=\"radio\" id=\"{{baseClass}}-file-types-documents\" value=\"documents\" name=\"{{baseClass}}-file-types\" \/><label for=\"{{baseClass}}-file-types-documents\">tr('Documents')<\/label><input type=\"radio\" id=\"{{baseClass}}-file-types-other\" value=\"other\" name=\"{{baseClass}}-file-types\" \/><label for=\"{{baseClass}}-file-types-other\">tr('Other')<\/label>\n    <\/div>\n    <div class=\"{{baseClass}}-tag-controls\">\n        <button class=\"{{baseClass}}-create-tag create-tag\">tr('tagSidebarCreateTag')<\/button>\n    <\/div>\n    <div class=\"{{baseClass}}-tags-wrapper\">\n<\/div>\n",'message': "<div class=\"{{baseClass}}-message-wrapper {{baseClass}}-message-{{type}}\">\n    <div class=\"ui-icon ui-icon-{{type}}\" \/>\n    <div class=\"{{baseClass}}-message\">{{message}}<\/div>\n    <div class=\"{{baseClass}}-message-close ui-icon ui-icon-circle-close\"><\/div>\n<\/div>",'main-view': "<div class=\"{{baseClass}}-panels-wrap\">\n    <div class=\"{{baseClass}}-panel-left {{baseClass}}-panel-empty\"><\/div>\n    <div class=\"{{baseClass}}-panel-center-wrap {{baseClass}}-panel-empty\">\n        <div class=\"{{baseClass}}-panel-top {{baseClass}}-panel-empty\"><\/div>\n        <div class=\"{{baseClass}}-panel-bottom {{baseClass}}-panel-empty\"><\/div>\n    <\/div>\n    <div class=\"{{baseClass}}-panel-right {{baseClass}}-panel-empty\"><\/div>\n<\/div>\n",'tab-frame': "<div class=\"{{baseClass}}-tabs\">\n    <ul><\/ul>\n<\/div>",'unsupported': "<div class=\"{{baseClass}}-unsupported-overlay\"><\/div>\n<div class=\"{{baseClass}}-unsupported-content\">\n    It has been detected that you a using a browser that is not supported by File Manager, please\n    use one of the following browsers:\n\n    <ul>\n        <li><a href=\"http:\/\/www.google.com\/chrome\">Google Chrome<\/a><\/li>\n        <li><a href=\"http:\/\/www.firefox.com\">Mozilla Firefox<\/a><\/li>\n        <li><a href=\"http:\/\/www.google.com\/chromeframe\">Internet Explorer with Chrome Frame<\/a><\/li>\n    <\/ul>\n\n    <div class=\"{{baseClass}}-unsupported-input\">\n        <button class=\"{{baseClass}}-unsupported-close\">Close<\/button>\n        <input name=\"{{baseClass}}-unsupported-show\" type=\"checkbox\" \/>\n        <label>Don't show this message again<\/label>\n    <\/div>\n<div>\n",'messages': "<div class=\"{{baseClass}}-messages\" \/>\n" },

    /**
     * Get the template identified by name.
     *
     * @param {String} name
     * @param {String} urlPrefix
     * @returns {String}
     */
    loadTemplate: function(name, urlPrefix) {
        var template;
        if (!Templates.compiled[name]) {
            // Parse the URL
            var url = urlPrefix || Templates.urlPrefix;
            var split = name.split('.');
            if (split.length === 1) {
                // URL is for and filemanager core template
                url += 'templates/' + split[0] + '.html';
            } else {
                // URL is for a addon template
                url += 'addons/' + split[0] + '/templates/' + split.splice(1).join('/') + '.html';
            }

            // Request the template
            $.ajax({
                url: url,
                type: 'GET',
                async: false,
                // <debug/>
                timeout: 15000, // 15 seconds
                error: function() {
                    template = null;
                },
                success: function(data) {
                    template = data;
                }
            });
            // Cache the template
            Templates.compiled[name] = template;
        } else {
            template = Templates.compiled[name];
        }

        return template;
    }
};
/**
 * Remove array element with the given value.
 *
 * @param  {mixed[]} array
 * @param  {mixed} value
 * @return {mixed[]}
 */
function arrayRemoveElementByValue(array, value) {
    var index = $.inArray(value, array);
    if (index > -1) {
        array.splice(index, 1);
    }
    return array;
}

/**
 * Shortcut function used to wrap translateable strings.
 *
 * @param  {String} string Text to be translated.
 * @param  {Object} variables Object containing values to be interpolated into the translateable string.
 * @return {String} The translated string.
 */
function tr(string, variables) {
    if (typeof Internationalisation === 'undefined') return string;
    else return Internationalisation.translate(string, variables);
}
/**
 * Perform comparison on all propertyNames of two objects.
 *
 * @link http://stackoverflow.com/a/1144249/187954
 * @param  {Object} a
 * @param  {Object} b
 * @return {Boolean} True if both objects are equal.
 */
function objectCompare(a, b) {
    if (b === null || a === null) {
        return false;
    }
    if (typeof b !== 'object' || typeof a !== 'object') {
        return false;
    }

    var propertyName;
    for(propertyName in a) {
        if(typeof(b[propertyName]) === 'undefined') {
            return false;
        }
    }
    for(propertyName in a) {
        if (a[propertyName]) {
            switch(typeof(a[propertyName])) {
                case 'object':
                    if (!objectCompare(a[propertyName], b[propertyName])) {
                        return false;
                    }
                    break;
                case 'function':
                    if (typeof(b[propertyName])=='undefined' ||
                        (propertyName !== 'equals' && a[propertyName].toString() != b[propertyName].toString())) {
                        return false;
                    }
                    break;
                default:
                    if (a[propertyName] !== b[propertyName]) {
                        return false;
                    }
            }
        } else {
            if (b[propertyName]) {
                return false;
            }
        }
    }

    for(propertyName in b) {
        if(typeof(a[propertyName]) === 'undefined') {
            return false;
        }
    }

    return true;
}
/**
 * @fileoverview String helper functions.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires Backbone
 */

/**
 * Trim whitespace or given character from right of given string.
 *
 * @param  {String} string String to trim.
 * @param  {String|null} character The character to trim, null to trim spaces.
 * @return {String} The trimmed string.
 */
function stringRtrim(string, character) {
    character = character || ' ';
    var regexp = new RegExp(character + '+$');
    return string.replace(regexp, '');
}

/**
 * Convert camel cased strings into presentable versions.
 *
 * @param  {String} string The string to be converted.
 * @return {String} The presentable string.
 */
function stringHumanise(string) {
    string = string.replace(/^[a-z]|[^\s][A-Z]/g, function(segment, offset) {
        if (offset === 0) {
            return segment.toUpperCase();
        } else {
            return segment.substr(0,1) + ' ' + segment.substr(1).toUpperCase();
        }
    });

    var upperCaseWords = {
        'uri': 'URI',
        'url': 'URL',
        'id': 'ID'
    };

    var regex;
    for(var word in upperCaseWords) {
        if(upperCaseWords.hasOwnProperty(word)) {
            regex = new RegExp('( ?)(' + word + ')( ?)', 'ig');
            string = string.replace(regex, '$1' + upperCaseWords[word] + '$3');
        }
    }

    return string;
}

/**
 * Truncates the given string.
 *
 * @param {String} string
 * @param {Integer} length
 * @returns {String}
 */
function stringConstrain(string, length) {
    if (string.length > length){
        var s = string.substr(0, length);
        var words = s.split(' ');
        // words[words.length - 1] = '';
        string = words.join(' ') + '&hellip;';
    }
    return string;
}
/**
 * @fileOverview DataTables addon
 * @author Michael Robinson michael@panmedia.co.nz
 * @author David Neilsen david@panmedia.co.nz
 */

/**
 * @name FileManager.datatables
 * @augments Plugin
 * @lends Addon.prototype
 * @see http://datatables.net/
 * @class Adds a datatables tab to the file manager file views tabs
 */
FileManager.registerAddon('datatables', Addon.extend({

    options: {
        label: tr('Details View'),

        /**
         * Function called when an insertion action is performed.
         *
         * @param  {File[]} files Array of selected files
         * @return {Boolean} True if the file manager should be closed
         */
        insertionCallback: null,

        tab: FileManager.TAB_BOTTOM
    },

    initialize: function() {
        Addon.prototype.initialize.apply(this, arguments);

        /** @type {DataTablesView} The DataTable view */
        this.dataTablesView =  null;

        // <strict>
        if (!$.isFunction($.fn.dataTable)) {
            handleError(tr('DataTables addon requires DataTables.'));
            return;
        }
        // </strict>

        this.fileManager.on('upload-complete', this.refresh, this);

        this.on('select-file', this.fileManager.selectFile, this.fileManager);
        this.on('select-visible-files', this.selectVisibleFiles, this);
        this.on('select-all-files', this.fileManager.selectAllFiles, this.fileManager);
        this.on('deselect-file', this.fileManager.deselectFile, this.fileManager);
        this.on('deselect-all-files', this.fileManager.deselectAllFiles, this.fileManager);

        this.on('insert-files', this.insertFiles, this);
        this.on('delete-files', this.deleteFiles, this);
    },

    /**
     * Initialise and add the DataTable to this instance's panel.
     *
     * @param  {Event} event
     */
    render: function(event) {
        // <strict>
        if (this.$el.html() !== '') {
            handleError('Render may be called once only per instance');
            return;
        }
        // </strict>

        this.$el = this.fileManager.addToTab(this, this.get('tab'));
        this.$el.html(this.getTemplate('datatables.panel'));

        this.dataTablesView = new DataTablesView({
                addon: this,
                collection: new Files(),
                el: this.$('.' + this.get('baseClass') + '-table')
            })
            .render();

        this.controlsView = new DataTableControlsView({
                addon: this,
                el: this.$('.' + this.get('baseClass') + '-controls'),
                collection: this.fileManager.getSelectedFiles()
            })
            .render();

        return this;
    },

    /**
     * Delete a single file. User is prompted for confirmation before deletion.
     *
     * @param {File} file
     */
    deleteFile: function(file) {
        this.deleteFiles(file);
    },

    /**
     * Delete one or more files. User is prompted for confirmation before deletion.
     * Files are deleted sequentially.
     *
     * @param {Files|Boolean} files True to delete all files.
     */
    deleteFiles: function(files) {
        var html = '';
        if (files instanceof Files || files === true) {
            html = this.getTemplate('datatables.delete-files-confirmation', { totalFiles: files.length });
        } else {
            html = this.getTemplate('datatables.delete-file-confirmation', { fileName: files.get('name') });
            files = new Files(files);
        }
        var fileManager = this.fileManager;
        $(html).dialog({
            dialogClass: this.get('baseClass') + '-delete-dialog',
            resizable: false,
            height: 'auto',
            modal: true,
            buttons: [
                {
                    text: files.length === 1 ? tr('Delete file') : tr('Delete files'),
                    click: function() {
                        $(this).parent().find('button:first').button('option', 'icons', {
                            primary: 'ui-icon-loading'
                        });
                        var dialog = this;

                        // Delete all files
                        if (files === true) {
                            $.ajax((new Files()).url, {
                                type: 'DELETE',
                                success: function() {
                                    fileManager.refresh(true);
                                    $(dialog).dialog('destroy');
                                    addon.trigger('data-refreshed');
                                }
                            });
                        } else {
                            var options = {
                                wait: true,
                                success: function() {
                                    fileManager.refresh(true);
                                    $(dialog).dialog('destroy');
                                }
                            };
                            var file;
                            while ((file = files.pop())) {
                                // Only supply the options hash when deleting the final file
                                file.destroy(files.length === 0 ? options : {});
                            }
                        }
                    }
                },
                {
                    text: tr('Cancel'),
                    click: function() {
                        $(this).dialog('destroy');
                    }
                }
            ],
            open: function() {
                $(this).parent().find('button:first').button('option', 'icons', {
                        primary: 'ui-icon-circle-check'
                    })
                    .next()
                    .button('option', 'icons', {
                        primary: 'ui-icon-circle-close'
                    });
            }
        });
    },

    /**
     * @return {Boolean} True if the instance has been initialised with an
     * insertion callback.
     */
    hasInsertionCallback: function() {
        return $.isFunction(this.get('insertionCallback'));
    },

    /**
     * Passthrough to the insertion callback, if present.
     *
     * @param  {Files} files
     */
    insertFiles: function(files) {
        this.get('insertionCallback').call(this, files);
    },

    /**
     * @return {Boolean} True if all visible files are selected.
     */
    allVisibleFilesSelected: function() {
        return this.dataTablesView.allVisibleFilesSelected();
    },

    /**
     * @return {Boolean} True if currently in "select all" mode.
     */
    allFilesSelected: function() {
        return this.fileManager.getSelectedAllFiles() || this.fileManager.getSelectedFiles().length == this.getTotalFiles();
    },

    /**
     * @return {Integer} Total files.
     */
    getTotalFiles: function() {
        return this.dataTablesView.getTotalFiles();
    },

    /**
     * @return {Integer} The total currently selected files. If in "select all" mode,
     * returns the total files.
     */
    getTotalSelectedFiles: function() {
        if (this.fileManager.getSelectedAllFiles()) {
            return this.getTotalFiles();
        }
        return this.fileManager.getSelectedFiles().length;
    },

    /**
     * Select all visible files.
     */
    selectVisibleFiles: function() {
        this.dataTablesView.selectVisibleFiles();
    }
}));

/**
 * @fileoverview Data Tables view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class The data tables view class.
 * @augments AddonSubView
 */
var DataTableControlsView = AddonSubView.extend({

    events: {
        'click .insert-selected': function() {
            this.addon.trigger('insert-files', this.collection);
        },
        'click .delete-selected': function() {
            this.addon.trigger('delete-files', this.addon.allFilesSelected() ? true : this.collection);
        }
    },

    initialize: function() {
        AddonSubView.prototype.initialize.apply(this, arguments);
        this.buttonsInitialised = false;
        this.insertButton = false;
        this.deleteButton = false;
        this.collection.on('add remove reset', this.updateButtons, this);
    },

    render: function() {
        this.insertButton = this.$('.insert-selected');
        if (!this.addon.hasInsertionCallback()) {
            this.insertButton.hide();
        } else {
            this.insertButton.button({
                icons: {
                    primary: 'ui-icon-export'
                }
            });
        }

        this.deleteButton = this.$('.delete-selected').button({
            icons: {
                primary: 'ui-icon-document-delete'
            }
        });
        this.buttonsInitialised = true;
        this.updateButtons();
        return this;
    },

    updateButtons: function() {
        if (!this.buttonsInitialised) {
            return;
        }
        if (this.addon.hasInsertionCallback()) {
            this.insertButton.button('option', 'disabled', this.addon.allFilesSelected() ? true : !this.collection.length);
        }
        this.deleteButton.button('option', 'disabled', !this.collection.length);
    }
}, {
});
/**
 * @fileoverview Data Tables view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @link http://www.datatables.net/forums/discussion/comment/34249#Comment_34249
 * @class A Backbone view wrapper for file DataTable rows.
 * @augments AddonSubView
 */
var DataTableRowView = AddonSubView.extend({

    options: {
        selected: false,
        baseClass: null
    },

    events: {
        'click': 'toggleSelection',
        'click button.insert-file': function(event) {
            event.stopPropagation();
            this.addon.trigger('insert-files', new Files(this.model));
        },
        'click button.delete-file': function(event) {
            event.stopPropagation();
            this.addon.deleteFile(this.model);
        },
        'click .preview-file': function(event) {
            event.stopPropagation();
            event.preventDefault();
            this.showPreview();
        },
        'click button.show-tags': 'showTags',
        'click button.download-file': function(event) {
            event.stopPropagation();
            window.location = this.model.downloadUri();
        }
    },

    initialize: function() {
        AddonSubView.prototype.initialize.apply(this, arguments);
        this.showTagsButton = null;
        this.model.bind('sync', this.updateRowState, this);
    },

    /**
     * @return {Object} The columns to be displayed for this row.
     */
    getColumns: function() {
        return DataTableRowView.columns;
    },

    getColumnIndex: function(name) {
        var columns = this.getColumns();
        for (var columnIndex = 0; columnIndex < columns.length; columnIndex++) {
            if (columns[columnIndex].name === name) {
                return columnIndex;
            }
        }
        return -1;
    },

    getCellForColumn: function(name) {
        return this.$('td:eq(' + this.getColumnIndex(name) + ')');
    },

    /**
     * Render the Data Table row.
     *
     * @return {FilesDataTableRow} the current instance for chaining
     */
    render: function() {
        if (this.options.selected) {
            this.select(true);
        }
        return this.renderCreated()
            .renderControls()
            .renderName()
            .renderThumbnail()
            .prepareTagDropTarget();
    },

    /**
     * Render the thumbnail cell.
     *
     * @return {FilesDataTableRow} the current instance for chaining
     */
    renderThumbnail: function() {
        var thumbnailUri = null;
        var properties = {
            width: 50,
            height: 50
        };
        if (this.model.isImage()) {
            thumbnailUri = this.model.thumbnailUri(properties);
        } else {
            thumbnailUri = this.model.thumbnailUri(properties);
        }

        var image = $('<img/>')
                        .attr('src', thumbnailUri)
                        .attr('title', this.model.get('name'));
        if (this.model.isImage()) {
            var anchor = $('<a/>')
                        .attr('href', '#preview')
                        .addClass('preview-file')
                        .html(image);
            this.getCellForColumn('id').html(anchor);
        } else {
            this.getCellForColumn('id').html(image);
        }

        return this;
    },

    /**
     * Render the ID cell, which contains the file controls.
     *
     * @return {FilesDataTableRow} the current instance for chaining
     */
    renderControls: function() {

        var buttonOptions = function(icon, label) {
            return {
                text: false,
                icons: {
                    primary: icon
                },
                label: label
            };
        };

        var row = this;
        var file = this.model;
        var controls = $(this.addon.getTemplate('datatables.row-controls')).appendTo('body');

        if (this.addon.hasInsertionCallback()) {
            controls.find('button[class$="insert"]')
                .button(buttonOptions('ui-icon-export', tr('Insert file')))
                .show();
        }

        this.showTagsButton = controls.find('button[class$="tags"]')
            .button(buttonOptions('ui-icon-tag', tr('Show Tags')))
            .button('option', 'disabled', !file.get('tags').length);

        controls.find('button[class$="download"]')
            .button(buttonOptions('ui-icon-arrowthickstop-1-s', tr('Download')));

        controls.find('button[class$="preview"]')
            .button(buttonOptions('ui-icon-search', tr('Preview image')))
            .show();

        controls.find('button[class$="delete"]')
            .button(buttonOptions('ui-icon-document-delete', tr('Delete file')));

        this.getCellForColumn('metadata').html(controls);
        return this;
    },

    /**
     * Render the name cell.
     *
     * @return {FilesDataTableRow} the current instance for chaining
     */
    renderName: function() {
        var name = $('<span/>')
                        .attr('title', this.model.get('name'))
                        .html(stringConstrain(this.model.get('name')));
        this.getCellForColumn('name').html(name);
        return this;
    },

    /**
     * Render the upload date cell.
     *
     * @return {FilesDataTableRow} the current instance for chaining
     */
    renderCreated: function() {
        this.getCellForColumn('created').html(this.model.formatCreated());
        return this;
    },

    /**
     * Perform actions required to make the tr represented by this view a drop
     * target for Tags.
     *
     * @return {DataTableRowView} The instance for chaining.
     */
    prepareTagDropTarget: function() {
        var view = this;
        var model = this.model;
        this.$el.droppable({
            accept: '.tag-draggable',
            hoverClass: 'ui-state-active',
            drop: function(event, ui) {
                var tagData = $(ui.draggable).attr('data-tag');
                if (typeof tagData === 'undefined') {
                    return;
                }
                model.addTag(new Tag(JSON.parse(tagData)));
            }
        });
        return this;
    },

    updateRowState: function() {
        this.showTagsButton.button('option', 'disabled', this.model.get('tags').length === 0);
    },

    /**
     * @return {Boolean} True if this row is selected
     */
    isSelected: function() {
        return this.options.selected;
    },

    /**
     * @param  {Boolean|null} silent If true, the 'select-file' event will not
     * be triggered.
     */
    select: function(silent) {
        this.options.selected = true;
        this.$el.addClass('ui-state-highlight');
        if (!silent) {
            this.addon.trigger('select-file', this.model);
        }
    },

    /**
     * Deselect this row. 'deselect-file' event is triggered on the parent addon.
     */
    deselect: function() {
        this.options.selected = false;
        this.$el.removeClass('ui-state-highlight');
        this.addon.trigger('deselect-file', this.model);
    },

    /**
     * Toggle selection state for this row.
     *
     * @return {DataTableRowView} The instance for chaining.
     */
    toggleSelection: function() {
        if (this.isSelected()) {
            this.deselect();
        } else {
            this.select();
        }
        return this;
    },

    /**
     * Prepare and return the shared tag menu.
     *
     * @return {jQuery} The shared tag menu.
     */
    getTagMenu: function() {
        if (DataTableRowView.tagMenu === false) {
            DataTableRowView.tagMenu = $(this.addon.getTemplate('datatables.row-tag-menu'))
                                            .appendTo('body')
                                            .hide()
                                            .menu();
        }
        return DataTableRowView.tagMenu;
    },

    /**
     * Create a tag menu item jQuery for the given Tag.
     *
     * @param {Tag} tag
     * @return {jQuery}
     */
    prepareTagMenuItem: function(tag) {

        var tagMenuItem = $(this.addon.getTemplate('datatables.row-tag-menu-item', tag.toJSON()));
        var view = this;
        tagMenuItem.find('button:first')
            .click(function() {
                if ($(this).hasClass('ui-state-highlight')) {
                    view.addon.fileManager.trigger('remove-tag-from-filter', tag);
                    $(this).removeClass('ui-state-highlight');
                } else {
                    view.addon.fileManager.trigger('add-tag-to-filter', tag);
                    $(this).addClass('ui-state-highlight');
                }
            })
            .button();
        tagMenuItem.find('button:last')
            .click(function() {
                view.removeTag(tag);
            })
            .button({
                text: false,
                icons: {
                    primary: 'ui-icon-delete'
                }
            });

        tagMenuItem.find('div').buttonset();
        return tagMenuItem;
    },

    /**
     * Show the tag menu.
     *
     * @param {Event} event
     */
    showTags: function(event) {
        event.stopPropagation();

        var tagMenu = this.getTagMenu()
            .html('');
        var view = this;
        this.model.get('tags').each(function(tag) {
            tagMenu.append(view.prepareTagMenuItem(tag));
        });

        tagMenu.show()
            .position({
                my: 'right top',
                at: 'right bottom',
                of: this.showTagsButton
            });

        this.showTagsButton.addClass('ui-state-highlight');

        /**
         * Close the menu when something else is clicked.
         *
         * @param {Event} event
         */
        $('body').bind('click.datatables-row', function(event) {
            if (!$(event.target).is('.menu-button, .delete-tag, .tag-filter')) {
                view.hideTags();
            }
        });
    },

    /**
     * Hide the tag menu, unbinding off-click event.
     */
    hideTags: function() {
        $('body').unbind('click.datatables-row');
        this.getTagMenu().hide().find('ul').html('');
        this.showTagsButton.removeClass('ui-state-highlight');
    },

    /**
     * Show preview dialog.
     * @todo Move logic into a view.
     */
    showPreview: function() {

        var showDialog = function(html) {
            var fileManager = this.fileManager;
            var file = this.model;
            var buttons = [
                {
                    text: tr('Download'),
                    'class': 'download',
                    click: function() {
                        window.location = file.downloadUri();
                    }
                },
                {
                    text: tr('Close'),
                    'class': 'close',
                    click: function() {
                        $(this).dialog('destroy');
                    }
                }
            ];
            if (this.model.isImage()) {
                buttons.unshift({
                    text: tr('Open in new tab'),
                    'class': 'new-tab',
                    click: function() {
                        window.open(file.publicUri());
                    }
                });
            }

            $(html).dialog({
                dialogClass: this.get('baseClass') + '-preview-file-dialog',
                resizable: false,
                height: 'auto',
                width: 400,
                modal: true,
                buttons: buttons,
                open: function() {
                    $(this).parent().find('button.close').button('option', 'icons', {
                        primary: 'ui-icon-circle-check'
                    });
                    $(this).parent().find('button.download').button('option', 'icons', {
                        primary: 'ui-icon-arrowthickstop-1-s'
                    });
                    $(this).parent().find('button.new-tab').button('option', 'icons', {
                        primary: 'ui-icon-search'
                    });
                }
            });
        }.bind(this);

        var html;
        if (this.model.isImage()) {
            var image = new Image();
            image.src = this.model.publicUri();
            var _this = this;
            image.onload = function() {
                html = _this.addon.getTemplate('datatables.preview-image-dialog', {
                    fileName: _this.model.get('name'),
                    thumbnailUri: _this.model.thumbnailUri({ height: 270, width: 370 }),
                    publicUri: _this.model.publicUri(),
                    uploaded: _this.model.formatCreated(),
                    size: (_this.model.get('size') / 1024 / 1024).toFixed(2),
                    type: _this.model.getType(),
                    width: this.naturalWidth,
                    height: this.naturalHeight
                });
                showDialog.call(_this, html);
            };
        } else {
            html = this.addon.getTemplate('datatables.preview-file-dialog', {
                fileName: this.model.get('name'),
                publicUri: this.model.publicUri(),
                uploaded: this.model.formatCreated(),
                size: (this.model.get('size') / 1024 / 1024).toFixed(2),
                type: this.model.getType()
            });
            showDialog(html);
        }
    },

    /**
     * Remove the given tag from the represented model. If successful and the model
     * had only one tag, hide the tag menu.
     *
     * @param {Tag} tag
     */
    removeTag: function(tag) {
        var view = this;
        this.model.removeTag(tag, {
            success: function() {
                if (view.model.get('tags').length === 0) {
                    view.hideTags();
                    view.showTagsButton.button('option', 'disabled', true);
                }
            }
        });
    }
}, {
    /** @type {mixed[]} Columns to be rendered. */
    columns: [
        { title: '', name: 'id' },    // Column used to display preview
        { title: 'Name', name: 'name' },
        { title: 'Uploaded', name: 'created' },
        { title: 'Controls', name: 'metadata' }
    ],

    /** @type {Boolean} The shared tag menu. */
    tagMenu: false
});
/**
 * @fileoverview Data Tables view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires jQuery UI
 * @requires Backbone
 * @requires Data Tables
 */

/**
 * @class A Backbone view wrapper for {@link DataTables}.
 * @augments AddonSubView
 * @link http://www.datatables.net/forums/discussion/comment/34249#Comment_34249
 */
DataTablesView = AddonSubView.extend({

    initialize: function(){
        AddonSubView.prototype.initialize.apply(this, arguments);

        this.filter = null;
        this.externalFilter = null;
        this.collectionUrl = null;
        this.rows = [];
        this.selectionView = null;

        // Cache the connection url
        this.collectionUrl = this.collection.url;

        // Invoke filter handler when param:change event is triggered
        this.on('param:change', this.filterHandler, this);

        this.addon.fileManager.on('refresh', this.refresh, this);
        this.addon.fileManager.on('file-uploaded', this.refresh, this);
        this.addon.on('deselect-all-files', this.deselectVisibleFiles, this);
    },

    render: function() {
        // Prepare data tables columns from collection's model.
        var mDataColumns = [];
        var columnTitles = [];

        var columns = DataTableRowView.columns;
        for (var columnIndex = 0; columnIndex < columns.length; columnIndex++) {
            mDataColumns.push({ mDataProp: columns[columnIndex].name });
            columnTitles.push(columns[columnIndex].title);
        }

        // Prepare table
        var table = $(this.addon.getTemplate('datatables.table'));

        for (var columnNameIndex = 0; columnNameIndex < columnTitles.length; columnNameIndex++) {
            table.find('thead tr').append('<th>' + stringHumanise(columnTitles[columnNameIndex]) + '</th>');
        }

        this.$el.html(table);

        var view = this;

        var selectionButton = '<"' + this.addon.get('baseClass') + '-selection-button">';
        var selectionNotification = '<"' + this.addon.get('baseClass') + '-selection-notification">';

        // Change table element into a DataTable
        this.dataTable = $(this.$el.find('table')).dataTable({
            aaSorting: [[ 3, "desc" ]],
            bProcessing: true,
            bServerSide: true,
            sPaginationType: 'full_numbers',
            aoColumns: mDataColumns,
            bJQueryUI: true,
            sDom: '<"H"<"' + this.addon.getBaseClass() + '-header-controls"' + selectionButton + 'lf>' + selectionNotification + 'r>t<"F"ip>',
            fnCreatedRow: function(nRow, aData, iDataIndex){
                // Create a view for the row
                view.rows.push(new DataTableRowView({
                    id: aData.id,
                    el: nRow,
                    addon: view.addon,
                    model: view.collection.get(aData.id),
                    selected: view.addon.fileManager.isFileSelected(aData.id),
                    baseClass: view.addon.get('baseClass')
                }));
            },
            fnRowCallback: function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                view.rows[iDisplayIndex].render();
                view.addon.trigger('data-refreshed');
            },

            /**
             * Add external filter parameters to the request
             * @param {mixed[]} aoData
             */
            fnServerParams: function(aoData) {
                for (var name in view.externalFilter) {
                    aoData.push({ 'name': name, 'value': view.externalFilter[name] });
                }
                aoData.push({ 'name': 'datatables', 'value': true });
            },
            fnServerData: function(sSource, aoData, fnCallback, settings) {
                // Function used to populate the DataTable with the current
                // content of the collection
                var populateTable = function() {

                    view.rows = [];

                    return fnCallback({
                        sEcho: aoData.sEcho,
                        iTotalRecords: view.collection.meta('totalSize'),
                        iTotalDisplayRecords: view.collection.meta('filteredSize'),
                        aaData: view.collection.toJSON()
                    });
                };

                if (!objectCompare(aoData, view.filter)) {
                    view.filterHandler(aoData, populateTable);
                } else {
                    populateTable();
                }
            },

            /**
             * Initialse sub views.
             *
             * @param  {Object} oSettings
             * @param  {Object} json
             */
            fnInitComplete: function(oSettings, json) {
                view.selectionView = new SelectionButtonView({
                        el: view.$el.find('.' + view.addon.getBaseClass() + '-selection-button'),
                        collection: view.addon.fileManager.getSelectedFiles(),
                        html: view.addon.getTemplate('datatables.selection-button', {
                            'baseClass': view.addon.getBaseClass()
                        }),
                        addon: view.addon
                    })
                    .render();

                view.notificationView = new NotificationView({
                        collection: view.addon.fileManager.getSelectedFiles(),
                        el: view.$el.find('.' + view.addon.getBaseClass() + '-selection-notification'),
                        html: view.addon.getTemplate('datatables.selection-notification'),
                        addon: view.addon
                    });
            }
        });
        return this;
    },

    /**
     * Update the represented collection's URL with the DataTables query
     * parameters, perform a fetch, passing the given callback as the success
     * function.
     *
     * @param {mixed[]} filter The filter.
     * @param {Function} callback
     */
    filterHandler: function(filter, callback) {
        this.filter = filter;
        this.collection.url = this.collectionUrl + '?' + $.param(this.filter);

        this.collection.fetch({
            success: callback
        });
    },

    /**
     * Select the visible rows.
     */
    selectVisibleFiles: function() {
        for (var rowIndex = 0; rowIndex < this.rows.length; rowIndex++) {
            this.rows[rowIndex].select();
        }
    },

    /**
     * Deselect the visible rows.
     */
    deselectVisibleFiles: function() {
        for (var rowIndex = 0; rowIndex < this.rows.length; rowIndex++) {
            this.rows[rowIndex].deselect();
        }
    },

    /**
     * @return {Boolean} True if all visible files are selected.
     */
    allVisibleFilesSelected: function() {
        for (var rowIndex = 0; rowIndex < this.rows.length; rowIndex++) {
            if (!this.rows[rowIndex].isSelected()) {
                return false;
            }
        }
        return true;
    },

    /**
     * @return {Integer} The total files on the server.
     */
    getTotalFiles: function() {
        return this.collection.meta('totalSize');
    },

    /**
     * Refresh data from server.
     */
    refresh: function() {
        this.externalFilter = this.addon.fileManager.getFilter();
        this.dataTable.dataTable().fnDraw();
    }
});
/**
 * @fileoverview Data Tables selection notification view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class The notification view class.
 * @augments AddonSubView
 */
var NotificationView = AddonSubView.extend({

    options: {
        html: null
    },

    /** @type {jQuery} */
    messageArea: null,

    events: {
        'click .select-all': function(event) {
            event.preventDefault();
            this.addon.trigger('select-all-files');
            this.render();
        }
    },

    initialize: function() {
        AddonSubView.prototype.initialize.apply(this, arguments);
        this.collection.on('add remove reset', this.render, this);
        this.addon.on('data-refreshed', this.render, this);
    },

    render: function() {
        if (this.messageArea === null) {
            this.$el.html(this.get('html'));
            this.messageArea = this.$('.selection-notification-message');
            $(this.$el).hide();
        }

        if (!this.addon.getTotalSelectedFiles()) {
            $(this.$el).slideUp();
            return;
        }
        this.messageArea.html(this.getMessage());
        this.$el.slideDown();
        return this;
    },

    getMessage: function() {
        var addon = this.addon;

        if (addon.getTotalSelectedFiles() === 1) {
            return tr('{{totalSelection}} file selected', {
                totalSelection: addon.getTotalSelectedFiles()
            });
        }
        if (addon.allFilesSelected()) {
            return addon.getTemplate('datatables.selected-all-on-page', {
                totalFiles: addon.getTotalFiles()
            });
        }
        if (addon.allVisibleFilesSelected()) {
            return addon.getTemplate('datatables.select-all', {
                totalSelected: addon.getTotalSelectedFiles(),
                totalFiles: addon.getTotalFiles()
            });
        }
        return tr('{{totalSelection}} files selected', {
            totalSelection: addon.getTotalSelectedFiles()
        });
    }
}, { });
/**
 * @fileoverview Data Tables selection checkbox view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class The selection button view class.
 * @augments Backbone.View
 */
SelectionButtonView = Backbone.View.extend({

    defaults: {
        addon: null,
        html: null,
        baseClass: null
    },

    /** @type {jQuery} */
    selectionButton: null,

    /** @type {String} */
    state: false,

    /** @type {String} */
    STATE_ALL_VISIBLE_SELECTED: 'all-visible',
    /** @type {String} */
    STATE_SOME_SELECTED: 'some',
    /** @type {String} */
    STATE_NONE_SELECTED: 'none',

    events: {
        'click .selection': function(event) {
            switch (this.getState()) {
                case this.STATE_ALL_VISIBLE_SELECTED:
                case this.STATE_SOME_SELECTED:
                    this.options.addon.trigger('deselect-all-files');
                    // @todo investigate why collection.reset(), called in
                    // DataTablesAddon.deselectAllFiles does not trigger 'reset'
                    // if the event is triggered, the following line is unecessary
                    this.render();
                    break;
                case this.STATE_NONE_SELECTED:
                    this.options.addon.trigger('select-visible-files');
                    break;
            }
        }
    },

    initialize: function() {
        this.collection.on('add remove reset', this.render, this);
        this.options.addon.on('data-refreshed', this.render, this);
    },

    /**
     * @return {String} Final section of button icon class.
     */
    getCurrentIcon: function() {
        switch (this.state) {
            case this.STATE_ALL_VISIBLE_SELECTED:
                return 'check-all';
            case this.STATE_SOME_SELECTED:
                return 'check-some';
            case this.STATE_NONE_SELECTED:
                return 'check-box';
        }
    },

    /**
     * @return {String} Title relevant to the current state.
     */
    getCurrentTitle: function() {
        switch (this.state) {
            case this.STATE_ALL_VISIBLE_SELECTED:
            case this.STATE_SOME_SELECTED:
                return tr('Click to clear current selection');
            case this.STATE_NONE_SELECTED:
                return tr('Click to select all visible files');
        }
    },

    /**
     * @return {String} The current state inferred from current selection.
     */
    getState: function() {
        if (this.options.addon.allVisibleFilesSelected()) {
            return this.STATE_ALL_VISIBLE_SELECTED;
        }
        if (this.options.addon.getTotalSelectedFiles()) {
            return this.STATE_SOME_SELECTED;
        }
        return this.STATE_NONE_SELECTED;
    },

    render: function() {

        if (this.selectionButton === null) {
            this.$el.html(this.options.html);
            this.selectionButton = this.$('.' + this.options.addon.getBaseClass() + '-select-all')
                .button({ text: false });
        }

        this.state = this.getState();
        this.selectionButton.button('option', 'icons', {
                primary: 'ui-icon-' + this.getCurrentIcon()
            })
            .button('option', 'label', this.getCurrentTitle());
    }

}, { });
/*
 * @fileOverview Plupload addon
 * @author David Neilsen david@panmedia.co.nz
 * @author Michael Robinson michael@panmedia.co.nz
 */

/**
 * @name Pluploader
 * @augments Addon
 * @lends Plugin.prototype
 * @class Adds a plupload uploading tab to the top tab panel.
 */
FileManager.registerAddon('plupload', Addon.extend({

    options: {
        label: tr('Upload'),
        tab: FileManager.TAB_TOP,
        pluploadOptions: {
            runtimes: 'html5,html4',
            max_file_size: '20mb',
            chunk_size: '1mb',
            unique_names: false,
            autostart: true,
            button_browse_hover: true,
            multipart: true,
            filters: [
                {
                    title: tr('Image files'),
                    extensions: 'jpg,jpeg,gif,png'
                },
                {
                    title: tr('Archive files'),
                    extensions: 'zip,rar,tar,tar.gz,gz'
                },
                {
                    title: tr('Document files'),
                    extensions: 'pdf,doc,docx,odf'
                },
                {
                    title: tr('Spreadsheet files'),
                    extensions: 'xls,xlsx,ods,csv'
                }
            ]
        }
    },

    initialize: function() {
        Addon.prototype.initialize.apply(this, arguments);

        this.plupload = null;
        this.container = null;
        this.dropZone = null;
        this.fileList = null;
        this.uploadButton = null;
        this.uploadProgress = null;

        // <strict>
        if (typeof plupload === 'undefined') {
            handleError(tr('FileManager Plupload addon requires Plupload.'));
            return;
        }
        // </strict>
    },

    getUrl: function() {
        return (new Files()).url;
    },

    pluploadCoreOptions: function() {
        var fileManager = this.fileManager;
        var trigger = function (event, data) {
            fileManager.trigger(event, data);
        };

        return {
            init: {
                Refresh: function(up) {
                    trigger('refresh', { uploader: up });
                },

                StateChanged: function(up) {
                    trigger('state-changed', { uploader: up });
                },

                QueueChanged: function(up) {
                    trigger('queue-changed', { uploader: up });
                },

                UploadFile: function(up, file) {
                    trigger('upload-file', { uploader: up, file: file });
                },

                UploadProgress: function(up, file) {
                    trigger('upload-progress', { uploader: up, file: file });
                },

                UploadComplete: function(up, files) {
                    trigger('upload-complete', { uploader: up, files: files });
                },

                FilesAdded: function(up, files) {
                    trigger('files-added', { uploader: up, files: files });
                },

                FilesRemoved: function(up, files) {
                    trigger('files-removed', { uploader: up, files: files });
                },

                FileUploaded: function(up, file, info) {
                    trigger('file-uploaded', { uploader: up, file: file, info: info });
                },

                ChunkUploaded: function(up, file, info) {
                    trigger('chunk-uploaded', { uploader: up, file: file, info: info });
                },

                Error: function(up, args) {
                    trigger('error', { uploader: up, args: args });
                }
            }
        };
    },

    render: function(event) {
        // <strict>
        if (this.$el.html() !== '') {
            handleError('Render may be called once only per instance');
            return;
        }
        // </strict>

        this.$el = this.fileManager.addToTab(this, this.get('tab'));
        this.$el.html(this.getTemplate('plupload.structure'));

        // Prepare relevant elements
        var uid = $.proxy(this.getUniqueId, this);
        this.container = this.$('.' + this.get('baseClass') + '-container').attr('id', uid());
        this.dropZone = this.$('.' + this.get('baseClass') + '-drop-zone').attr('id', uid());
        this.uploading = this.$('.' + this.get('baseClass') + '-uploading');
        this.uploadProgress = this.uploading.find('.' + this.get('baseClass') + '-upload-total-progress > span');
        this.fileList = this.$('.' + this.get('baseClass') + '-file-list').attr('id', uid());

        var selectFilesButton = this.$('.' + this.get('baseClass') + '-select')
            .attr('id', uid())
            .button({
                icons: {
                    primary: 'ui-icon-circle-plus'
                }
            });

        var dynamicOptions = {
            container: this.container.attr('id'),
            drop_element: this.dropZone.attr('id'),
            browse_button: selectFilesButton.attr('id'),
            url: this.getUrl()
        };

        var pluploadOptions = $.extend(true, {}, this.get('pluploadOptions'), this.pluploadCoreOptions(), dynamicOptions);

        this.plupload = new plupload.Uploader(pluploadOptions);

        this.bindDropZone();
        this.bindUploadButton();
        this.bindFilesAdded();
        this.bindFilesRemoved();

        this.bindStateChange();

        this.bindUploadStart();
        this.bindUploadFileBeforeStart();
        this.bindUploadProgress();
        this.bindFileUpload();
        this.bindUploadComplete();

        this.bindErrors();

        this.plupload.init();

        this.plupload.refresh();

        // Chrome hack to ensure user can actually click the 'select files' button
        // $('#' + selectFilesButton.attr('id') + ', .plupload').mouseenter(function() {
        //     $('.plupload.html5').css({
        //         zIndex: 99999
        //     }).find('input').css({
        //         zIndex: 99999
        //     });
        //     $('.plupload, .plupload.html5').unbind('mouseenter').mouseenter(function() {
        //         $(selectFilesButton).addClass('ui-state-hover');
        //         $(this).css({ cursor: 'pointer' });
        //     }).mouseout(function() {
        //         $(selectFilesButton).removeClass('ui-state-hover');
        //     });
        // });
    },

    bindFilesAdded: function() {
        var addon = this;

        this.plupload.bind('FilesAdded', function(uploader, files) {
            for (var filesIndex = 0; filesIndex < files.length; filesIndex++) {
                addon.fileList.append(addon.getTemplate('plupload.file-list-item', {
                    fileId: files[filesIndex].id,
                    fileName: files[filesIndex].name,
                    fileSize: plupload.formatSize(files[filesIndex].size)
                }));
            }

            addon.fileList.find('.' + addon.get('baseClass') + '-file-remove')
                .button({
                    text: false,
                    icons: {
                        primary: 'ui-icon-circle-close'
                    }
                })
                .unbind('click')
                .bind('click', function(event) {
                    event.preventDefault();
                    var fileId = $(this).closest('.' + addon.get('baseClass') + '-file-list-item').data('file_id');
                    plugin.removeFile(fileId);
                });

            uploader.refresh();

            addon.uploadButton.button('option', 'disabled', false);

            if (addon.get('autostart')) {
                uploader.start();
            }
        });
    },

    bindFilesRemoved: function() {
        var plugin = this;
        this.plupload.bind('FilesRemoved', function(uploader, files) {
            for (var filesIndex = 0; filesIndex < files.length; filesIndex++) {
                plugin.removeFile(files[filesIndex].id);
            }
        });
    },

    bindUploadButton: function() {
        var addon = this;
        this.uploadButton = this.$('.' + this.get('baseClass') + '-upload');

        this.uploadButton.button({
                icons: {
                    primary: 'ui-icon-circle-arrow-e'
                }
            })
            .click(function(event) {
                event.preventDefault();
                addon.plupload.start();
            });
        this.uploadButton.button('option', 'disabled', true);
    },

    bindDropZone: function() {
        // Make drop zone respond visually
        this.dropZone.bind('dragover', function(event) {
            event.preventDefault();
            $(this).addClass('ui-state-highlight');
        }).bind('dragexit drop', function(event) {
            event.preventDefault();
            $(this).removeClass('ui-state-highlight');
        });
    },

    bindStateChange: function() {
        var plugin = this;
        this.plupload.bind('StateChanged', function(uploader) {
            var state;
            switch (uploader.state) {
                case plupload.QUEUED:
                    window.setTimeout((function() {
                        plugin.enableDropZone();
                        plugin.clearFileList(plugin.get('baseClass') + '-file-success');
                        plugin.resetUploadProgress();
                    }), 2000);
                    plugin.uploadButton.button('option', 'disabled', true);
                    break;

                case plupload.UPLOADING:
                    plugin.enableUploadingFeedback();
                    break;

                case plupload.FAILED:
                    break;

                case plupload.DONE:
                    break;
            }
        });
    },

    bindUploadFileBeforeStart: function() {
        this.plupload.bind('BeforeUpload', function (uploader, file) {
            // @todo add tags here
            // uploader.settings.multipart_params.additionalParam = { hat: "car" };
        });
    },

    bindUploadStart: function() {
        var plugin = this;
        this.plupload.bind('UploadFile', function() {
            // console.log('upload start');
        });
    },

    bindUploadProgress: function() {
        var plugin = this;
        this.plupload.bind('UploadProgress', function(uploader, file) {
            var progressIndicator = plugin.getFileListItem(file.id);
            progressIndicator = progressIndicator.find('.' + plugin.get('baseClass') + '-file-upload-progress > span');

            progressIndicator
                .css({ width: file.percent + '%' })
                .show();
            progressIndicator.addClass(plugin.get('baseClass') + '-file-uploading');
            plugin.updateTotalProgress(uploader);
        });
    },

    bindFileUpload: function() {
        var plugin = this;
        this.plupload.bind('FileUploaded', function(up, file, info) {
            var response = $.parseJSON(info.response);
            if (response.error) {
                plugin.updateFileListItem(file.id, 'ui-state-error', response.error.message);
            } else {
                plugin.fileManager.refresh(true);
                plugin.updateFileListItem(file.id, plugin.get('baseClass') + '-file-success');
            }
        });
    },

    bindUploadComplete: function() { },

    bindErrors: function() {
        // Add errors to file list items the error is related to
        var plugin = this;
        this.plupload.bind('Error', function(uploader, error) {
            plugin.updateFileListItem(error.file.id, 'ui-state-error', error.message);
        });
    },

    enableDropZone: function() {
        this.uploading.hide();
        this.dropZone.show();
    },

    enableUploadingFeedback: function() {
        this.dropZone.hide();
        this.uploading.show();
    },

    updateTotalProgress: function(uploader) {
        this.uploadProgress.css({
            width: uploader.total.percent + '%'
        });
    },

    resetUploadProgress: function() {
        this.uploadProgress.css({
            width: '0%'
        });
    },

    clearFileList: function(withClass) {
        var plugin = this;
        $('.' + this.get('baseClass') + '-file-list-item').each(function() {
            if (withClass && !$(this).hasClass(withClass)) {
                return;
            }
            plugin.removeFile($(this).data('file_id'));
        });
    },

    getFileListItem: function(fileId) {
        return this.fileList.find('#' + this.get('baseClass') + '-file-' + fileId);
    },

    updateFileListItem: function(fileId, addClass, message) {
        var fileListItem = this.getFileListItem(fileId);
        fileListItem.removeClass('ui-state-active ui-state-highlight ui-state-default ui-state-error ' + this.get('baseClass') + '-file-uploading');
        fileListItem.addClass(addClass);
        if (typeof message === 'undefined') {
            message = '';
        }
        // if (message) {
            fileListItem.find('.' + this.get('baseClass') + '-file-message')
                .html(message)
                .show();
        // }
    },

    removeFile: function(fileId) {
        var file = this.plupload.getFile(fileId);
        if (typeof file !== 'undefined') {
            this.plupload.removeFile(file);
        } else {
            this.getFileListItem(fileId).slideUp(function() {
                $(this).remove();
            });
        }
    }

},
{
    FAILED_OPENING_TEMP: 100,
    FAILED_INPUT_STREAM: 101,
    FAILED_OUTPUT_STREAM: 102,
    FAILED_MOVE_FILE: 103,
    FAILED_OPENING_TEMP_FILE: 104,
    FAILED_CREATING_UPLOAD_DIR: 105
}));
/**
 * @fileOverview Tags plugin
 * @author Michael Robinson michael@panmedia.co.nz
 * @author David Neilsen david@panmedia.co.nz
 */

/**
 * @name FileManager.tags
 * @lends Plugin.prototype
 * @class Tags Plugin
 * @augments Addon
 */
FileManager.registerAddon('tagsidebar', Addon.extend({

    options: {
        label: tr('Tags'),
        tab: FileManager.TAB_LEFT
    },

    initialize: function() {
        Addon.prototype.initialize.apply(this, arguments);

        this.tags = null;

        this.tagsView = null;
        this.tagControlsView = null;
        this.typeFilterView = null;

        this.on('type-filter-changed', this.typeFilterChanged, this);
        this.on('create-tag', this.createTag, this);
    },

    /**
     * Render the tag sidebar panel.
     */
    render: function() {
        // <strict>
        if (this.$el.html() !== '') {
            handleError('Render may be called once only per instance');
            return;
        }
        // </strict>

        this.$el = this.fileManager.addToTab(this, this.get('tab'))
                        .html(this.getTemplate('tagsidebar.container'))
                        .addClass(this.get('baseClass'));

        this.typeFilterView = new TypeFilterView({
                el: this.$('.' + this.get('baseClass') + '-file-types-wrapper'),
                addon: this
            })
            .render();

        this.tagControlsView = new TagControlsView({
                el: this.$('.' + this.get('baseClass') + '-tag-controls'),
                createTag: $.proxy(this.createTag, this)
            })
            .render();

        this.tags = new Tags();
        var addon = this;
        var tagsView = this.tagsView = new TagsView({
                el: this.$('.' + this.get('baseClass') + '-tags-wrapper'),
                collection: this.tags,
                baseClass: this.getBaseClass(),
                tagHtml: function(tagName) {
                    return addon.getTemplate('tagsidebar.tag', { tagName: tagName });
                },
                menuHtml: $.proxy(addon.getTemplate, addon, 'tagsidebar.tagmenu'),
                addon: this
            });
        this.tags.fetch({
            success: $.proxy(tagsView.render, tagsView)
        });
    },

    /**
     * Triggered when a type-filter button is clicked.
     *
     * @param {string} selectedType
     */
    typeFilterChanged: function(selectedType) {
        this.fileManager.addFilter({
            'fileType': selectedType
        });
    },

    /**
     * Display a dialog, create tag.
     */
    createTag: function() {
        var addon = this;
        $(this.getTemplate('tagsidebar.create-tag')).dialog({
            dialogClass: this.get('baseClass') + '-create-tag-dialog',
            resizable: false,
            height: 'auto',
            modal: true,
            buttons: [
                {
                    text: tr('Create tag'),
                    click: function() {
                        $(this).parent().find('button:first').button('option', 'icons', {
                            primary: 'ui-icon-loading'
                        });
                        var tag = new Tag();
                        var dialog = this;
                        tag.save({
                                name: $(this).find('input[name="new-tag-name"]').val()
                            },
                            {
                                wait: true,
                                success: function() {
                                    addon.tagsView.addTag(tag);
                                    $(dialog).dialog('destroy');
                                },
                                error: function() {
                                    console.log(arguments);
                                }
                        });
                    }
                },
                {
                    text: tr('Cancel'),
                    click: function() {
                        $(this).dialog('destroy');
                    }
                }
            ],
            open: function() {
                $(this).parent().find('button:first').button('option', 'icons', {
                        primary: 'ui-icon-circle-check'
                    })
                    .next()
                    .button('option', 'icons', {
                        primary: 'ui-icon-circle-close'
                    });
            }
        });
    }
}));
/**
 * @fileoverview Tag controls view class code.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 * @version 0.1
 * @requires jQuery
 * @requires jQuery UI
 * @requires Backbone
 */

/**
 * @class Tag controls view class.
 * @augments Backbone.View
 */
TagControlsView = Backbone.View.extend({

    options: {
        createTag: null
    },

    events: {
        'click .create-tag': function() {
            this.options.createTag();
        }
    },

    render: function() {
        this.$('.create-tag').button({
            icons: {
                primary: 'ui-icon-circle-plus'
            }
        });
    }

}, { });
/**
 * @fileoverview Tag view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class Tag view class.
 */
TagView = Backbone.View.extend({

    options: {
        baseClass: null,
        menuHtml: null,
        addon: null
    },

    events: {
        'click .menu-button': 'showMenu',

        /**
         * When button is clicked, toggle highlight state & trigger the
         * appropriate add / remove tag event.
         *
         * @param {Event} event
         */
        'click .tag-button': function(event) {
            if (this.$el.hasClass('ui-draggable-dragging')) {
                return;
            }
            if (this.getTagButton().hasClass('ui-state-highlight')) {
                this.options.addon.fileManager.trigger('remove-tag-from-filter', this.model);
                this.getTagButton().removeClass('ui-state-highlight');
            } else {
                this.options.addon.fileManager.trigger('add-tag-to-filter', this.model);
                this.getTagButton().addClass('ui-state-highlight');
            }
        }
    },

    initialize: function() {
        this.tagButton = false;
        this.menuButton = false;
    },

    /**
     * Prepare the menu button & wrapping button set. Make the button set
     * draggable with the tag button as the handle.
     */
    render: function() {
        this.menuButton = this.$('.' + this.options.baseClass + '-menu-button')
            .button({
                text: false,
                icons: {
                    primary: 'ui-icon-triangle-1-s'
                }
            });

        this.buttonWrapper = this.menuButton.parent()
                                .buttonset();

        var $el = this.$el;
        $el.attr('data-tag', JSON.stringify(this.model));
        this.buttonWrapper.draggable({
            handle: 'button.' + this.options.baseClass + '-tag-button',
            revert: true,
            cancel: ''
        });
    },

    /**
     * Show the tag's menu, ensuring that off-clicks hide the menu appropriately.
     */
    showMenu: function() {
        var menu = this.getMenu()
            .show()
            .position({
                my: 'left top',
                at: 'left bottom',
                of: this.menuButton
            });

        var model = this.model;
        var view = this;
        menu.find('.delete-tag').bind('click.tagsidebar', function(event) {
            event.preventDefault();
            view.hideMenu();
            model.destroy({
                success: $.proxy(view.remove, view)
            });
        });

        menu.find('.apply-to-selection').bind('click.tagsidebar', function(event) {
            event.preventDefault();
            view.hideMenu();
            var files = view.options.addon.fileManager.getSelectedFiles();
            if (files instanceof Files) {
                files.addTag(view.model);
            }
        });

        /**
         * Close the menu when something else is clicked.
         *
         * @param {Event} event
         */
        $('body').one('click.tagsidebar', function(event) {
            if (!$(event.target).hasClass('menu-button') &&
                !$(event.target).hasClass('delete-tag')) {
                view.hideMenu();
            }
        });
    },

    /**
     * Hide the menu and unbind the off-click event.
     */
    hideMenu: function() {
        this.getMenu().find('.delete-tag').unbind('click.tagsidebar');
        $('body').unbind('click.tagsidebar');
        this.getMenu().hide();
    },

    /**
     * @return {jQuery} The shared menu jQuery.
     */
    getMenu: function() {
        if (TagView.menu === false) {
            TagView.menu = $(this.options.menuHtml()).appendTo('body')
                .hide()
                .menu();
        }
        return TagView.menu;
    },

    /**
     * @return {jQuery} The tag button.
     */
    getTagButton: function() {
        if (!this.tagButton) {
            this.tagButton = this.$('.' + this.options.baseClass + '-tag-button');
        }
        return this.tagButton;
    }

}, {
    /**
     * @type {jQuery} The shared menu.
     */
    menu: false
});
/**
 * @fileoverview Tags view class.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class Tags view class.
 * @augments Backbone.View
 */
TagsView = Backbone.View.extend({

    options: {
        baseClass: null,
        tagHtml: null,
        menutHtml:null,
        addToFilter: null,
        removeFromFilter: null,
        addon: null
    },

    /**
     * Create a TagView for the given tag, add it to this view's element.
     *
     * @param {Tag} tag
     */
    addTag: function(tag) {
        var tagView = new TagView({
            baseClass: this.options.baseClass,
            model: tag,
            el: this.options.tagHtml(tag.get('name')),
            addon: this.options.addon,
            menuHtml: this.options.menuHtml
        });
        this.$el.append(tagView.el);
        tagView.render();
        this.on('remove', tagView.remove);
    },

    /**
     * Add all tags in the represented collection.
     */
    render: function() {
        this.collection.each(this.addTag, this);
    }
});

/**
 * @fileoverview Type filter view class code.
 * @author Michael Robinson - michael@panmedia.co.nz
 * @author David Neilsen - david@panmedia.co.nz
 */

/**
 * @class Type filter view class.
 * @augments AddonSubView
 */
var TypeFilterView = AddonSubView.extend({

    events: {
        'change [type="radio"]': function(event) {
            this.addon.trigger('type-filter-changed', $(event.target).val());
        }
    },

    render: function() {
        var _this = this;
        this.$('input').each(function() {
            this.id = _this.addon.fileManager.getUniqueId() + this.id;
            $(this).next().attr('for', this.id);
        });
        this.$el.buttonset();
    }
});
})(jQuery, window);jQuery('<style type="text/css">/* Non styles */\n\
/**\n\
 * Style global variables\n\
 *\n\
 * @author David Neilsen <david@panmedia.co.nz>\n\
 */\n\
/* Theme states & mixins */\n\
.ui-filemanager-datatables-table td, .ui-filemanager-datatables-table tr:hover td, .ui-filemanager-panels-wrap, .ui-filemanager-datatables-table .xmod-datatable-sorting-1, .ui-filemanager-datatables-table .sorting_1, .ui-filemanager-datatables-table tr:hover .sorting_1, .ui-filemanager-datatables-table tr:hover .xmod-datatable-sorting-1 {\n\
  color: #333333;\n\
  border: 1px solid lightgrey;\n\
  text-shadow: rgba(255, 255, 255, 0.85) 0 1px 0px; }\n\
\n\
.ui-filemanager-datatables-table td {\n\
  background: #f4f4f4 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2VhZWFlYSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #f4f4f4 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #ffffff), color-stop(100%, #eaeaea));\n\
  background: #f4f4f4 -webkit-linear-gradient(top, #ffffff, #eaeaea);\n\
  background: #f4f4f4 -moz-linear-gradient(top, #ffffff, #eaeaea);\n\
  background: #f4f4f4 -o-linear-gradient(top, #ffffff, #eaeaea);\n\
  background: #f4f4f4 -ms-linear-gradient(top, #ffffff, #eaeaea);\n\
  background: #f4f4f4 linear-gradient(top, #ffffff, #eaeaea);\n\
  background-color: #f4f4f4;\n\
  -webkit-box-shadow: 0 0 0px 1px white inset;\n\
  -moz-box-shadow: 0 0 0px 1px white inset;\n\
  box-shadow: 0 0 0px 1px white inset; }\n\
\n\
.ui-filemanager-datatables-table tr:hover td {\n\
  background: #f4f4f4 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2VhZWFlYSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2ZmZmZmZiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #f4f4f4 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #eaeaea), color-stop(100%, #ffffff));\n\
  background: #f4f4f4 -webkit-linear-gradient(top, #eaeaea, #ffffff);\n\
  background: #f4f4f4 -moz-linear-gradient(top, #eaeaea, #ffffff);\n\
  background: #f4f4f4 -o-linear-gradient(top, #eaeaea, #ffffff);\n\
  background: #f4f4f4 -ms-linear-gradient(top, #eaeaea, #ffffff);\n\
  background: #f4f4f4 linear-gradient(top, #eaeaea, #ffffff);\n\
  background-color: #f4f4f4;\n\
  -webkit-box-shadow: 0 0 0px 1px white inset;\n\
  -moz-box-shadow: 0 0 0px 1px white inset;\n\
  box-shadow: 0 0 0px 1px white inset; }\n\
\n\
.ui-filemanager-panels-wrap, .ui-filemanager-datatables-table .xmod-datatable-sorting-1, .ui-filemanager-datatables-table .sorting_1 {\n\
  background: #e2e2e2 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2VkZWRlZCIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2Q4ZDhkOCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #e2e2e2 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #ededed), color-stop(100%, #d8d8d8));\n\
  background: #e2e2e2 -webkit-linear-gradient(top, #ededed, #d8d8d8);\n\
  background: #e2e2e2 -moz-linear-gradient(top, #ededed, #d8d8d8);\n\
  background: #e2e2e2 -o-linear-gradient(top, #ededed, #d8d8d8);\n\
  background: #e2e2e2 -ms-linear-gradient(top, #ededed, #d8d8d8);\n\
  background: #e2e2e2 linear-gradient(top, #ededed, #d8d8d8);\n\
  background-color: #e2e2e2;\n\
  -webkit-box-shadow: 0 0 0px 1px #ededed inset;\n\
  -moz-box-shadow: 0 0 0px 1px #ededed inset;\n\
  box-shadow: 0 0 0px 1px #ededed inset; }\n\
\n\
.ui-filemanager-datatables-table tr:hover .sorting_1, .ui-filemanager-datatables-table tr:hover .xmod-datatable-sorting-1 {\n\
  background: #e2e2e2 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2Q4ZDhkOCIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2VkZWRlZCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #e2e2e2 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #d8d8d8), color-stop(100%, #ededed));\n\
  background: #e2e2e2 -webkit-linear-gradient(top, #d8d8d8, #ededed);\n\
  background: #e2e2e2 -moz-linear-gradient(top, #d8d8d8, #ededed);\n\
  background: #e2e2e2 -o-linear-gradient(top, #d8d8d8, #ededed);\n\
  background: #e2e2e2 -ms-linear-gradient(top, #d8d8d8, #ededed);\n\
  background: #e2e2e2 linear-gradient(top, #d8d8d8, #ededed);\n\
  background-color: #e2e2e2;\n\
  -webkit-box-shadow: 0 0 0px 1px #ededed inset;\n\
  -moz-box-shadow: 0 0 0px 1px #ededed inset;\n\
  box-shadow: 0 0 0px 1px #ededed inset; }\n\
\n\
.ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-plupload-controls .ui-button, .ui-filemanager-tagsidebar-tag-controls .ui-button, .ui-filemanager-datatables-table .ui-toolbar, .ui-filemanager-datatables-table .ui-toolbar .ui-button, .ui-filemanager-plupload-container .ui-filemanager-plupload-drop-zone,\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-uploading, .ui-filemanager-datatables-table .dataTable, .ui-filemanager-datatables-table .xmod-datatable {\n\
  color: white;\n\
  border: 1px solid #161617;\n\
  text-shadow: #323334 0 1px 0px; }\n\
\n\
.ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-plupload-controls .ui-button, .ui-filemanager-tagsidebar-tag-controls .ui-button, .ui-filemanager-datatables-table .ui-toolbar {\n\
  background: #363a3d url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzQzNDc0YiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzJhMmQyZiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #363a3d -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #43474b), color-stop(100%, #2a2d2f));\n\
  background: #363a3d -webkit-linear-gradient(top, #43474b, #2a2d2f);\n\
  background: #363a3d -moz-linear-gradient(top, #43474b, #2a2d2f);\n\
  background: #363a3d -o-linear-gradient(top, #43474b, #2a2d2f);\n\
  background: #363a3d -ms-linear-gradient(top, #43474b, #2a2d2f);\n\
  background: #363a3d linear-gradient(top, #43474b, #2a2d2f);\n\
  background-color: #363a3d;\n\
  -webkit-box-shadow: 0 0 0px 1px #43474b inset;\n\
  -moz-box-shadow: 0 0 0px 1px #43474b inset;\n\
  box-shadow: 0 0 0px 1px #43474b inset; }\n\
\n\
.ui-filemanager-datatables-table .ui-toolbar .ui-button, .ui-filemanager-plupload-container .ui-filemanager-plupload-drop-zone,\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-uploading {\n\
  background: #25282a url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzMyMzYzOSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzE5MWIxYyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #25282a -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #323639), color-stop(100%, #191b1c));\n\
  background: #25282a -webkit-linear-gradient(top, #323639, #191b1c);\n\
  background: #25282a -moz-linear-gradient(top, #323639, #191b1c);\n\
  background: #25282a -o-linear-gradient(top, #323639, #191b1c);\n\
  background: #25282a -ms-linear-gradient(top, #323639, #191b1c);\n\
  background: #25282a linear-gradient(top, #323639, #191b1c);\n\
  background-color: #25282a;\n\
  -webkit-box-shadow: 0 0 0px 1px #323639 inset;\n\
  -moz-box-shadow: 0 0 0px 1px #323639 inset;\n\
  box-shadow: 0 0 0px 1px #323639 inset; }\n\
\n\
.ui-filemanager-datatables-table .dataTable, .ui-filemanager-datatables-table .xmod-datatable {\n\
  background: #25282a url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzE5MWIxYyIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzMyMzYzOSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #25282a -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #191b1c), color-stop(100%, #323639));\n\
  background: #25282a -webkit-linear-gradient(top, #191b1c, #323639);\n\
  background: #25282a -moz-linear-gradient(top, #191b1c, #323639);\n\
  background: #25282a -o-linear-gradient(top, #191b1c, #323639);\n\
  background: #25282a -ms-linear-gradient(top, #191b1c, #323639);\n\
  background: #25282a linear-gradient(top, #191b1c, #323639);\n\
  background-color: #25282a;\n\
  -webkit-box-shadow: 0 0 0px 1px #323639 inset;\n\
  -moz-box-shadow: 0 0 0px 1px #323639 inset;\n\
  box-shadow: 0 0 0px 1px #323639 inset; }\n\
\n\
.ui-filemanager-plupload-file-success {\n\
  color: white;\n\
  border: 1px solid #628022;\n\
  text-shadow: #547213 0 1px 0px; }\n\
\n\
.ui-filemanager-plupload-file-success {\n\
  background: #8ebb2d url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzllY2YzNCIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzdlYTcyNyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #8ebb2d -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #9ecf34), color-stop(100%, #7ea727));\n\
  background: #8ebb2d -webkit-linear-gradient(top, #9ecf34, #7ea727);\n\
  background: #8ebb2d -moz-linear-gradient(top, #9ecf34, #7ea727);\n\
  background: #8ebb2d -o-linear-gradient(top, #9ecf34, #7ea727);\n\
  background: #8ebb2d -ms-linear-gradient(top, #9ecf34, #7ea727);\n\
  background: #8ebb2d linear-gradient(top, #9ecf34, #7ea727);\n\
  background-color: #8ebb2d;\n\
  -webkit-box-shadow: 0 0 0px 1px #9ecf34 inset;\n\
  -moz-box-shadow: 0 0 0px 1px #9ecf34 inset;\n\
  box-shadow: 0 0 0px 1px #9ecf34 inset; }\n\
\n\
.ui-filemanager-datatables-table .ui-state-highlight .sorting_1, .ui-filemanager-datatables-table .ui-state-highlight .xmod-datatable-sorting-1, .ui-filemanager-datatables-table tr:hover.ui-state-highlight td, .ui-filemanager-datatables-table tr:hover.ui-state-highlight .sorting_1, .ui-filemanager-datatables-table tr:hover.ui-state-highlight .xmod-datatable-sorting-1 {\n\
  color: #333333;\n\
  border: 1px solid #7fc4f3;\n\
  text-shadow: #eef8fe 0 1px 0px; }\n\
\n\
.ui-filemanager-datatables-table .ui-state-highlight .sorting_1, .ui-filemanager-datatables-table .ui-state-highlight .xmod-datatable-sorting-1 {\n\
  background: #bfe2fa url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2Q4ZWRmYyIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2E2ZDdmOSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #bfe2fa -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #d8edfc), color-stop(100%, #a6d7f9));\n\
  background: #bfe2fa -webkit-linear-gradient(top, #d8edfc, #a6d7f9);\n\
  background: #bfe2fa -moz-linear-gradient(top, #d8edfc, #a6d7f9);\n\
  background: #bfe2fa -o-linear-gradient(top, #d8edfc, #a6d7f9);\n\
  background: #bfe2fa -ms-linear-gradient(top, #d8edfc, #a6d7f9);\n\
  background: #bfe2fa linear-gradient(top, #d8edfc, #a6d7f9);\n\
  background-color: #bfe2fa;\n\
  -webkit-box-shadow: 0 0 0px 1px #d8edfc inset;\n\
  -moz-box-shadow: 0 0 0px 1px #d8edfc inset;\n\
  box-shadow: 0 0 0px 1px #d8edfc inset; }\n\
\n\
.ui-filemanager-datatables-table tr:hover.ui-state-highlight td, .ui-filemanager-datatables-table tr:hover.ui-state-highlight .sorting_1, .ui-filemanager-datatables-table tr:hover.ui-state-highlight .xmod-datatable-sorting-1 {\n\
  background: #bfe2fa url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2E2ZDdmOSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2Q4ZWRmYyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #bfe2fa -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #a6d7f9), color-stop(100%, #d8edfc));\n\
  background: #bfe2fa -webkit-linear-gradient(top, #a6d7f9, #d8edfc);\n\
  background: #bfe2fa -moz-linear-gradient(top, #a6d7f9, #d8edfc);\n\
  background: #bfe2fa -o-linear-gradient(top, #a6d7f9, #d8edfc);\n\
  background: #bfe2fa -ms-linear-gradient(top, #a6d7f9, #d8edfc);\n\
  background: #bfe2fa linear-gradient(top, #a6d7f9, #d8edfc);\n\
  background-color: #bfe2fa;\n\
  -webkit-box-shadow: 0 0 0px 1px #d8edfc inset;\n\
  -moz-box-shadow: 0 0 0px 1px #d8edfc inset;\n\
  box-shadow: 0 0 0px 1px #d8edfc inset; }\n\
\n\
.ui-filemanager-plupload-upload-total-progress span, .ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-plupload-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-tagsidebar-tag-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-datatables-table .ui-toolbar .ui-button:not(.ui-state-disabled):hover {\n\
  color: white;\n\
  border: 1px solid #e07900;\n\
  text-shadow: rgba(0, 0, 0, 0.25) 0 1px 0px; }\n\
\n\
.ui-filemanager-plupload-upload-total-progress span {\n\
  background: #ff9c28 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmYTg0MyIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2ZmOTAwZCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #ff9c28 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #ffa843), color-stop(100%, #ff900d));\n\
  background: #ff9c28 -webkit-linear-gradient(top, #ffa843, #ff900d);\n\
  background: #ff9c28 -moz-linear-gradient(top, #ffa843, #ff900d);\n\
  background: #ff9c28 -o-linear-gradient(top, #ffa843, #ff900d);\n\
  background: #ff9c28 -ms-linear-gradient(top, #ffa843, #ff900d);\n\
  background: #ff9c28 linear-gradient(top, #ffa843, #ff900d);\n\
  background-color: #ff9c28;\n\
  -webkit-box-shadow: 0 0 0px 1px #ffa843 inset;\n\
  -moz-box-shadow: 0 0 0px 1px #ffa843 inset;\n\
  box-shadow: 0 0 0px 1px #ffa843 inset; }\n\
\n\
.ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-plupload-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-tagsidebar-tag-controls .ui-button:not(.ui-state-disabled):hover, .ui-filemanager-datatables-table .ui-toolbar .ui-button:not(.ui-state-disabled):hover {\n\
  background: #ff9c28 url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmOTAwZCIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2ZmYTg0MyIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #ff9c28 -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #ff900d), color-stop(100%, #ffa843));\n\
  background: #ff9c28 -webkit-linear-gradient(top, #ff900d, #ffa843);\n\
  background: #ff9c28 -moz-linear-gradient(top, #ff900d, #ffa843);\n\
  background: #ff9c28 -o-linear-gradient(top, #ff900d, #ffa843);\n\
  background: #ff9c28 -ms-linear-gradient(top, #ff900d, #ffa843);\n\
  background: #ff9c28 linear-gradient(top, #ff900d, #ffa843);\n\
  background-color: #ff9c28;\n\
  -webkit-box-shadow: 0 0 0px 1px #ffa843 inset;\n\
  -moz-box-shadow: 0 0 0px 1px #ffa843 inset;\n\
  box-shadow: 0 0 0px 1px #ffa843 inset; }\n\
\n\
.ui-filemanager-datatables-table .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-tagsidebar-file-types-wrapper .ui-button, .ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset .ui-button {\n\
  -webkit-border-radius: 0;\n\
  -moz-border-radius: 0;\n\
  -ms-border-radius: 0;\n\
  -o-border-radius: 0;\n\
  border-radius: 0; }\n\
\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-drop-zone,\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-uploading {\n\
  -webkit-border-radius: 4px;\n\
  -moz-border-radius: 4px;\n\
  -ms-border-radius: 4px;\n\
  -o-border-radius: 4px;\n\
  border-radius: 4px; }\n\
\n\
/* Filemanager specific extensions */\n\
.ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-plupload-controls .ui-button, .ui-filemanager-tagsidebar-tag-controls .ui-button, .ui-filemanager-datatables-table .ui-toolbar .ui-button {\n\
  color: #93999f; }\n\
\n\
.ui-filemanager-datatables-table + .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-plupload-controls .ui-button, .ui-filemanager-tagsidebar-file-types-wrapper .ui-button, .ui-filemanager-tagsidebar-tag-controls .ui-button {\n\
  font-size: 13px;\n\
  line-height: 1.2;\n\
  text-transform: uppercase; }\n\
\n\
.ui-filemanager-datatables-table .ui-filemanager-datatables-controls .ui-button, .ui-filemanager-datatables-select-all {\n\
  width: 30px;\n\
  height: 30px; }\n\
\n\
.ui-filemanager-datatables-table .ui-toolbar .dataTables_length select,\n\
.ui-filemanager-datatables-table .ui-toolbar .dataTables_filter input, .ui-filemanager-tagsidebar-create-tag-dialog input, .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-length select,\n\
.ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-filter input {\n\
  -webkit-appearance: none;\n\
  -moz-appearance: none;\n\
  -ms-appearance: none;\n\
  -o-appearance: none;\n\
  appearance: none;\n\
  border: 1px solid #161617 !important;\n\
  opacity: 0.75;\n\
  -webkit-transition: opacity 0.5s linear, border-color 0.5s ease-in;\n\
  -moz-transition: opacity 0.5s linear, border-color 0.5s ease-in;\n\
  -ms-transition: opacity 0.5s linear, border-color 0.5s ease-in;\n\
  -o-transition: opacity 0.5s linear, border-color 0.5s ease-in;\n\
  transition: opacity 0.5s linear, border-color 0.5s ease-in;\n\
  text-shadow: white 0 1px 0px;\n\
  box-sizing: content-box;\n\
  display: inline;\n\
  height: 18px;\n\
  padding: 6px;\n\
  -webkit-border-radius: 4px;\n\
  -moz-border-radius: 4px;\n\
  -ms-border-radius: 4px;\n\
  -o-border-radius: 4px;\n\
  border-radius: 4px; }\n\
  .ui-filemanager-datatables-table .ui-toolbar .dataTables_length select:hover,\n\
  .ui-filemanager-datatables-table .ui-toolbar .dataTables_filter input:hover, .ui-filemanager-tagsidebar-create-tag-dialog input:hover, .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-length select:hover,\n\
  .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-filter input:hover, .ui-filemanager-datatables-table .ui-toolbar .dataTables_length select:focus,\n\
  .ui-filemanager-datatables-table .ui-toolbar .dataTables_filter input:focus, .ui-filemanager-tagsidebar-create-tag-dialog input:focus, .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-length select:focus,\n\
  .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-filter input:focus {\n\
    opacity: 1; }\n\
  .ui-filemanager-datatables-table .ui-toolbar .dataTables_length select:hover,\n\
  .ui-filemanager-datatables-table .ui-toolbar .dataTables_filter input:hover, .ui-filemanager-tagsidebar-create-tag-dialog input:hover, .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-length select:hover,\n\
  .ui-filemanager-datatables-table .ui-toolbar .xmod-datatable-filter input:hover {\n\
    border: 1px solid #e07900 !important; }\n\
\n\
.ui-filemanager-datatables, .ui-filemanager-plupload-container, .ui-filemanager-panels-wrap .ui-filemanager-tagsidebar {\n\
  padding: 16px;\n\
  border-left: 1px solid lightgrey;\n\
  border-bottom: 1px solid lightgrey;\n\
  -webkit-box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.85) inset;\n\
  -moz-box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.85) inset;\n\
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.85) inset; }\n\
\n\
.ui-filemanager-datatables-table .ui-toolbar .dataTables_paginate span .ui-state-disabled, .ui-filemanager-datatables-table .xmod-datatable-paginate span .ui-state-disabled {\n\
  color: white;\n\
  border: 1px solid #161617;\n\
  text-shadow: #323334 0 1px 0px;\n\
  background: #363a3d url(\'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUwJSIgeTE9IjAlIiB4Mj0iNTAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iIzJhMmQyZiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzQzNDc0YiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\');\n\
  background: #363a3d -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #2a2d2f), color-stop(100%, #43474b));\n\
  background: #363a3d -webkit-linear-gradient(top, #2a2d2f, #43474b);\n\
  background: #363a3d -moz-linear-gradient(top, #2a2d2f, #43474b);\n\
  background: #363a3d -o-linear-gradient(top, #2a2d2f, #43474b);\n\
  background: #363a3d -ms-linear-gradient(top, #2a2d2f, #43474b);\n\
  background: #363a3d linear-gradient(top, #2a2d2f, #43474b);\n\
  background-color: #363a3d;\n\
  -webkit-box-shadow: 0 0 0px 1px #43474b inset;\n\
  -moz-box-shadow: 0 0 0px 1px #43474b inset;\n\
  box-shadow: 0 0 0px 1px #43474b inset;\n\
  opacity: 1; }\n\
\n\
.ui-filemanager-datatables-table .dataTable, .ui-filemanager-datatables-table .xmod-datatable {\n\
  width: 100%;\n\
  -webkit-box-sizing: border-box;\n\
  -moz-box-sizing: border-box;\n\
  box-sizing: border-box;\n\
  border-spacing: 1px 8px;\n\
  border-collapse: separate;\n\
  padding: 0 7px; }\n\
  .ui-filemanager-datatables-table .dataTable + .fg-toolbar, .ui-filemanager-datatables-table .xmod-datatable + .fg-toolbar {\n\
    margin-top: -8px; }\n\
\n\
/* Base style */\n\
/******************************************************************************\\n\
 * Filemanager\n\
\******************************************************************************/\n\
.ui-button-icon-only .ui-button-text {\n\
  display: none;\n\
  color: red; }\n\
\n\
.ui-draggable {\n\
  position: absolute; }\n\
\n\
/******************************************************************************\\n\
 * Panels\n\
\******************************************************************************/\n\
.ui-filemanager-panels-wrap,\n\
.ui-filemanager-panel-left,\n\
.ui-filemanager-panel-center-wrap {\n\
  display: -webkit-box;\n\
  display: -moz-box;\n\
  display: -ms-box;\n\
  display: box; }\n\
\n\
.ui-tabs-nav:empty {\n\
  display: none; }\n\
\n\
.ui-filemanager-panels-wrap {\n\
  -webkit-box-flex: 2;\n\
  -moz-box-flex: 2;\n\
  -ms-box-flex: 2;\n\
  box-flex: 2; }\n\
\n\
.ui-filemanager-dialog .ui-dialog-content {\n\
  display: -webkit-box;\n\
  display: -moz-box;\n\
  display: -ms-box;\n\
  display: box; }\n\
\n\
.ui-filemanager-panel-left,\n\
.ui-filemanager-panel-right,\n\
.ui-filemanager-panel-bottom,\n\
.ui-filemanager-panel-top {\n\
  display: -webkit-box;\n\
  display: -moz-box;\n\
  display: -ms-box;\n\
  display: box;\n\
  -webkit-box-flex: 1;\n\
  -moz-box-flex: 1;\n\
  -ms-box-flex: 1;\n\
  box-flex: 1; }\n\
\n\
.ui-filemanager-panel-left,\n\
.ui-filemanager-panel-right {\n\
  -webkit-box-orient: vertical;\n\
  -moz-box-orient: vertical;\n\
  -ms-box-orient: vertical;\n\
  box-orient: vertical; }\n\
\n\
.ui-filemanager-panel-top,\n\
.ui-filemanager-panel-bottom,\n\
.ui-filemanager-panel-center-wrap {\n\
  -webkit-box-orient: vertical;\n\
  -moz-box-orient: vertical;\n\
  -ms-box-orient: vertical;\n\
  box-orient: vertical; }\n\
\n\
.ui-filemanager-panel-top .ui-tabs-panel,\n\
.ui-filemanager-panel-bottom .ui-tabs-panel,\n\
.ui-filemanager-panel-left .ui-tabs-panel,\n\
.ui-filemanager-panel-center-wrap .ui-tabs-panel {\n\
  display: -webkit-box;\n\
  display: -moz-box;\n\
  display: -ms-box;\n\
  display: box;\n\
  -webkit-box-flex: 1;\n\
  -moz-box-flex: 1;\n\
  -ms-box-flex: 1;\n\
  box-flex: 1;\n\
  -webkit-box-orient: vertical;\n\
  -moz-box-orient: vertical;\n\
  -ms-box-orient: vertical;\n\
  box-orient: vertical;\n\
  -webkit-box-align: stretch;\n\
  -moz-box-align: stretch;\n\
  -ms-box-align: stretch;\n\
  box-align: stretch; }\n\
\n\
.ui-filemanager-panel-center-wrap {\n\
  -webkit-box-flex: 2;\n\
  -moz-box-flex: 2;\n\
  -ms-box-flex: 2;\n\
  box-flex: 2; }\n\
\n\
.ui-filemanager-datatables-preview-information {\n\
  -webkit-column-count: 2;\n\
  -moz-column-count: 2;\n\
  -ms-column-count: 2;\n\
  column-count: 2; }\n\
  .ui-filemanager-datatables-preview-information dt {\n\
    font-weight: bold; }\n\
\n\
.ui-filemanager-datatables .xmod-datatable-info,\n\
.ui-filemanager-datatables .xmod-datatable-length {\n\
  float: left; }\n\
.ui-filemanager-datatables .xmod-datatable-filter,\n\
.ui-filemanager-datatables .xmod-datatable-paginate {\n\
  float: right; }\n\
.ui-filemanager-datatables .xmod-datatable-paginate > a, .ui-filemanager-datatables .xmod-datatable-paginate > span {\n\
  display: inline-block;\n\
  float: none; }\n\
.ui-filemanager-datatables .xmod-datatable-sort-wrapper {\n\
  position: relative; }\n\
  .ui-filemanager-datatables .xmod-datatable-sort-wrapper .ui-icon {\n\
    position: absolute;\n\
    right: -4px;\n\
    top: 50%;\n\
    margin-top: -8px; }\n\
\n\
/******************************************************************************\\n\
 * Filemanager style\n\
\******************************************************************************/\n\
.ui-filemanager-panels-wrap {\n\
  min-width: 450px;\n\
  border-left: 0 none;\n\
  border-bottom: 0 none; }\n\
\n\
.ui-filemanager-wrapper {\n\
  min-width: 450px; }\n\
\n\
.ui-filemanager-panel-empty {\n\
  display: none; }\n\
\n\
.ui-filemanager-tabs-single .ui-tabs-panel {\n\
  background: none transparent;\n\
  border-right: 0 none;\n\
  border-top: 0 none; }\n\
\n\
.ui-filemanager-title {\n\
  color: #777;\n\
  text-transform: uppercase;\n\
  font-weight: bold;\n\
  font-size: 14.3px;\n\
  padding-top: 0;\n\
  margin-bottom: 12px; }\n\
\n\
/******************************************************************************\\n\
 * Dialogs\n\
\******************************************************************************/\n\
.ui-filemanager-wrapper .ui-dialog-content {\n\
  font-size: 12px; }\n\
\n\
/* Components */\n\
/* Layout */\n\
.ui-editor-unsupported {\n\
  position: relative; }\n\
\n\
.ui-editor-unsupported-overlay {\n\
  position: fixed;\n\
  top: 0;\n\
  left: 0;\n\
  bottom: 0;\n\
  right: 0;\n\
  background-color: black;\n\
  filter: alpha(opacity=50);\n\
  opacity: 0.5; }\n\
\n\
.ui-editor-unsupported-content {\n\
  position: fixed;\n\
  top: 50%;\n\
  left: 50%;\n\
  margin: -200px 0 0 -300px;\n\
  width: 600px;\n\
  height: 400px; }\n\
\n\
.ui-editor-unsupported-input {\n\
  position: absolute;\n\
  bottom: 10px; }\n\
\n\
/* Style */\n\
.ui-editor-unsupported-content {\n\
  padding: 10px;\n\
  background-color: white;\n\
  border: 1px solid #777777; }\n\
\n\
/* Plugins */\n\
/* Datatables header */\n\
.ui-filemanager-datatables-selection-notification {\n\
  display: none;\n\
  margin-top: 0;\n\
  margin-bottom: 0;\n\
  clear: both;\n\
  position: relative;\n\
  overflow: hidden; }\n\
  .ui-filemanager-datatables-selection-notification .ui-icon {\n\
    top: 20px; }\n\
  .ui-filemanager-datatables-selection-notification .ui-notification {\n\
    margin: 10px 0 0; }\n\
\n\
.ui-filemanager-datatables-selection-button {\n\
  float: left;\n\
  margin-right: 10px;\n\
  height: 30px;\n\
  overflow: hidden; }\n\
\n\
/* Table */\n\
.ui-filemanager-datatables table {\n\
  margin-bottom: -1px; }\n\
\n\
.ui-filemanager-datatables-header-controls label, .dataTables_info {\n\
  color: #93999f; }\n\
\n\
/* Row styling */\n\
.ui-filemanager-datatables-table {\n\
  font-family: "Adelle", Verdana, sans-serif;\n\
  margin-bottom: 8px; }\n\
  .ui-filemanager-datatables-table td img {\n\
    border: 1px solid rgba(255, 255, 255, 0.85);\n\
    margin: 0 auto;\n\
    -webkit-box-shadow: 0 0 8px #b4b4b4;\n\
    -moz-box-shadow: 0 0 8px #b4b4b4;\n\
    box-shadow: 0 0 8px #b4b4b4; }\n\
  .ui-filemanager-datatables-table .ui-notification {\n\
    margin-bottom: 0; }\n\
  .ui-filemanager-datatables-table .ui-state-highlight td, .ui-filemanager-datatables-table .ui-state-highlight .sorting_1 {\n\
    -webkit-box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important;\n\
    -moz-box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important;\n\
    box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important; }\n\
  .ui-filemanager-datatables-table td, .ui-filemanager-datatables-table th {\n\
    cursor: pointer;\n\
    vertical-align: middle;\n\
    padding: 5px 8px 4px;\n\
    border: 0 none !important; }\n\
  .ui-filemanager-datatables-table th.ui-state-default {\n\
    color: #93999f !important;\n\
    text-shadow: 0 0 0px #323334 !important;\n\
    background: none;\n\
    -webkit-box-shadow: none;\n\
    -moz-box-shadow: none;\n\
    box-shadow: none;\n\
    padding-bottom: 0;\n\
    font-size: 14.3px; }\n\
    .ui-filemanager-datatables-table th.ui-state-default:hover {\n\
      color: #fff!important; }\n\
  .ui-filemanager-datatables-table .xmod-datatable-sorting-1, .ui-filemanager-datatables-table .sorting_1 {\n\
    border: 0 none; }\n\
  .ui-filemanager-datatables-table .ui-toolbar {\n\
    margin-bottom: -1px;\n\
    border-bottom: 1px solid #161617 !important;\n\
    padding: 8px; }\n\
    .ui-filemanager-datatables-table .ui-toolbar .ui-buttonset {\n\
      margin-right: 0; }\n\
    .ui-filemanager-datatables-table .ui-toolbar .dataTables_length, .ui-filemanager-datatables-table .ui-toolbar .dataTables_info {\n\
      display: block;\n\
      float: left;\n\
      margin-right: 20px; }\n\
    .ui-filemanager-datatables-table .ui-toolbar .dataTables_filter, .ui-filemanager-datatables-table .ui-toolbar .dataTables_paginate {\n\
      float: right; }\n\
    .ui-filemanager-datatables-table .ui-toolbar .dataTables_paginate .ui-button {\n\
      padding: 4px 8px;\n\
      margin-right: -1px; }\n\
  .ui-filemanager-datatables-table .ui-state-disabled {\n\
    pointer-events: none;\n\
    cursor: default; }\n\
  .ui-filemanager-datatables-table .ui-filemanager-datatables-controls {\n\
    height: 30px; }\n\
    .ui-filemanager-datatables-table .ui-filemanager-datatables-controls .ui-button:first-child {\n\
      -moz-border-radius-topleft: 4px;\n\
      -webkit-border-top-left-radius: 4px;\n\
      border-top-left-radius: 4px;\n\
      -moz-border-radius-bottomleft: 4px;\n\
      -webkit-border-bottom-left-radius: 4px;\n\
      border-bottom-left-radius: 4px; }\n\
    .ui-filemanager-datatables-table .ui-filemanager-datatables-controls .ui-button:last-child {\n\
      margin-left: -4px!important;\n\
      -moz-border-radius-topright: 4px;\n\
      -webkit-border-top-right-radius: 4px;\n\
      border-top-right-radius: 4px;\n\
      -moz-border-radius-bottomright: 4px;\n\
      -webkit-border-bottom-right-radius: 4px;\n\
      border-bottom-right-radius: 4px; }\n\
\n\
.ui-filemanager-datatables-controls {\n\
  white-space: nowrap;\n\
  height: 37px;\n\
  overflow: hidden;\n\
  padding-left: 1px;\n\
  margin-left: -1px; }\n\
  .ui-filemanager-datatables-controls .ui-button.ui-state-default {\n\
    margin: 0; }\n\
  .ui-filemanager-datatables-controls .ui-button.ui-state-default:not(:first-child) {\n\
    margin-left: -1px; }\n\
  .ui-filemanager-datatables-controls .ui-button.ui-state-default:hover {\n\
    z-index: 10000; }\n\
\n\
.ui-filemanager-datatables-insert {\n\
  display: none; }\n\
\n\
/* Tag Menu */\n\
.ui-filemanager-datatables-tag-menu {\n\
  z-index: 10000;\n\
  padding: 0; }\n\
  .ui-filemanager-datatables-tag-menu li {\n\
    padding: 0; }\n\
  .ui-filemanager-datatables-tag-menu .ui-buttonset {\n\
    margin: 0!important; }\n\
    .ui-filemanager-datatables-tag-menu .ui-buttonset .ui-button {\n\
      height: 32px;\n\
      float: left; }\n\
      .ui-filemanager-datatables-tag-menu .ui-buttonset .ui-button:last-child {\n\
        margin-right: 0!important; }\n\
\n\
.ui-filemanager-datatables-table .ui-state-highlight .xmod-datatable-sorting-1 {\n\
  -webkit-box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important;\n\
  -moz-box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important;\n\
  box-shadow: 0 0 0px 1px #eef8fe inset, 0 0 0 1px black !important; }\n\
.ui-filemanager-datatables-table .xmod-datatable-sorting-1 {\n\
  border: 0 none; }\n\
.ui-filemanager-datatables-table .xmod-datatable-paginate .ui-button {\n\
  padding: 6px 8px;\n\
  margin-right: -1px; }\n\
\n\
.xmod-datatable-info {\n\
  color: #93999f; }\n\
\n\
/******************************************************************************\\n\
 * Plupload overrides\n\
\******************************************************************************/\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-drop-zone,\n\
.ui-filemanager-plupload-container .ui-filemanager-plupload-uploading {\n\
  font-size: 24px;\n\
  height: 50px;\n\
  line-height: 50px;\n\
  text-align: center;\n\
  color: #93999f;\n\
  margin-bottom: 8px;\n\
  text-transform: uppercase;\n\
  text-shadow: 0 0 #323334; }\n\
\n\
.ui-filemanager-plupload-uploading {\n\
  display: none;\n\
  position: relative; }\n\
  .ui-filemanager-plupload-uploading .ui-filemanager-plupload-upload-message,\n\
  .ui-filemanager-plupload-uploading .ui-filemanager-plupload-upload-total-progress {\n\
    position: absolute;\n\
    top: 0px;\n\
    left: 0px;\n\
    width: 100%;\n\
    display: -webkit-box;\n\
    display: -moz-box;\n\
    display: -ms-box;\n\
    display: box; }\n\
  .ui-filemanager-plupload-uploading .ui-filemanager-plupload-upload-message {\n\
    z-index: 10;\n\
    background-color: transparent;\n\
    text-align: center;\n\
    display: block;\n\
    color: white; }\n\
  .ui-filemanager-plupload-uploading .ui-filemanager-plupload-upload-total-progress {\n\
    z-index: 5;\n\
    height: 100%; }\n\
    .ui-filemanager-plupload-uploading .ui-filemanager-plupload-upload-total-progress span {\n\
      position: absolute;\n\
      display: -webkit-box;\n\
      display: -moz-box;\n\
      display: -ms-box;\n\
      display: box;\n\
      width: 0%;\n\
      height: 100%;\n\
      background-color: red; }\n\
\n\
.ui-filemanager-plupload-file-error {\n\
  display: none; }\n\
\n\
.plupload.html5:hover, .plupload:hover {\n\
  cursor: pointer!important; }\n\
\n\
.ui-filemanager-plupload-file-list {\n\
  padding-bottom: 8px; }\n\
\n\
.ui-filemanager-plupload-file-list-item {\n\
  margin-bottom: -1px;\n\
  overflow: auto;\n\
  padding: 4px; }\n\
  .ui-filemanager-plupload-file-list-item .ui-filemanager-plupload-file-remove {\n\
    float: right; }\n\
  .ui-filemanager-plupload-file-list-item .ui-filemanager-plupload-file-name {\n\
    display: inline-block;\n\
    padding: 5px; }\n\
\n\
.ui-filemanager-plupload-upload-total-progress span {\n\
  margin: -1px; }\n\
\n\
.ui-filemanager-panels-wrap .ui-filemanager-tagsidebar {\n\
  -webkit-box-flex: 1;\n\
  -moz-box-flex: 1;\n\
  -ms-box-flex: 1;\n\
  box-flex: 1; }\n\
\n\
.ui-filemanager-tagsidebar {\n\
  max-width: 280px; }\n\
  .ui-filemanager-tagsidebar .ui-filemanager-tagsidebar-tag-controls {\n\
    margin-bottom: 16px; }\n\
  .ui-filemanager-panels-wrap .ui-filemanager-tagsidebar {\n\
    z-index: 100; }\n\
\n\
.ui-filemanager-tagsidebar-title {\n\
  padding: 5px 0 0 10px;\n\
  border-left: 0 none;\n\
  border-right: 0 none;\n\
  border-top: 0 none; }\n\
\n\
.ui-filemanager-tagsidebar-file-types-wrapper.ui-buttonset {\n\
  margin: -4px 0 16px; }\n\
\n\
.ui-filemanager-tagsidebar-file-types-wrapper {\n\
  margin-bottom: 16px; }\n\
  .ui-filemanager-tagsidebar-file-types-wrapper .ui-button {\n\
    display: block;\n\
    float: none;\n\
    margin-right: 0;\n\
    text-align: left;\n\
    position: relative;\n\
    z-index: 0;\n\
    margin-bottom: -1px; }\n\
    .ui-filemanager-tagsidebar-file-types-wrapper .ui-button.ui-state-active, .ui-filemanager-tagsidebar-file-types-wrapper .ui-button:hover {\n\
      z-index: 10; }\n\
    .ui-filemanager-tagsidebar-file-types-wrapper .ui-button:first-of-type {\n\
      -moz-border-radius-topleft: 4px;\n\
      -webkit-border-top-left-radius: 4px;\n\
      border-top-left-radius: 4px;\n\
      -moz-border-radius-topright: 4px;\n\
      -webkit-border-top-right-radius: 4px;\n\
      border-top-right-radius: 4px; }\n\
    .ui-filemanager-tagsidebar-file-types-wrapper .ui-button:last-child {\n\
      -moz-border-radius-topleft: 0;\n\
      -webkit-border-top-left-radius: 0;\n\
      border-top-left-radius: 0;\n\
      -moz-border-radius-topright: 0;\n\
      -webkit-border-top-right-radius: 0;\n\
      border-top-right-radius: 0;\n\
      -moz-border-radius-bottomleft: 4px;\n\
      -webkit-border-bottom-left-radius: 4px;\n\
      border-bottom-left-radius: 4px;\n\
      -moz-border-radius-bottomright: 4px;\n\
      -webkit-border-bottom-right-radius: 4px;\n\
      border-bottom-right-radius: 4px; }\n\
    .ui-filemanager-tagsidebar-file-types-wrapper .ui-button .ui-button-text {\n\
      padding-left: 16px !important; }\n\
\n\
/* Tag controls */\n\
.ui-filemanager-tagsidebar-tag-controls .ui-button {\n\
  margin: 0; }\n\
\n\
/* Tag buttons */\n\
.ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset {\n\
  margin: 0 8px 8px 0;\n\
  position: relative; }\n\
  .ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset.ui-draggable-dragging {\n\
    z-index: 1; }\n\
  .ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset .ui-button {\n\
    float: left; }\n\
    .ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset .ui-button:first-child {\n\
      -moz-border-radius-topleft: 4px;\n\
      -webkit-border-top-left-radius: 4px;\n\
      border-top-left-radius: 4px;\n\
      -moz-border-radius-bottomleft: 4px;\n\
      -webkit-border-bottom-left-radius: 4px;\n\
      border-bottom-left-radius: 4px; }\n\
    .ui-filemanager-tagsidebar-tags-wrapper .ui-buttonset .ui-button:last-child {\n\
      -moz-border-radius-topright: 4px;\n\
      -webkit-border-top-right-radius: 4px;\n\
      border-top-right-radius: 4px;\n\
      -moz-border-radius-bottomright: 4px;\n\
      -webkit-border-bottom-right-radius: 4px;\n\
      border-bottom-right-radius: 4px;\n\
      margin-right: 0!important; }\n\
\n\
.ui-filemanager-tagsidebar-option-menu {\n\
  z-index: 10000;\n\
  padding: 0;\n\
  margin-top: -1px; }\n\
</style>').appendTo('head');